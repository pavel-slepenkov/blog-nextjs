<!DOCTYPE html><html><head><meta charSet="utf-8"/><link rel="icon" href="/favicon.ico"/><link href="https://unpkg.com/prismjs@1.23.0/themes/prism-okaidia.css" rel="stylesheet"/><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="description" content="Pavel Slepenkov&#x27;s personal blog: stories about BI, python, salesforce and data analysis"/><meta http-equiv="cache-control" content="Private"/><meta http-equiv="Expires" content="366000"/><meta property="og:locale" content="en_US"/><meta name="og:title" content="Pavel Slepenkov&#x27;s personal blog"/><meta property="og:description" content="stories about BI, python, salesforce and data analysis"/><meta property="og:type" content="article"/><meta property="og:site_name" content="pavelslepenkov.info"/><meta property="og:image" content="/og.png"/><meta name="twitter:title" content="Pavel Slepenkov&#x27;s personal blog"/><meta name="twitter:description" content="stories about BI, python, salesforce and data analysis"/><meta name="twitter:card" content="summary_large_image"/><meta property="twitter:image" content="/og.png"/><meta name="keywords" content="python, BI, sql, salesforce, data engineering, apex, soql, data analisys"/><meta name="yandex-verification" content="35a3887ea995a4c4"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-63037633-1"></script><script>
                            window.dataLayer = window.dataLayer || [];
                            function gtag(){dataLayer.push(arguments);}
                            gtag('js', new Date());
                            gtag('config', 'UA-63037633-1');
                    </script><style>@import url(&#x27;https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300&amp;family=Spectral:wght@300;600&amp;display=swap&#x27;);</style><title>Ansible: Permission denied (publickey) and TeamCity</title><meta name="next-head-count" content="24"/><link rel="preload" href="/_next/static/css/e1ade21c945e1e76c25a.css" as="style"/><link rel="stylesheet" href="/_next/static/css/e1ade21c945e1e76c25a.css" data-n-g=""/><link rel="preload" href="/_next/static/css/6dce80f39b6e217927f5.css" as="style"/><link rel="stylesheet" href="/_next/static/css/6dce80f39b6e217927f5.css" data-n-p=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-d99e70035f31fbf26280.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.ef157c678a62cfb2c073.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.0cd3f0b406132b99fef1.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-f576db2e6f64d3b421e3.js" as="script"/><link rel="preload" href="/_next/static/chunks/b435696c38dfa3a566dd7089f731d08d7e0bf097.f940d483b5a1fae10b21.js" as="script"/><link rel="preload" href="/_next/static/chunks/1d62a1056678c2f23610de94ff6f49e06a569636.b588272bed0c9114d503.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5Bid%5D-dd3e2b826f95ad4c71da.js" as="script"/></head><body><script src="noflash.js"></script><script src="PathSolver.js"></script><div id="__next"><div class="layout_container__2t4v2"><div class="no-print"><header class="layout_header__2rhWq"><div class="navbar-link"><a class="layout_devNull__6Fs9d" href="/">$ /dev/null</a>—————<a class="layout_devNull__6Fs9d" href="/cv">CV</a></div><div class="DarkModeToggle_darkModeToggle__2u4u3"><button type="button">☀</button><toggle></toggle><button type="button">☾</button></div></header></div><main><article><h1 class="utils_headingXl__1XecN">Ansible: Permission denied (publickey) and TeamCity</h1><div class="utils_lightText__12Ckm"><time dateTime="2021-02-02T00:30:33+00:00">February 2, 2021</time></div><div><p>In many deploy scenarios you need to clone/checkout sources from private repository to remote machine. While with Ansible it should be simple task you can face some nuances.</p>
<p>Cloning private repo requires checking your access rights to this repository and most common way to do this is to use ssh key which has access to the repo. In fact Ansible performs all operations on remote machine via ssh. It should be a piece of cake in this circumstances.</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">ansible-playbook -vvv -i inventory deploy.yml --vault-id ~/.my_vault
</code></pre></div>
<p>it works just fine before <a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/git_module.html">git clone task</a></p>
<div class="remark-highlight"><pre class="language-yml"><code class="language-yml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Pull sources from the repository
  <span class="token key atrule">become</span><span class="token punctuation">:</span> yes
  <span class="token key atrule">become_user</span><span class="token punctuation">:</span> <span class="token string">"{{ project.user }}"</span>
  <span class="token key atrule">git</span><span class="token punctuation">:</span> repo=<span class="token punctuation">{</span><span class="token punctuation">{</span> repo.url <span class="token punctuation">}</span><span class="token punctuation">}</span> dest=<span class="token punctuation">{</span><span class="token punctuation">{</span> project.path <span class="token punctuation">}</span><span class="token punctuation">}</span>/app/ version=<span class="token punctuation">{</span><span class="token punctuation">{</span> repo.branch <span class="token punctuation">}</span><span class="token punctuation">}</span> force=yes update=yes
</code></pre></div>
<p>and now I got</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash"><span class="token operator">&#x3C;</span>ec2-127-0-0-1.eu-0.compute.amazonaws.com<span class="token operator">></span> ESTABLISH SSH CONNECTION FOR <span class="token environment constant">USER</span><span class="token builtin class-name">:</span> pavel

<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>

fatal: <span class="token punctuation">[</span>ec2-127-0-0-1.eu-0.compute.amazonaws.com<span class="token punctuation">]</span>: FAILED<span class="token operator">!</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token string">"changed"</span><span class="token builtin class-name">:</span> false,
    <span class="token string">"cmd"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token string">"/usr/bin/git"</span>,
        <span class="token string">"fetch"</span>,
        <span class="token string">"--tags"</span>,
        <span class="token string">"--force"</span>,
        <span class="token string">"origin"</span>
    <span class="token punctuation">]</span>,
    <span class="token string">"invocation"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">"module_args"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">"accept_hostkey"</span><span class="token builtin class-name">:</span> true,
            <span class="token string">"archive"</span><span class="token builtin class-name">:</span> null,
            <span class="token string">"archive_prefix"</span><span class="token builtin class-name">:</span> null,
            <span class="token string">"bare"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"clone"</span><span class="token builtin class-name">:</span> true,
            <span class="token string">"depth"</span><span class="token builtin class-name">:</span> null,
            <span class="token string">"dest"</span><span class="token builtin class-name">:</span> <span class="token string">"/home/pavel/app/"</span>,
            <span class="token string">"executable"</span><span class="token builtin class-name">:</span> null,
            <span class="token string">"force"</span><span class="token builtin class-name">:</span> true,
            <span class="token string">"gpg_whitelist"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>,
            <span class="token string">"key_file"</span><span class="token builtin class-name">:</span> null,
            <span class="token string">"recursive"</span><span class="token builtin class-name">:</span> true,
            <span class="token string">"reference"</span><span class="token builtin class-name">:</span> null,
            <span class="token string">"refspec"</span><span class="token builtin class-name">:</span> null,
            <span class="token string">"remote"</span><span class="token builtin class-name">:</span> <span class="token string">"origin"</span>,
            <span class="token string">"repo"</span><span class="token builtin class-name">:</span> <span class="token string">"git@github.com:TargetProcess/pavel.git"</span>,
            <span class="token string">"separate_git_dir"</span><span class="token builtin class-name">:</span> null,
            <span class="token string">"ssh_opts"</span><span class="token builtin class-name">:</span> null,
            <span class="token string">"track_submodules"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"umask"</span><span class="token builtin class-name">:</span> null,
            <span class="token string">"update"</span><span class="token builtin class-name">:</span> true,
            <span class="token string">"verify_commit"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"version"</span><span class="token builtin class-name">:</span> <span class="token string">"my-cool-branch"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>,
    <span class="token string">"msg"</span><span class="token builtin class-name">:</span> <span class="token string">"Failed to download remote objects and refs:  git@github.com: Permission denied (publickey).</span>
<span class="token string">        fatal: Could not read from remote repository.</span>
<span class="token string">        Please make sure you have the correct access rights and the repository exists."</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>To fix this I suggest to use <strong>ssh forwarding</strong> and forward key from local machine to remote (Key should be added to private repo access list (for GitHub it's a deployment keys))</p>
<p>The first step is to <ps1>allow agent forwarding</ps1></p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash"><span class="token comment"># vi ~/.ssh/config</span>
Host *
    StrictHostKeyChecking no

Host ec2-127-0-0-1.eu-0.compute.amazonaws.com
IdentityFile /home/remote_machine_user/.ssh/id_rsa
User pavel
ForwardAgent <span class="token function">yes</span>
</code></pre></div>
<p>Next step is to <ps1>add your key to ssh agent</ps1></p>
<p>On ssh session you can do it with commands</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash"><span class="token builtin class-name">eval</span> <span class="token variable"><span class="token variable">`</span>ssh-agent -s<span class="token variable">`</span></span>
ssh-add ~/.ssh/id_rsa
</code></pre></div>
<p>But it won't work in TeamCity without some configuration via UI.</p>
<ol>
<li>Open project's administartion page and upload SSH Key which you want to add to ssh-agent on build time
<img src="/images/p1070/1.png" alt=""></li>
</ol>
<hr/>
<p><img src="/images/p1070/2.png" alt=""></p>
<ol start="2">
<li>Open Build Configuration settings and add <strong>Build Feature</strong> <ps1>SSH agent</ps1>
<img src="/images/p1070/3.png" alt=""></li>
</ol>
<p>After this build step git clone should work fine and you can start fixing next failed step 🤯🤬</p>
</div></article><div><span class="utils_tag__38-Vr"><a href="/tag/ansible">[<!-- -->ansible<!-- -->]</a></span><span class="utils_tag__38-Vr"><a href="/tag/deployment">[<!-- -->deployment<!-- -->]</a></span><span class="utils_tag__38-Vr"><a href="/tag/deployment-errors">[<!-- -->deployment errors<!-- -->]</a></span><span class="utils_tag__38-Vr"><a href="/tag/ansible-playbook">[<!-- -->ansible-playbook<!-- -->]</a></span><span class="utils_tag__38-Vr"><a href="/tag/git">[<!-- -->git<!-- -->]</a></span><span class="utils_tag__38-Vr"><a href="/tag/GitHub">[<!-- -->GitHub<!-- -->]</a></span></div></main><div class="layout_backToHome__1vZsp"><a href="/">⇐ back to home</a></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"ansible-permission-denied-publickey","contentHtml":"\u003cp\u003eIn many deploy scenarios you need to clone/checkout sources from private repository to remote machine. While with Ansible it should be simple task you can face some nuances.\u003c/p\u003e\n\u003cp\u003eCloning private repo requires checking your access rights to this repository and most common way to do this is to use ssh key which has access to the repo. In fact Ansible performs all operations on remote machine via ssh. It should be a piece of cake in this circumstances.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003eansible-playbook -vvv -i inventory deploy.yml --vault-id ~/.my_vault\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eit works just fine before \u003ca href=\"https://docs.ansible.com/ansible/latest/collections/ansible/builtin/git_module.html\"\u003egit clone task\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-yml\"\u003e\u003ccode class=\"language-yml\"\u003e\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e \u003cspan class=\"token key atrule\"\u003ename\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e Pull sources from the repository\n  \u003cspan class=\"token key atrule\"\u003ebecome\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e yes\n  \u003cspan class=\"token key atrule\"\u003ebecome_user\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"{{ project.user }}\"\u003c/span\u003e\n  \u003cspan class=\"token key atrule\"\u003egit\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e repo=\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e repo.url \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e dest=\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e project.path \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e/app/ version=\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e repo.branch \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e force=yes update=yes\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eand now I got\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003eec2-127-0-0-1.eu-0.compute.amazonaws.com\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e ESTABLISH SSH CONNECTION FOR \u003cspan class=\"token environment constant\"\u003eUSER\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e pavel\n\n\u003cspan class=\"token punctuation\"\u003e..\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e..\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e..\u003c/span\u003e\n\nfatal: \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eec2-127-0-0-1.eu-0.compute.amazonaws.com\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e: FAILED\u003cspan class=\"token operator\"\u003e!\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e\"changed\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e false,\n    \u003cspan class=\"token string\"\u003e\"cmd\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n        \u003cspan class=\"token string\"\u003e\"/usr/bin/git\"\u003c/span\u003e,\n        \u003cspan class=\"token string\"\u003e\"fetch\"\u003c/span\u003e,\n        \u003cspan class=\"token string\"\u003e\"--tags\"\u003c/span\u003e,\n        \u003cspan class=\"token string\"\u003e\"--force\"\u003c/span\u003e,\n        \u003cspan class=\"token string\"\u003e\"origin\"\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e,\n    \u003cspan class=\"token string\"\u003e\"invocation\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token string\"\u003e\"module_args\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token string\"\u003e\"accept_hostkey\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e true,\n            \u003cspan class=\"token string\"\u003e\"archive\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e null,\n            \u003cspan class=\"token string\"\u003e\"archive_prefix\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e null,\n            \u003cspan class=\"token string\"\u003e\"bare\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e false,\n            \u003cspan class=\"token string\"\u003e\"clone\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e true,\n            \u003cspan class=\"token string\"\u003e\"depth\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e null,\n            \u003cspan class=\"token string\"\u003e\"dest\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"/home/pavel/app/\"\u003c/span\u003e,\n            \u003cspan class=\"token string\"\u003e\"executable\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e null,\n            \u003cspan class=\"token string\"\u003e\"force\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e true,\n            \u003cspan class=\"token string\"\u003e\"gpg_whitelist\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e,\n            \u003cspan class=\"token string\"\u003e\"key_file\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e null,\n            \u003cspan class=\"token string\"\u003e\"recursive\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e true,\n            \u003cspan class=\"token string\"\u003e\"reference\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e null,\n            \u003cspan class=\"token string\"\u003e\"refspec\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e null,\n            \u003cspan class=\"token string\"\u003e\"remote\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"origin\"\u003c/span\u003e,\n            \u003cspan class=\"token string\"\u003e\"repo\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"git@github.com:TargetProcess/pavel.git\"\u003c/span\u003e,\n            \u003cspan class=\"token string\"\u003e\"separate_git_dir\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e null,\n            \u003cspan class=\"token string\"\u003e\"ssh_opts\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e null,\n            \u003cspan class=\"token string\"\u003e\"track_submodules\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e false,\n            \u003cspan class=\"token string\"\u003e\"umask\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e null,\n            \u003cspan class=\"token string\"\u003e\"update\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e true,\n            \u003cspan class=\"token string\"\u003e\"verify_commit\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e false,\n            \u003cspan class=\"token string\"\u003e\"version\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"my-cool-branch\"\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e,\n    \u003cspan class=\"token string\"\u003e\"msg\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Failed to download remote objects and refs:  git@github.com: Permission denied (publickey).\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e        fatal: Could not read from remote repository.\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e        Please make sure you have the correct access rights and the repository exists.\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eTo fix this I suggest to use \u003cstrong\u003essh forwarding\u003c/strong\u003e and forward key from local machine to remote (Key should be added to private repo access list (for GitHub it's a deployment keys))\u003c/p\u003e\n\u003cp\u003eThe first step is to \u003cps1\u003eallow agent forwarding\u003c/ps1\u003e\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"token comment\"\u003e# vi ~/.ssh/config\u003c/span\u003e\nHost *\n    StrictHostKeyChecking no\n\nHost ec2-127-0-0-1.eu-0.compute.amazonaws.com\nIdentityFile /home/remote_machine_user/.ssh/id_rsa\nUser pavel\nForwardAgent \u003cspan class=\"token function\"\u003eyes\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eNext step is to \u003cps1\u003eadd your key to ssh agent\u003c/ps1\u003e\u003c/p\u003e\n\u003cp\u003eOn ssh session you can do it with commands\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"token builtin class-name\"\u003eeval\u003c/span\u003e \u003cspan class=\"token variable\"\u003e\u003cspan class=\"token variable\"\u003e`\u003c/span\u003essh-agent -s\u003cspan class=\"token variable\"\u003e`\u003c/span\u003e\u003c/span\u003e\nssh-add ~/.ssh/id_rsa\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eBut it won't work in TeamCity without some configuration via UI.\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eOpen project's administartion page and upload SSH Key which you want to add to ssh-agent on build time\n\u003cimg src=\"/images/p1070/1.png\" alt=\"\"\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr/\u003e\n\u003cp\u003e\u003cimg src=\"/images/p1070/2.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003eOpen Build Configuration settings and add \u003cstrong\u003eBuild Feature\u003c/strong\u003e \u003cps1\u003eSSH agent\u003c/ps1\u003e\n\u003cimg src=\"/images/p1070/3.png\" alt=\"\"\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eAfter this build step git clone should work fine and you can start fixing next failed step 🤯🤬\u003c/p\u003e\n","title":"Ansible: Permission denied (publickey) and TeamCity","date":"2021-02-02T00:30:33+00:00","permalink":"/?p=1070","author":"pavel","type":"post","tag":["ansible","deployment","deployment errors","ansible-playbook","git","GitHub"],"post_format":[]}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"ansible-permission-denied-publickey"},"buildId":"BwHRlFq10oUkqt4iTe7ee","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-83732ebf2ed7f8a1b2c7.js"></script><script src="/_next/static/chunks/main-d99e70035f31fbf26280.js" async=""></script><script src="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" async=""></script><script src="/_next/static/chunks/framework.ef157c678a62cfb2c073.js" async=""></script><script src="/_next/static/chunks/commons.0cd3f0b406132b99fef1.js" async=""></script><script src="/_next/static/chunks/pages/_app-f576db2e6f64d3b421e3.js" async=""></script><script src="/_next/static/chunks/b435696c38dfa3a566dd7089f731d08d7e0bf097.f940d483b5a1fae10b21.js" async=""></script><script src="/_next/static/chunks/1d62a1056678c2f23610de94ff6f49e06a569636.b588272bed0c9114d503.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-dd3e2b826f95ad4c71da.js" async=""></script><script src="/_next/static/BwHRlFq10oUkqt4iTe7ee/_buildManifest.js" async=""></script><script src="/_next/static/BwHRlFq10oUkqt4iTe7ee/_ssgManifest.js" async=""></script></body></html>