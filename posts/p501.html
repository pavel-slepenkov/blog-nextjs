<!DOCTYPE html><html><head><meta charSet="utf-8"/><link rel="icon" href="/favicon.ico"/><link href="https://unpkg.com/prismjs@1.23.0/themes/prism-okaidia.css" rel="stylesheet"/><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="description" content="Pavel Slepenkov&#x27;s personal blog: stories about BI, python, salesforce and data analysis"/><meta http-equiv="cache-control" content="Private"/><meta http-equiv="Expires" content="366000"/><meta property="og:locale" content="en_US"/><meta name="og:title" content="Pavel Slepenkov&#x27;s personal blog"/><meta property="og:description" content="stories about BI, python, salesforce and data analysis"/><meta property="og:type" content="article"/><meta property="og:site_name" content="pavelslepenkov.info"/><meta property="og:image" content="/og.png"/><meta name="twitter:title" content="Pavel Slepenkov&#x27;s personal blog"/><meta name="twitter:description" content="stories about BI, python, salesforce and data analysis"/><meta name="twitter:card" content="summary_large_image"/><meta property="twitter:image" content="/og.png"/><meta name="keywords" content="python, BI, sql, salesforce, data engineering, apex, soql, data analisys"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-63037633-1"></script><script>
                            window.dataLayer = window.dataLayer || [];
                            function gtag(){dataLayer.push(arguments);}
                            gtag('js', new Date());
                            gtag('config', 'UA-63037633-1');
                    </script><style>@import url(&#x27;https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300&amp;family=Spectral:wght@300;600&amp;display=swap&#x27;);</style><title>Calculate amount of specified task records which are related to Contact and Account in Salesforce</title><meta name="next-head-count" content="23"/><link rel="preload" href="/_next/static/css/8ed85b7126e02c37.css" as="style"/><link rel="stylesheet" href="/_next/static/css/8ed85b7126e02c37.css" data-n-g=""/><link rel="preload" href="/_next/static/css/c030ed0cc76c59b0.css" as="style"/><link rel="stylesheet" href="/_next/static/css/c030ed0cc76c59b0.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-ee7e63bc15b31913.js" defer=""></script><script src="/_next/static/chunks/framework-ad45764ecfcae9e5.js" defer=""></script><script src="/_next/static/chunks/main-ee0cf4b7f81d7c24.js" defer=""></script><script src="/_next/static/chunks/pages/_app-2398585b21d2d8c8.js" defer=""></script><script src="/_next/static/chunks/105-51803cf0fd5a7825.js" defer=""></script><script src="/_next/static/chunks/358-14c60bb94e9d94b9.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-c9b3c3f336e43dc2.js" defer=""></script><script src="/_next/static/_g8WfzezeGPockdjgMM2j/_buildManifest.js" defer=""></script><script src="/_next/static/_g8WfzezeGPockdjgMM2j/_ssgManifest.js" defer=""></script></head><body class="centered"><script src="noflash.js"></script><script src="PathSolver.js"></script><div id="__next"><div class="layout_container__fbLkO"><div class="no-print"><header class="layout_header__kY0Lt"><div class="navbar-link centered"><a class="layout_devNull__CjwH1" href="/">Technical notes</a>—————<a class="layout_devNull__CjwH1" href="/cv">CV</a>—————<a class="layout_devNull__CjwH1" href="/books">Books &amp; Readings</a></div><div class="DarkModeToggle_darkModeToggle__m5z3H"><button type="button">🌞</button><button type="button">🌚</button></div></header></div><main><article><h1 class="utils_headingXl__u25Y2">Calculate amount of specified task records which are related to Contact and Account in Salesforce</h1><div class="utils_lightText__eUzGY"><time dateTime="2015-07-15T15:07:51+01:00">July 15, 2015</time></div><div><p>Pretty often you need to know how many times some Contact has been used in Log a Call functionality. Aggregation of such count in an account level might be pretty useful too. So, let's implement this functionality. I faced with such requirement a few times with different customers, so I'd like to share my experience.</p>
<p>All you know, in the perfect world we should use built-in functionality and avoid a custom implementations. So, firstly I checked for a way to build it with some Salesforce native functionality. First thing which was considered is a Roll-up summary field. But we can't use Roll-up summary fields here, because these object has no master-detail relationship by default. Sure, you can create such relation, but it's no a case for me. The result of quick investigation lets me think that trigger will be an ideal solution for such functionality.</p>
<p>So, firstly I create 2 fields Reference_Count__c on Contact and Account. Both fields has Number type. After that I create a trigger on Task object which runs <strong>after insert, after update</strong> and <strong>after delete</strong>.</p>
<p>There are the following cases:</p>
<ul>
<li>When user creates task with Type = 'Call' we have to <strong>increment</strong> counter on Contact which is related to this task and also we have to increate a count on Account which is related to Contact.</li>
<li>When user changes type of task from any to 'Call' we have to <strong>increment</strong> counters.</li>
<li>When user changes type of task from 'Call' to any other we have to <strong>decrement</strong> counter for Contact and Account related to this task.</li>
<li>Also we have to <strong>decrement</strong> counters when user removes Task</li>
</ul>
<p>You can find a whole solution on <a href="https://github.com/pavel-slepenkov/salesforce_solutions/tree/master/reference_count">GitHub.</a></p>
<p>Let's break each point to separate method:</p>
<ol>
<li>When user creates a task with Type = 'Call' we have to increment counter on Contact which is related to this task and we also have to increment a count on Account which is parent to Contact.</li>
</ol>
<div class="remark-highlight"><pre class="language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">increaseReferenceCountOnInsert</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&#x3C;</span>sObject<span class="token punctuation">></span></span> newRecords<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&#x3C;</span>sObject<span class="token punctuation">></span></span> taskRelatedToContact <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&#x3C;</span>sObject<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SObject</span> obj <span class="token operator">:</span> newRecords<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>obj<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token char">'WhoId'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token constant">CONTACT_RECORDS_PREFIX</span><span class="token punctuation">)</span> <span class="token operator">&#x26;&#x26;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>obj<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token char">'Type'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">LOG_A_CALL_TYPE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            taskRelatedToContact<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">updateReferenceCountField</span><span class="token punctuation">(</span>taskRelatedToContact<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<ol start="2">
<li>When user changes type of task from any to 'Call' we have to increase counters.</li>
</ol>
<div class="remark-highlight"><pre class="language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">increaseReferenceCountOnUpdate</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&#x3C;</span>sObject<span class="token punctuation">></span></span> newRecords<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&#x3C;</span>ID<span class="token punctuation">,</span> sObject<span class="token punctuation">></span></span> oldRecordsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&#x3C;</span>sObject<span class="token punctuation">></span></span> taskRelatedToContact <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&#x3C;</span>sObject<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SObject</span> obj <span class="token operator">:</span> newRecords<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>obj<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token char">'WhoId'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token constant">CONTACT_RECORDS_PREFIX</span><span class="token punctuation">)</span>
            <span class="token operator">&#x26;&#x26;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>obj<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token char">'Type'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">LOG_A_CALL_TYPE</span>
            <span class="token operator">&#x26;&#x26;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">(</span>oldRecordsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Id</span><span class="token punctuation">)</span>obj<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token char">'Id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token char">'Type'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">LOG_A_CALL_TYPE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            taskRelatedToContact<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">updateReferenceCountField</span><span class="token punctuation">(</span>taskRelatedToContact<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>The next method is used in 2 cases:
3) When user changes type of task from 'Call' to any other we have to decrease counter for Contact and Account to which this task is related.
4) We have to decrease counters when user removes the Task</p>
<div class="remark-highlight"><pre class="language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">decreaseReferenceCountOnTaskTypeChange</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&#x3C;</span>sObject<span class="token punctuation">></span></span> newRecords<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&#x3C;</span>ID<span class="token punctuation">,</span> sObject<span class="token punctuation">></span></span> oldRecordsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&#x3C;</span>sObject<span class="token punctuation">></span></span> taskToDecreaseCount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&#x3C;</span>sObject<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SObject</span> obj <span class="token operator">:</span> newRecords<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Trigger</span><span class="token punctuation">.</span>isUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>obj<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token char">'WhoId'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token constant">CONTACT_RECORDS_PREFIX</span><span class="token punctuation">)</span>
                <span class="token operator">&#x26;&#x26;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>obj<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token char">'Type'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">LOG_A_CALL_TYPE</span>
                <span class="token operator">&#x26;&#x26;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">(</span>oldRecordsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Id</span><span class="token punctuation">)</span>obj<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token char">'Id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token char">'Type'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">LOG_A_CALL_TYPE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                taskToDecreaseCount<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Trigger</span><span class="token punctuation">.</span>isDelete <span class="token operator">&#x26;&#x26;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>obj<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token char">'Type'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">LOG_A_CALL_TYPE</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            taskToDecreaseCount<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">updateReferenceCountField</span><span class="token punctuation">(</span>taskToDecreaseCount<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>You can find that all these methods invoke updateReferenceCountField method</p>
<div class="remark-highlight"><pre class="language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">updateReferenceCountField</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&#x3C;</span>sObject<span class="token punctuation">></span></span> tasks<span class="token punctuation">,</span> <span class="token class-name">Boolean</span> isIncrement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Map</span><span class="token operator">&#x3C;</span><span class="token class-name">Id</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&#x3C;</span>sObject<span class="token punctuation">></span></span> tasksByContact <span class="token operator">=</span> <span class="token function">splitListBySpecialKey</span><span class="token punctuation">(</span>tasks<span class="token punctuation">,</span> <span class="token char">'WhoId'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&#x3C;</span><span class="token class-name">Contact</span><span class="token punctuation">></span></span> relatedContactsForUpdateCountField <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token constant">SELECT</span> <span class="token class-name">Id</span><span class="token punctuation">,</span> <span class="token class-name">Reference_Count__c</span><span class="token punctuation">,</span> <span class="token class-name">AccountId</span>
        <span class="token constant">FROM</span> <span class="token class-name">Contact</span>
        <span class="token constant">WHERE</span> <span class="token class-name">Id</span> <span class="token constant">IN</span><span class="token operator">:</span> tasksByContact<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">updateAccounts</span><span class="token punctuation">(</span>relatedContactsForUpdateCountField<span class="token punctuation">,</span> tasksByContact<span class="token punctuation">,</span> isIncrement<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">updateContacts</span><span class="token punctuation">(</span>relatedContactsForUpdateCountField<span class="token punctuation">,</span> tasksByContact<span class="token punctuation">,</span> isIncrement<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre></div>
<p>Which invokes 2 methods which actually perform DML</p>
<div class="remark-highlight"><pre class="language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">updateAccounts</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&#x3C;</span><span class="token class-name">Contact</span><span class="token punctuation">></span></span> relatedContactsForUpdateCountField<span class="token punctuation">,</span>
                                   <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&#x3C;</span><span class="token class-name">Id</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&#x3C;</span>sObject<span class="token punctuation">></span><span class="token punctuation">></span></span> tasksByContact<span class="token punctuation">,</span> <span class="token class-name">Boolean</span> isIncrement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ContactId, Account</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&#x3C;</span><span class="token class-name">Id</span><span class="token punctuation">,</span><span class="token class-name">Id</span><span class="token punctuation">></span></span> contactIdByAccountId <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&#x3C;</span><span class="token class-name">Id</span><span class="token punctuation">,</span><span class="token class-name">Id</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Contact</span> cont<span class="token operator">:</span> relatedContactsForUpdateCountField<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        contactIdByAccountId<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">cont<span class="token punctuation">.</span></span>AccountId</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">cont<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&#x3C;</span><span class="token class-name">Account</span><span class="token punctuation">></span></span> accountsRelatedToContactsForUpdate <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token constant">SELECT</span> <span class="token class-name">Id</span><span class="token punctuation">,</span> <span class="token class-name">Reference_Count__c</span>
        <span class="token constant">FROM</span> <span class="token class-name">Account</span>
        <span class="token constant">WHERE</span> <span class="token class-name">Id</span> <span class="token constant">IN</span><span class="token operator">:</span> contactIdByAccountId<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Account</span> acc<span class="token operator">:</span> accountsRelatedToContactsForUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">acc<span class="token punctuation">.</span></span>Reference_Count__c</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isIncrement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name"><span class="token namespace">acc<span class="token punctuation">.</span></span>Reference_Count__c</span> <span class="token operator">+=</span> tasksByContact<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>contactIdByAccountId<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">acc<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token class-name"><span class="token namespace">acc<span class="token punctuation">.</span></span>Reference_Count__c</span> <span class="token operator">-=</span> tasksByContact<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>contactIdByAccountId<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">acc<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token namespace">acc<span class="token punctuation">.</span></span>Reference_Count__c</span> <span class="token operator">=</span> tasksByContact<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>contactIdByAccountId<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">acc<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    update accountsRelatedToContactsForUpdate<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">updateContacts</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&#x3C;</span><span class="token class-name">Contact</span><span class="token punctuation">></span></span> relatedContactsForUpdateCountField<span class="token punctuation">,</span>
                                    <span class="token class-name">Map</span><span class="token operator">&#x3C;</span><span class="token class-name">Id</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&#x3C;</span>sObject<span class="token punctuation">></span></span> tasksByContact<span class="token punctuation">,</span> <span class="token class-name">Boolean</span> isIncrement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Contact</span> cont<span class="token operator">:</span> relatedContactsForUpdateCountField<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Integer</span> amountOfNewTasks <span class="token operator">=</span> tasksByContact<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">cont<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>amountOfNewTasks <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">cont<span class="token punctuation">.</span></span>Reference_Count__c</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>isIncrement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name"><span class="token namespace">cont<span class="token punctuation">.</span></span>Reference_Count__c</span> <span class="token operator">+=</span> amountOfNewTasks<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token class-name"><span class="token namespace">cont<span class="token punctuation">.</span></span>Reference_Count__c</span> <span class="token operator">-=</span> amountOfNewTasks<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token class-name"><span class="token namespace">cont<span class="token punctuation">.</span></span>Reference_Count__c</span> <span class="token operator">=</span> amountOfNewTasks<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    update relatedContactsForUpdateCountField<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>We also need this utility method for transformation list into map</p>
<div class="remark-highlight"><pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token operator">&#x3C;</span><span class="token class-name">Id</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&#x3C;</span>sObject<span class="token punctuation">></span></span> <span class="token function">splitListBySpecialKey</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&#x3C;</span>sObject<span class="token punctuation">></span></span> sourceList<span class="token punctuation">,</span> <span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sourceList <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IncorrectParameterException</span><span class="token punctuation">(</span>'<span class="token constant">ERROR</span><span class="token operator">:</span> <span class="token function">splitListBySpecialKey</span><span class="token punctuation">(</span>sourceList<span class="token punctuation">,</span> key<span class="token punctuation">)</span> got incorrect first parameter<span class="token punctuation">.</span>'<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IncorrectParameterException</span><span class="token punctuation">(</span>'<span class="token constant">ERROR</span><span class="token operator">:</span> <span class="token function">splitListBySpecialKey</span><span class="token punctuation">(</span>sourceList<span class="token punctuation">,</span> key<span class="token punctuation">)</span> got incorrect second parameter<span class="token punctuation">.</span>'<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Map</span><span class="token operator">&#x3C;</span><span class="token class-name">Id</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&#x3C;</span>sObject<span class="token punctuation">></span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token operator">&#x3C;</span><span class="token class-name">Id</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&#x3C;</span>sObject<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&#x3C;</span>sObject<span class="token punctuation">></span></span> tmpObjs<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>sObject obj <span class="token operator">:</span> sourceList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        tmpObjs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&#x3C;</span>sObject<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&#x26;&#x26;</span> result<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Id</span><span class="token punctuation">)</span>obj<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            tmpObjs <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Id</span><span class="token punctuation">)</span>obj<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            tmpObjs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Id</span><span class="token punctuation">)</span>obj<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> tmpObjs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            tmpObjs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Id</span><span class="token punctuation">)</span>obj<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> tmpObjs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IncorrectParameterException</span> <span class="token keyword">extends</span> <span class="token class-name">System<span class="token punctuation">.</span>Exception</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

</code></pre></div>
</div></article><div></div></main><div class="layout_backToHome__9sjx_"><a href="/">⇐ back to home</a></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"p501","contentHtml":"\u003cp\u003ePretty often you need to know how many times some Contact has been used in Log a Call functionality. Aggregation of such count in an account level might be pretty useful too. So, let's implement this functionality. I faced with such requirement a few times with different customers, so I'd like to share my experience.\u003c/p\u003e\n\u003cp\u003eAll you know, in the perfect world we should use built-in functionality and avoid a custom implementations. So, firstly I checked for a way to build it with some Salesforce native functionality. First thing which was considered is a Roll-up summary field. But we can't use Roll-up summary fields here, because these object has no master-detail relationship by default. Sure, you can create such relation, but it's no a case for me. The result of quick investigation lets me think that trigger will be an ideal solution for such functionality.\u003c/p\u003e\n\u003cp\u003eSo, firstly I create 2 fields Reference_Count__c on Contact and Account. Both fields has Number type. After that I create a trigger on Task object which runs \u003cstrong\u003eafter insert, after update\u003c/strong\u003e and \u003cstrong\u003eafter delete\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThere are the following cases:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eWhen user creates task with Type = 'Call' we have to \u003cstrong\u003eincrement\u003c/strong\u003e counter on Contact which is related to this task and also we have to increate a count on Account which is related to Contact.\u003c/li\u003e\n\u003cli\u003eWhen user changes type of task from any to 'Call' we have to \u003cstrong\u003eincrement\u003c/strong\u003e counters.\u003c/li\u003e\n\u003cli\u003eWhen user changes type of task from 'Call' to any other we have to \u003cstrong\u003edecrement\u003c/strong\u003e counter for Contact and Account related to this task.\u003c/li\u003e\n\u003cli\u003eAlso we have to \u003cstrong\u003edecrement\u003c/strong\u003e counters when user removes Task\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eYou can find a whole solution on \u003ca href=\"https://github.com/pavel-slepenkov/salesforce_solutions/tree/master/reference_count\"\u003eGitHub.\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eLet's break each point to separate method:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eWhen user creates a task with Type = 'Call' we have to increment counter on Contact which is related to this task and we also have to increment a count on Account which is parent to Contact.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-java\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"token keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"token keyword\"\u003estatic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"token function\"\u003eincreaseReferenceCountOnInsert\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eList\u003c/span\u003e\u003cspan class=\"token generics\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003esObject\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e newRecords\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token class-name\"\u003eList\u003c/span\u003e\u003cspan class=\"token generics\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003esObject\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e taskRelatedToContact \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eList\u003c/span\u003e\u003cspan class=\"token generics\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003esObject\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eSObject\u003c/span\u003e obj \u003cspan class=\"token operator\"\u003e:\u003c/span\u003e newRecords\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003eobj\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token char\"\u003e'WhoId'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003estartsWith\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token constant\"\u003eCONTACT_RECORDS_PREFIX\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003eobj\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token char\"\u003e'Type'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token constant\"\u003eLOG_A_CALL_TYPE\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            taskRelatedToContact\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eadd\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eobj\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eupdateReferenceCountField\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etaskRelatedToContact\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003eWhen user changes type of task from any to 'Call' we have to increase counters.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-java\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"token keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"token keyword\"\u003estatic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"token function\"\u003eincreaseReferenceCountOnUpdate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eList\u003c/span\u003e\u003cspan class=\"token generics\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003esObject\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e newRecords\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eMap\u003c/span\u003e\u003cspan class=\"token generics\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003eID\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e sObject\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e oldRecordsMap\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token class-name\"\u003eList\u003c/span\u003e\u003cspan class=\"token generics\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003esObject\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e taskRelatedToContact \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eList\u003c/span\u003e\u003cspan class=\"token generics\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003esObject\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eSObject\u003c/span\u003e obj \u003cspan class=\"token operator\"\u003e:\u003c/span\u003e newRecords\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003eobj\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token char\"\u003e'WhoId'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003estartsWith\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token constant\"\u003eCONTACT_RECORDS_PREFIX\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003eobj\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token char\"\u003e'Type'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token constant\"\u003eLOG_A_CALL_TYPE\u003c/span\u003e\n            \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eoldRecordsMap\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eId\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003eobj\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token char\"\u003e'Id'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token char\"\u003e'Type'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token constant\"\u003eLOG_A_CALL_TYPE\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            taskRelatedToContact\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eadd\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eobj\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eupdateReferenceCountField\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etaskRelatedToContact\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe next method is used in 2 cases:\n3) When user changes type of task from 'Call' to any other we have to decrease counter for Contact and Account to which this task is related.\n4) We have to decrease counters when user removes the Task\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-java\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"token keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"token keyword\"\u003estatic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"token function\"\u003edecreaseReferenceCountOnTaskTypeChange\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eList\u003c/span\u003e\u003cspan class=\"token generics\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003esObject\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e newRecords\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eMap\u003c/span\u003e\u003cspan class=\"token generics\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003eID\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e sObject\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e oldRecordsMap\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token class-name\"\u003eList\u003c/span\u003e\u003cspan class=\"token generics\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003esObject\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e taskToDecreaseCount \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eList\u003c/span\u003e\u003cspan class=\"token generics\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003esObject\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eSObject\u003c/span\u003e obj \u003cspan class=\"token operator\"\u003e:\u003c/span\u003e newRecords\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eTrigger\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eisUpdate\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003eobj\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token char\"\u003e'WhoId'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003estartsWith\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token constant\"\u003eCONTACT_RECORDS_PREFIX\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003eobj\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token char\"\u003e'Type'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token constant\"\u003eLOG_A_CALL_TYPE\u003c/span\u003e\n                \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eoldRecordsMap\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eId\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003eobj\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token char\"\u003e'Id'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token char\"\u003e'Type'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token constant\"\u003eLOG_A_CALL_TYPE\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n                taskToDecreaseCount\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eadd\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eobj\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eTrigger\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eisDelete \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003eobj\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token char\"\u003e'Type'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token constant\"\u003eLOG_A_CALL_TYPE\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            taskToDecreaseCount\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eadd\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eobj\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eupdateReferenceCountField\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etaskToDecreaseCount\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eYou can find that all these methods invoke updateReferenceCountField method\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-java\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"token keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"token keyword\"\u003estatic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"token function\"\u003eupdateReferenceCountField\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eList\u003c/span\u003e\u003cspan class=\"token generics\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003esObject\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e tasks\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eBoolean\u003c/span\u003e isIncrement\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token class-name\"\u003eMap\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eId\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eList\u003c/span\u003e\u003cspan class=\"token generics\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003esObject\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e tasksByContact \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003esplitListBySpecialKey\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etasks\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token char\"\u003e'WhoId'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token class-name\"\u003eList\u003c/span\u003e\u003cspan class=\"token generics\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eContact\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e relatedContactsForUpdateCountField \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n        \u003cspan class=\"token constant\"\u003eSELECT\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eId\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eReference_Count__c\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eAccountId\u003c/span\u003e\n        \u003cspan class=\"token constant\"\u003eFROM\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eContact\u003c/span\u003e\n        \u003cspan class=\"token constant\"\u003eWHERE\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eId\u003c/span\u003e \u003cspan class=\"token constant\"\u003eIN\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e tasksByContact\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ekeySet\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eupdateAccounts\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003erelatedContactsForUpdateCountField\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e tasksByContact\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e isIncrement\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token function\"\u003eupdateContacts\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003erelatedContactsForUpdateCountField\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e tasksByContact\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e isIncrement\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eWhich invokes 2 methods which actually perform DML\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-java\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"token keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"token keyword\"\u003estatic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"token function\"\u003eupdateAccounts\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eList\u003c/span\u003e\u003cspan class=\"token generics\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eContact\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e relatedContactsForUpdateCountField\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n                                   \u003cspan class=\"token class-name\"\u003eMap\u003c/span\u003e\u003cspan class=\"token generics\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eId\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eList\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003esObject\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e tasksByContact\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eBoolean\u003c/span\u003e isIncrement\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// ContactId, Account\u003c/span\u003e\n    \u003cspan class=\"token class-name\"\u003eMap\u003c/span\u003e\u003cspan class=\"token generics\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eId\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eId\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e contactIdByAccountId \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eMap\u003c/span\u003e\u003cspan class=\"token generics\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eId\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eId\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eContact\u003c/span\u003e cont\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e relatedContactsForUpdateCountField\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        contactIdByAccountId\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eput\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003e\u003cspan class=\"token namespace\"\u003econt\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003c/span\u003eAccountId\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003e\u003cspan class=\"token namespace\"\u003econt\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003c/span\u003eId\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token class-name\"\u003eList\u003c/span\u003e\u003cspan class=\"token generics\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eAccount\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e accountsRelatedToContactsForUpdate \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n        \u003cspan class=\"token constant\"\u003eSELECT\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eId\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eReference_Count__c\u003c/span\u003e\n        \u003cspan class=\"token constant\"\u003eFROM\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eAccount\u003c/span\u003e\n        \u003cspan class=\"token constant\"\u003eWHERE\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eId\u003c/span\u003e \u003cspan class=\"token constant\"\u003eIN\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e contactIdByAccountId\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ekeySet\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eAccount\u003c/span\u003e acc\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e accountsRelatedToContactsForUpdate\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003e\u003cspan class=\"token namespace\"\u003eacc\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003c/span\u003eReference_Count__c\u003c/span\u003e \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eisIncrement\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"token class-name\"\u003e\u003cspan class=\"token namespace\"\u003eacc\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003c/span\u003eReference_Count__c\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e tasksByContact\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003econtactIdByAccountId\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003e\u003cspan class=\"token namespace\"\u003eacc\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003c/span\u003eId\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esize\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"token class-name\"\u003e\u003cspan class=\"token namespace\"\u003eacc\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003c/span\u003eReference_Count__c\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-=\u003c/span\u003e tasksByContact\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003econtactIdByAccountId\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003e\u003cspan class=\"token namespace\"\u003eacc\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003c/span\u003eId\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esize\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token class-name\"\u003e\u003cspan class=\"token namespace\"\u003eacc\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003c/span\u003eReference_Count__c\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e tasksByContact\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003econtactIdByAccountId\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003e\u003cspan class=\"token namespace\"\u003eacc\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003c/span\u003eId\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esize\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    update accountsRelatedToContactsForUpdate\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"token keyword\"\u003estatic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"token function\"\u003eupdateContacts\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eList\u003c/span\u003e\u003cspan class=\"token generics\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eContact\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e relatedContactsForUpdateCountField\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n                                    \u003cspan class=\"token class-name\"\u003eMap\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eId\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eList\u003c/span\u003e\u003cspan class=\"token generics\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003esObject\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e tasksByContact\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eBoolean\u003c/span\u003e isIncrement\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eContact\u003c/span\u003e cont\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e relatedContactsForUpdateCountField\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token class-name\"\u003eInteger\u003c/span\u003e amountOfNewTasks \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e tasksByContact\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003e\u003cspan class=\"token namespace\"\u003econt\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003c/span\u003eId\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esize\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eamountOfNewTasks \u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003e\u003cspan class=\"token namespace\"\u003econt\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003c/span\u003eReference_Count__c\u003c/span\u003e \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eisIncrement\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"token class-name\"\u003e\u003cspan class=\"token namespace\"\u003econt\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003c/span\u003eReference_Count__c\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e amountOfNewTasks\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"token class-name\"\u003e\u003cspan class=\"token namespace\"\u003econt\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003c/span\u003eReference_Count__c\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-=\u003c/span\u003e amountOfNewTasks\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"token class-name\"\u003e\u003cspan class=\"token namespace\"\u003econt\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003c/span\u003eReference_Count__c\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e amountOfNewTasks\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    update relatedContactsForUpdateCountField\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eWe also need this utility method for transformation list into map\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-java\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003estatic\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eMap\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eId\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eList\u003c/span\u003e\u003cspan class=\"token generics\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003esObject\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token function\"\u003esplitListBySpecialKey\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eList\u003c/span\u003e\u003cspan class=\"token generics\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003esObject\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e sourceList\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e key\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003esourceList \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003ethrow\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eIncorrectParameterException\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e'\u003cspan class=\"token constant\"\u003eERROR\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token function\"\u003esplitListBySpecialKey\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003esourceList\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e key\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e got incorrect first parameter\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e'\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eisBlank\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ekey\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003ethrow\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eIncorrectParameterException\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e'\u003cspan class=\"token constant\"\u003eERROR\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token function\"\u003esplitListBySpecialKey\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003esourceList\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e key\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e got incorrect second parameter\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e'\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token class-name\"\u003eMap\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eId\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eList\u003c/span\u003e\u003cspan class=\"token generics\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003esObject\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e result \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eMap\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eId\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eList\u003c/span\u003e\u003cspan class=\"token generics\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003esObject\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token class-name\"\u003eList\u003c/span\u003e\u003cspan class=\"token generics\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003esObject\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e tmpObjs\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003esObject obj \u003cspan class=\"token operator\"\u003e:\u003c/span\u003e sourceList\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        tmpObjs \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eList\u003c/span\u003e\u003cspan class=\"token generics\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003esObject\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eobj\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ekey\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enull\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e result\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003econtainsKey\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eId\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003eobj\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ekey\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            tmpObjs \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e result\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eId\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003eobj\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ekey\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            tmpObjs\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eadd\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eobj\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            result\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eput\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eId\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003eobj\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ekey\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e tmpObjs\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eobj\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ekey\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            tmpObjs\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eadd\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eobj\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            result\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eput\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eId\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003eobj\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ekey\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e tmpObjs\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e result\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eIncorrectParameterException\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eextends\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eSystem\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eException\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n","title":"Calculate amount of specified task records which are related to Contact and Account in Salesforce","date":"2015-07-15T15:07:51+01:00","status":"publish","permalink":"/?p=501","author":"pavel","excerpt":"","type":"post","category":["apex","force.com","salesforce.com"],"tag":[],"post_format":[],"cleanretina_sidebarlayout":["default"],"dsq_thread_id":["5605961530"]}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"p501"},"buildId":"_g8WfzezeGPockdjgMM2j","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>