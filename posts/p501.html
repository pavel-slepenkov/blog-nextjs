<!DOCTYPE html><html><head><meta charSet="utf-8"/><link rel="icon" href="/favicon.ico"/><link href="https://unpkg.com/prismjs@1.23.0/themes/prism-okaidia.css" rel="stylesheet"/><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="description" content="Pavel Slepenkov&#x27;s personal blog: stories about BI, python, salesforce and data analysis"/><meta http-equiv="cache-control" content="Private"/><meta http-equiv="Expires" content="366000"/><meta property="og:locale" content="en_US"/><meta name="og:title" content="Pavel Slepenkov&#x27;s personal blog"/><meta property="og:description" content="stories about BI, python, salesforce and data analysis"/><meta property="og:type" content="article"/><meta property="og:site_name" content="pavelslepenkov.info"/><meta property="og:image" content="/og.png"/><meta name="twitter:title" content="Pavel Slepenkov&#x27;s personal blog"/><meta name="twitter:description" content="stories about BI, python, salesforce and data analysis"/><meta name="twitter:card" content="summary_large_image"/><meta property="twitter:image" content="/og.png"/><meta name="keywords" content="python, BI, salesforce, data engineering, apex, sql, soql, data analisys"/><meta name="yandex-verification" content="35a3887ea995a4c4"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-63037633-1"></script><script>
                            window.dataLayer = window.dataLayer || [];
                            function gtag(){dataLayer.push(arguments);}
                            gtag('js', new Date());
                            gtag('config', 'UA-63037633-1');
                    </script><style>@import url(&#x27;https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300&amp;family=Spectral:wght@300&amp;display=swap&#x27;);</style><title>Calculate amount of specified task records which are related to Contact and Account in Salesforce</title><meta name="next-head-count" content="24"/><link rel="preload" href="/_next/static/css/7bd0320823d9bdbcc2b3.css" as="style"/><link rel="stylesheet" href="/_next/static/css/7bd0320823d9bdbcc2b3.css" data-n-g=""/><link rel="preload" href="/_next/static/css/6dce80f39b6e217927f5.css" as="style"/><link rel="stylesheet" href="/_next/static/css/6dce80f39b6e217927f5.css" data-n-p=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-a7c970f167496c3f3d8f.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.ef157c678a62cfb2c073.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.0cd3f0b406132b99fef1.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-d4c4590d6f89b99d62f3.js" as="script"/><link rel="preload" href="/_next/static/chunks/1d62a1056678c2f23610de94ff6f49e06a569636.2116ac35632db79554b8.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5Bid%5D-f26bd131465ef7dfa7da.js" as="script"/></head><body><script src="noflash.js"></script><script src="PathSolver.js"></script><div id="__next"><div class="layout_container__2t4v2"><header class="layout_header__2rhWq"><div class="navbar-link"><a class="layout_devNull__6Fs9d" href="/">$ /dev/null</a>———<a class="layout_devNull__6Fs9d" href="/about">About </a>———<a class="layout_devNull__6Fs9d" href="https://pavel-slepenkov.github.io">Projects</a></div><div class="DarkModeToggle_darkModeToggle__2u4u3"><button type="button">☀</button><toggle></toggle><button type="button">☾</button></div></header><main><article><h1 class="utils_headingXl__1XecN">Calculate amount of specified task records which are related to Contact and Account in Salesforce</h1><div class="utils_lightText__12Ckm"><time dateTime="2015-07-15T15:07:51+01:00">July 15, 2015</time></div><div><p>Pretty often You need to know how many times some Contact has been used in Log a Call functionality. Aggregation of such count in an account level might be pretty useful too. So, let’s implement this functionality. I faced with such requirement a few times with different customers, so I’d like to share my experience.</p>
<p>As all you know, in the perfect world we should use built-in functionality and avoid a custom implementations. So, firstly I was looking for a way to build it with Salesforce native approach. First thing which was considered is a Roll-up summary field. But we can’t use Roll-up summary fields here, because these object has no master-detail relationship by default. Sure, you can create such relation, but it’s no a case for me. The result of quick investigation lets me think that trigger will be an ideal solution for such functionality.</p>
<p>So, firstly I create 2 fields Reference_Count__c on Contact and Account. Both fields has Number type.</p>
<p>After that I create a trigger on Task object which runs <strong>after insert, after update</strong> and <strong>after delete</strong>.</p>
<p>There are the following cases:</p>
<ul>
<li>When user creates task with Type = ‘Call’ we have to <strong>increase</strong> counter on Contact which is related to this task and also we have to increate a count on Account which is related to Contact.</li>
<li>When user changes type of task from any to ‘Call’ we have to <strong>increase</strong> counters.</li>
<li>When user changes type of task from ‘Call’ to any other we have to <strong>decrease</strong> counter for Contact and Account related to this task.</li>
<li>Also we have to <strong>decrease</strong> counters when user removes Task</li>
</ul>
<p>You can find a whole solution on <a href="https://github.com/pavel-slepenkov/salesforce_solutions/tree/master/reference_count">GitHub.</a></p>
<p>Let’s break each point to separate method:
1) When user creates task with Type = ‘Call’ we have to increase counter on Contact which is related to this task and also we have to increate a count on Account which is related to Contact.</p>
<p>[java]
private static void increaseReferenceCountOnInsert(List&#x3C;sObject> newRecords) {
List&#x3C;sObject> taskRelatedToContact = new List&#x3C;sObject>();
for (SObject obj : newRecords) {
if (((String)obj.get(‘WhoId’)).startsWith(CONTACT_RECORDS_PREFIX) &#x26;&#x26; ((String)obj.get(‘Type’)) == LOG_A_CALL_TYPE) {
taskRelatedToContact.add(obj);
}
}
updateReferenceCountField(taskRelatedToContact, true);
}
[/java]</p>
<p>2) When user changes type of task from any to ‘Call’ we have to increase counters.</p>
<p>[java]
private static void increaseReferenceCountOnUpdate(List&#x3C;sObject> newRecords, Map&#x3C;ID, sObject> oldRecordsMap) {
List&#x3C;sObject> taskRelatedToContact = new List&#x3C;sObject>();
for (SObject obj : newRecords) {
if (((String)obj.get(‘WhoId’)).startsWith(CONTACT_RECORDS_PREFIX)
&#x26;&#x26; ((String)obj.get(‘Type’)) == LOG_A_CALL_TYPE
&#x26;&#x26; ((String)(oldRecordsMap.get((Id)obj.get(‘Id’))).get(‘Type’)) != LOG_A_CALL_TYPE) {
taskRelatedToContact.add(obj);
}
}
updateReferenceCountField(taskRelatedToContact, true);
}
[/java]</p>
<p>The next method is used for 2 cases:
3) When user changes type of task from ‘Call’ to any other we have to decrease counter for Contact and Account related to this task.
4) Also we have to decrease counters when user removes Task</p>
<p>[java]
private static void decreaseReferenceCountOnTaskTypeChange(List&#x3C;sObject> newRecords, Map&#x3C;ID, sObject> oldRecordsMap) {
List&#x3C;sObject> taskToDecreaseCount = new List&#x3C;sObject>();
for (SObject obj : newRecords) {
if (Trigger.isUpdate) {
if (((String)obj.get(‘WhoId’)).startsWith(CONTACT_RECORDS_PREFIX)
&#x26;&#x26; ((String)obj.get(‘Type’)) != LOG_A_CALL_TYPE
&#x26;&#x26; ((String)(oldRecordsMap.get((Id)obj.get(‘Id’))).get(‘Type’)) == LOG_A_CALL_TYPE) {
taskToDecreaseCount.add(obj);
}
} else if (Trigger.isDelete &#x26;&#x26; ((String)obj.get(‘Type’)) == LOG_A_CALL_TYPE ) {
taskToDecreaseCount.add(obj);
}
}
updateReferenceCountField(taskToDecreaseCount, false);
}
[/java]</p>
<p>You can find that all these methods invoke updateReferenceCountField method</p>
<p>[java]
private static void updateReferenceCountField(List&#x3C;sObject> tasks, Boolean isIncrement) {
Map&#x3C;Id, List&#x3C;sObject>> tasksByContact = splitListBySpecialKey(tasks, ‘WhoId’);
List&#x3C;Contact> relatedContactsForUpdateCountField = [SELECT Id, Reference_Count__c, AccountId
FROM Contact
WHERE Id IN: tasksByContact.keySet()];
updateAccounts(relatedContactsForUpdateCountField, tasksByContact, isIncrement);
updateContacts(relatedContactsForUpdateCountField, tasksByContact, isIncrement);
}
[/java]</p>
<p>Which invokes 2 method which actually perform DML</p>
<p>[java]
private static void updateAccounts(List&#x3C;Contact> relatedContactsForUpdateCountField,
Map&#x3C;Id, List&#x3C;sObject>> tasksByContact,
Boolean isIncrement) {
// ContactId, Account
Map&#x3C;Id,Id> contactIdByAccountId = new Map&#x3C;Id,Id>();
for (Contact cont: relatedContactsForUpdateCountField) {
contactIdByAccountId.put(cont.AccountId, cont.Id);
}
List&#x3C;Account> accountsRelatedToContactsForUpdate = [SELECT Id, Reference_Count__c
FROM Account
WHERE Id IN: contactIdByAccountId.keySet()];</p>
<p>for (Account acc: accountsRelatedToContactsForUpdate) {
if (acc.Reference_Count__c != null) {
if (isIncrement) {
acc.Reference_Count__c += tasksByContact.get(contactIdByAccountId.get(acc.Id)).size();
} else {
acc.Reference_Count__c -= tasksByContact.get(contactIdByAccountId.get(acc.Id)).size();
}
} else {
acc.Reference_Count__c = tasksByContact.get(contactIdByAccountId.get(acc.Id)).size();
}
}
update accountsRelatedToContactsForUpdate;
}</p>
<p>private static void updateContacts(List&#x3C;Contact> relatedContactsForUpdateCountField,
Map&#x3C;Id, List&#x3C;sObject>> tasksByContact,
Boolean isIncrement) {
for (Contact cont: relatedContactsForUpdateCountField) {
Integer amountOfNewTasks = tasksByContact.get(cont.Id).size();
if (amountOfNewTasks > 0) {
if (cont.Reference_Count__c != null) {
if (isIncrement) {
cont.Reference_Count__c += amountOfNewTasks;
} else {
cont.Reference_Count__c -= amountOfNewTasks;
}
} else {
cont.Reference_Count__c = amountOfNewTasks;
}
}
}
update relatedContactsForUpdateCountField;
}
[/java]</p>
<p>Also we need this utility method for transformation list into map</p>
<p>[java]
public static Map&#x3C;Id, List&#x3C;sObject>> splitListBySpecialKey(List&#x3C;sObject> sourceList, String key) {
if (sourceList == null) {
throw new IncorrectParameterException(‘ERROR: splitListBySpecialKey(sourceList, key) got incorrect first parameter.’);
}
if (String.isBlank(key)) {
throw new IncorrectParameterException(‘ERROR: splitListBySpecialKey(sourceList, key) got incorrect second parameter.’);
}
Map&#x3C;Id, List&#x3C;sObject>> result = new Map&#x3C;Id, List&#x3C;sObject>>();
List&#x3C;sObject> tmpObjs;
for (sObject obj : sourceList) {
tmpObjs = new List&#x3C;sObject>();
if (obj.get(key) != null &#x26;&#x26; result.containsKey((Id)obj.get(key))) {
tmpObjs = result.get((Id)obj.get(key));
tmpObjs.add(obj);
result.put((Id)obj.get(key), tmpObjs);
} else if (obj.get(key) != null) {
tmpObjs.add(obj);
result.put((Id)obj.get(key), tmpObjs);
}
}
return result;
}
public class IncorrectParameterException extends System.Exception {}
[/java]</p>
</div></article><div></div></main><div class="layout_backToHome__1vZsp"><a href="/">⇐ back to home</a></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"p501","contentHtml":"\u003cp\u003ePretty often You need to know how many times some Contact has been used in Log a Call functionality. Aggregation of such count in an account level might be pretty useful too. So, let’s implement this functionality. I faced with such requirement a few times with different customers, so I’d like to share my experience.\u003c/p\u003e\n\u003cp\u003eAs all you know, in the perfect world we should use built-in functionality and avoid a custom implementations. So, firstly I was looking for a way to build it with Salesforce native approach. First thing which was considered is a Roll-up summary field. But we can’t use Roll-up summary fields here, because these object has no master-detail relationship by default. Sure, you can create such relation, but it’s no a case for me. The result of quick investigation lets me think that trigger will be an ideal solution for such functionality.\u003c/p\u003e\n\u003cp\u003eSo, firstly I create 2 fields Reference_Count__c on Contact and Account. Both fields has Number type.\u003c/p\u003e\n\u003cp\u003eAfter that I create a trigger on Task object which runs \u003cstrong\u003eafter insert, after update\u003c/strong\u003e and \u003cstrong\u003eafter delete\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThere are the following cases:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eWhen user creates task with Type = ‘Call’ we have to \u003cstrong\u003eincrease\u003c/strong\u003e counter on Contact which is related to this task and also we have to increate a count on Account which is related to Contact.\u003c/li\u003e\n\u003cli\u003eWhen user changes type of task from any to ‘Call’ we have to \u003cstrong\u003eincrease\u003c/strong\u003e counters.\u003c/li\u003e\n\u003cli\u003eWhen user changes type of task from ‘Call’ to any other we have to \u003cstrong\u003edecrease\u003c/strong\u003e counter for Contact and Account related to this task.\u003c/li\u003e\n\u003cli\u003eAlso we have to \u003cstrong\u003edecrease\u003c/strong\u003e counters when user removes Task\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eYou can find a whole solution on \u003ca href=\"https://github.com/pavel-slepenkov/salesforce_solutions/tree/master/reference_count\"\u003eGitHub.\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eLet’s break each point to separate method:\n1) When user creates task with Type = ‘Call’ we have to increase counter on Contact which is related to this task and also we have to increate a count on Account which is related to Contact.\u003c/p\u003e\n\u003cp\u003e[java]\nprivate static void increaseReferenceCountOnInsert(List\u0026#x3C;sObject\u003e newRecords) {\nList\u0026#x3C;sObject\u003e taskRelatedToContact = new List\u0026#x3C;sObject\u003e();\nfor (SObject obj : newRecords) {\nif (((String)obj.get(‘WhoId’)).startsWith(CONTACT_RECORDS_PREFIX) \u0026#x26;\u0026#x26; ((String)obj.get(‘Type’)) == LOG_A_CALL_TYPE) {\ntaskRelatedToContact.add(obj);\n}\n}\nupdateReferenceCountField(taskRelatedToContact, true);\n}\n[/java]\u003c/p\u003e\n\u003cp\u003e2) When user changes type of task from any to ‘Call’ we have to increase counters.\u003c/p\u003e\n\u003cp\u003e[java]\nprivate static void increaseReferenceCountOnUpdate(List\u0026#x3C;sObject\u003e newRecords, Map\u0026#x3C;ID, sObject\u003e oldRecordsMap) {\nList\u0026#x3C;sObject\u003e taskRelatedToContact = new List\u0026#x3C;sObject\u003e();\nfor (SObject obj : newRecords) {\nif (((String)obj.get(‘WhoId’)).startsWith(CONTACT_RECORDS_PREFIX)\n\u0026#x26;\u0026#x26; ((String)obj.get(‘Type’)) == LOG_A_CALL_TYPE\n\u0026#x26;\u0026#x26; ((String)(oldRecordsMap.get((Id)obj.get(‘Id’))).get(‘Type’)) != LOG_A_CALL_TYPE) {\ntaskRelatedToContact.add(obj);\n}\n}\nupdateReferenceCountField(taskRelatedToContact, true);\n}\n[/java]\u003c/p\u003e\n\u003cp\u003eThe next method is used for 2 cases:\n3) When user changes type of task from ‘Call’ to any other we have to decrease counter for Contact and Account related to this task.\n4) Also we have to decrease counters when user removes Task\u003c/p\u003e\n\u003cp\u003e[java]\nprivate static void decreaseReferenceCountOnTaskTypeChange(List\u0026#x3C;sObject\u003e newRecords, Map\u0026#x3C;ID, sObject\u003e oldRecordsMap) {\nList\u0026#x3C;sObject\u003e taskToDecreaseCount = new List\u0026#x3C;sObject\u003e();\nfor (SObject obj : newRecords) {\nif (Trigger.isUpdate) {\nif (((String)obj.get(‘WhoId’)).startsWith(CONTACT_RECORDS_PREFIX)\n\u0026#x26;\u0026#x26; ((String)obj.get(‘Type’)) != LOG_A_CALL_TYPE\n\u0026#x26;\u0026#x26; ((String)(oldRecordsMap.get((Id)obj.get(‘Id’))).get(‘Type’)) == LOG_A_CALL_TYPE) {\ntaskToDecreaseCount.add(obj);\n}\n} else if (Trigger.isDelete \u0026#x26;\u0026#x26; ((String)obj.get(‘Type’)) == LOG_A_CALL_TYPE ) {\ntaskToDecreaseCount.add(obj);\n}\n}\nupdateReferenceCountField(taskToDecreaseCount, false);\n}\n[/java]\u003c/p\u003e\n\u003cp\u003eYou can find that all these methods invoke updateReferenceCountField method\u003c/p\u003e\n\u003cp\u003e[java]\nprivate static void updateReferenceCountField(List\u0026#x3C;sObject\u003e tasks, Boolean isIncrement) {\nMap\u0026#x3C;Id, List\u0026#x3C;sObject\u003e\u003e tasksByContact = splitListBySpecialKey(tasks, ‘WhoId’);\nList\u0026#x3C;Contact\u003e relatedContactsForUpdateCountField = [SELECT Id, Reference_Count__c, AccountId\nFROM Contact\nWHERE Id IN: tasksByContact.keySet()];\nupdateAccounts(relatedContactsForUpdateCountField, tasksByContact, isIncrement);\nupdateContacts(relatedContactsForUpdateCountField, tasksByContact, isIncrement);\n}\n[/java]\u003c/p\u003e\n\u003cp\u003eWhich invokes 2 method which actually perform DML\u003c/p\u003e\n\u003cp\u003e[java]\nprivate static void updateAccounts(List\u0026#x3C;Contact\u003e relatedContactsForUpdateCountField,\nMap\u0026#x3C;Id, List\u0026#x3C;sObject\u003e\u003e tasksByContact,\nBoolean isIncrement) {\n// ContactId, Account\nMap\u0026#x3C;Id,Id\u003e contactIdByAccountId = new Map\u0026#x3C;Id,Id\u003e();\nfor (Contact cont: relatedContactsForUpdateCountField) {\ncontactIdByAccountId.put(cont.AccountId, cont.Id);\n}\nList\u0026#x3C;Account\u003e accountsRelatedToContactsForUpdate = [SELECT Id, Reference_Count__c\nFROM Account\nWHERE Id IN: contactIdByAccountId.keySet()];\u003c/p\u003e\n\u003cp\u003efor (Account acc: accountsRelatedToContactsForUpdate) {\nif (acc.Reference_Count__c != null) {\nif (isIncrement) {\nacc.Reference_Count__c += tasksByContact.get(contactIdByAccountId.get(acc.Id)).size();\n} else {\nacc.Reference_Count__c -= tasksByContact.get(contactIdByAccountId.get(acc.Id)).size();\n}\n} else {\nacc.Reference_Count__c = tasksByContact.get(contactIdByAccountId.get(acc.Id)).size();\n}\n}\nupdate accountsRelatedToContactsForUpdate;\n}\u003c/p\u003e\n\u003cp\u003eprivate static void updateContacts(List\u0026#x3C;Contact\u003e relatedContactsForUpdateCountField,\nMap\u0026#x3C;Id, List\u0026#x3C;sObject\u003e\u003e tasksByContact,\nBoolean isIncrement) {\nfor (Contact cont: relatedContactsForUpdateCountField) {\nInteger amountOfNewTasks = tasksByContact.get(cont.Id).size();\nif (amountOfNewTasks \u003e 0) {\nif (cont.Reference_Count__c != null) {\nif (isIncrement) {\ncont.Reference_Count__c += amountOfNewTasks;\n} else {\ncont.Reference_Count__c -= amountOfNewTasks;\n}\n} else {\ncont.Reference_Count__c = amountOfNewTasks;\n}\n}\n}\nupdate relatedContactsForUpdateCountField;\n}\n[/java]\u003c/p\u003e\n\u003cp\u003eAlso we need this utility method for transformation list into map\u003c/p\u003e\n\u003cp\u003e[java]\npublic static Map\u0026#x3C;Id, List\u0026#x3C;sObject\u003e\u003e splitListBySpecialKey(List\u0026#x3C;sObject\u003e sourceList, String key) {\nif (sourceList == null) {\nthrow new IncorrectParameterException(‘ERROR: splitListBySpecialKey(sourceList, key) got incorrect first parameter.’);\n}\nif (String.isBlank(key)) {\nthrow new IncorrectParameterException(‘ERROR: splitListBySpecialKey(sourceList, key) got incorrect second parameter.’);\n}\nMap\u0026#x3C;Id, List\u0026#x3C;sObject\u003e\u003e result = new Map\u0026#x3C;Id, List\u0026#x3C;sObject\u003e\u003e();\nList\u0026#x3C;sObject\u003e tmpObjs;\nfor (sObject obj : sourceList) {\ntmpObjs = new List\u0026#x3C;sObject\u003e();\nif (obj.get(key) != null \u0026#x26;\u0026#x26; result.containsKey((Id)obj.get(key))) {\ntmpObjs = result.get((Id)obj.get(key));\ntmpObjs.add(obj);\nresult.put((Id)obj.get(key), tmpObjs);\n} else if (obj.get(key) != null) {\ntmpObjs.add(obj);\nresult.put((Id)obj.get(key), tmpObjs);\n}\n}\nreturn result;\n}\npublic class IncorrectParameterException extends System.Exception {}\n[/java]\u003c/p\u003e\n","title":"Calculate amount of specified task records which are related to Contact and Account in Salesforce","date":"2015-07-15T15:07:51+01:00","status":"publish","permalink":"/?p=501","author":"pavel","excerpt":"","type":"post","category":["apex","force.com","salesforce.com"],"tag":[],"post_format":[],"cleanretina_sidebarlayout":["default"],"dsq_thread_id":["5605961530"]}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"p501"},"buildId":"v48fJEESVsFENFnZJUUFQ","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-fa276ba060a4a8ac7eef.js"></script><script src="/_next/static/chunks/main-a7c970f167496c3f3d8f.js" async=""></script><script src="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" async=""></script><script src="/_next/static/chunks/framework.ef157c678a62cfb2c073.js" async=""></script><script src="/_next/static/chunks/commons.0cd3f0b406132b99fef1.js" async=""></script><script src="/_next/static/chunks/pages/_app-d4c4590d6f89b99d62f3.js" async=""></script><script src="/_next/static/chunks/1d62a1056678c2f23610de94ff6f49e06a569636.2116ac35632db79554b8.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-f26bd131465ef7dfa7da.js" async=""></script><script src="/_next/static/v48fJEESVsFENFnZJUUFQ/_buildManifest.js" async=""></script><script src="/_next/static/v48fJEESVsFENFnZJUUFQ/_ssgManifest.js" async=""></script></body></html>