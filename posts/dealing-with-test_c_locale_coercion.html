<!DOCTYPE html><html><head><meta charSet="utf-8"/><link rel="icon" href="/favicon.ico"/><link href="https://unpkg.com/prismjs@1.23.0/themes/prism-okaidia.css" rel="stylesheet"/><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="description" content="Pavel Slepenkov&#x27;s personal blog: stories about BI, python, salesforce and data analysis"/><meta http-equiv="cache-control" content="Private"/><meta http-equiv="Expires" content="366000"/><meta property="og:locale" content="en_US"/><meta name="og:title" content="Pavel Slepenkov&#x27;s personal blog"/><meta property="og:description" content="stories about BI, python, salesforce and data analysis"/><meta property="og:type" content="article"/><meta property="og:site_name" content="pavelslepenkov.info"/><meta property="og:image" content="/og.png"/><meta name="twitter:title" content="Pavel Slepenkov&#x27;s personal blog"/><meta name="twitter:description" content="stories about BI, python, salesforce and data analysis"/><meta name="twitter:card" content="summary_large_image"/><meta property="twitter:image" content="/og.png"/><meta name="keywords" content="python, BI, sql, salesforce, data engineering, apex, soql, data analisys"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-63037633-1"></script><script>
                            window.dataLayer = window.dataLayer || [];
                            function gtag(){dataLayer.push(arguments);}
                            gtag('js', new Date());
                            gtag('config', 'UA-63037633-1');
                    </script><style>@import url(&#x27;https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300&amp;family=Spectral:wght@300;600&amp;display=swap&#x27;);</style><title>Dealing with test_c_locale_coercion on macOS</title><meta name="next-head-count" content="23"/><link rel="preload" href="/_next/static/css/8ed85b7126e02c37.css" as="style"/><link rel="stylesheet" href="/_next/static/css/8ed85b7126e02c37.css" data-n-g=""/><link rel="preload" href="/_next/static/css/aded813adb12d848.css" as="style"/><link rel="stylesheet" href="/_next/static/css/aded813adb12d848.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-ee7e63bc15b31913.js" defer=""></script><script src="/_next/static/chunks/framework-ad45764ecfcae9e5.js" defer=""></script><script src="/_next/static/chunks/main-ee0cf4b7f81d7c24.js" defer=""></script><script src="/_next/static/chunks/pages/_app-2398585b21d2d8c8.js" defer=""></script><script src="/_next/static/chunks/105-51803cf0fd5a7825.js" defer=""></script><script src="/_next/static/chunks/358-14c60bb94e9d94b9.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-8fa7937364162cc4.js" defer=""></script><script src="/_next/static/MY7uO-B78ANSeQoj3y3y4/_buildManifest.js" defer=""></script><script src="/_next/static/MY7uO-B78ANSeQoj3y3y4/_ssgManifest.js" defer=""></script></head><body class="centered"><script src="noflash.js"></script><script src="PathSolver.js"></script><div id="__next"><div class="layout_container__fbLkO"><div class="no-print"><header class="layout_header__kY0Lt"><div class="navbar-link centered"><a class="layout_devNull__CjwH1" href="/">Technical notes</a>—————<a class="layout_devNull__CjwH1" href="/cv">CV</a>—————<a class="layout_devNull__CjwH1" href="/books">Books &amp; Readings</a></div><div class="DarkModeToggle_darkModeToggle__m5z3H"><button type="button">🌞</button><button type="button">🌚</button></div></header></div><main><article><h1 class="utils_headingXl__u25Y2">Dealing with test_c_locale_coercion on macOS</h1><div class="utils_lightText__eUzGY"><time dateTime="2021-03-09T07:55:20+00:00">March 9, 2021</time></div><div><p>Building python from source and playing around its internals is a good way to get your python's skill to the next level.
And <a href="https://devguide.python.org">Official Python Developer Guide</a> gets a great reference for a start. All you need is to make a copy of cpython repo, clone it to a local machine, configure and make. Here you go, your own custom built copy of python is here and you can use it just now.</p>
<p><img src="/images/p1071/1.png" alt=""></p>
<p>After a successful build you need to run test suites against your setup</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">./python <span class="token parameter variable">-m</span> <span class="token builtin class-name">test</span> <span class="token parameter variable">-j3</span>
</code></pre></div>
<p>It can take a solid amount of time but at the end you will got some result. My case was a multiple errors in test_c_locale_coercion</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">$ ./python.exe <span class="token parameter variable">-m</span> unittest <span class="token parameter variable">-v</span> test.test_c_locale_coercion.LocaleCoercionTests.test_PYTHONCOERCECLOCALE_set_to_warn
AVAILABLE_TARGETS <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'UTF-8'</span><span class="token punctuation">]</span>
EXPECTED_C_LOCALE_EQUIVALENTS <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'C'</span>, <span class="token string">'invalid.ascii'</span><span class="token punctuation">]</span>
EXPECTED_C_LOCALE_STREAM_ENCODING <span class="token operator">=</span> <span class="token string">'ascii'</span>
EXPECTED_C_LOCALE_FS_ENCODING <span class="token operator">=</span> <span class="token string">'utf-8'</span>
EXPECT_COERCION_IN_DEFAULT_LOCALE <span class="token operator">=</span> True
_C_UTF8_LOCALES <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'C.UTF-8'</span>, <span class="token string">'C.utf8'</span>, <span class="token string">'UTF-8'</span><span class="token punctuation">)</span>
_check_nl_langinfo_CODESET <span class="token operator">=</span> False
test_PYTHONCOERCECLOCALE_set_to_warn <span class="token punctuation">(</span>test.test_c_locale_coercion.LocaleCoercionTests<span class="token punctuation">)</span> <span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
FAIL: test_PYTHONCOERCECLOCALE_set_to_warn <span class="token punctuation">(</span>test.test_c_locale_coercion.LocaleCoercionTests<span class="token punctuation">)</span> <span class="token punctuation">(</span>default_locale<span class="token operator">=</span>True, <span class="token assign-left variable">PYTHONCOERCECLOCALE</span><span class="token operator">=</span><span class="token string">'warn'</span><span class="token punctuation">)</span>
----------------------------------------------------------------------
Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span>:
  File <span class="token string">"/Users/slepenkov/projects/cpython/Lib/test/test_c_locale_coercion.py"</span>, line <span class="token number">340</span>, <span class="token keyword">in</span> _check_c_locale_coercion
    self._check_child_encoding_details<span class="token punctuation">(</span>base_var_dict,
  File <span class="token string">"/Users/slepenkov/projects/cpython/Lib/test/test_c_locale_coercion.py"</span>, line <span class="token number">230</span>, <span class="token keyword">in</span> _check_child_encoding_details
    self.assertEqual<span class="token punctuation">(</span>encoding_details, expected_details<span class="token punctuation">)</span>
AssertionError: <span class="token punctuation">{</span><span class="token string">'fse[36 chars]f-8:strict'</span>, <span class="token string">'stdout_info'</span><span class="token builtin class-name">:</span> <span class="token string">'utf-8:strict'</span>, <span class="token string">'s[80 chars]: '</span>'<span class="token punctuation">}</span> <span class="token operator">!=</span> <span class="token punctuation">{</span><span class="token string">'fse[36 chars]f-8:surrogateescape'</span>, <span class="token string">'stdout_info'</span><span class="token builtin class-name">:</span> <span class="token string">'utf-8:su[98 chars]: '</span>'<span class="token punctuation">}</span>
  <span class="token punctuation">{</span><span class="token string">'fsencoding'</span><span class="token builtin class-name">:</span> <span class="token string">'utf-8'</span>,
   <span class="token string">'lang'</span><span class="token builtin class-name">:</span> <span class="token string">''</span>,
   <span class="token string">'lc_all'</span><span class="token builtin class-name">:</span> <span class="token string">''</span>,
   <span class="token string">'lc_ctype'</span><span class="token builtin class-name">:</span> <span class="token string">'UTF-8'</span>,
   <span class="token string">'stderr_info'</span><span class="token builtin class-name">:</span> <span class="token string">'utf-8:backslashreplace'</span>,
-  <span class="token string">'stdin_info'</span><span class="token builtin class-name">:</span> <span class="token string">'utf-8:strict'</span>,
?                         ^^ ^

+  <span class="token string">'stdin_info'</span><span class="token builtin class-name">:</span> <span class="token string">'utf-8:surrogateescape'</span>,
?                        ++++++ ^^^ ^^^

-  <span class="token string">'stdout_info'</span><span class="token builtin class-name">:</span> <span class="token string">'utf-8:strict'</span><span class="token punctuation">}</span>
?                          ^^ ^

+  <span class="token string">'stdout_info'</span><span class="token builtin class-name">:</span> <span class="token string">'utf-8:surrogateescape'</span><span class="token punctuation">}</span>
?                         ++++++ ^^^ ^^^
</code></pre></div>
<p>My first attempt to resolve my issue was googling. Soo smart.. :)</p>
<p>But because the topic is pretty specific and noone is discussing this on stackoverflow you will end up with a real pain because all you have to deal with now is a bunch of converstations between core developers in python bugtracker.
Something like <a href="https://bugs.python.org/issue41700">this</a>, <a href="https://bugs.python.org/issue32002">this</a> and <a href="https://bugs.python.org/issue30672">this</a>. Here's a bunch of text to read and debug messages to understand.</p>
<p>After a quick look to all these converstation it was clear that something is wrong with my setup. I've checked my locale's setting</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">$ locale
<span class="token assign-left variable"><span class="token environment constant">LANG</span></span><span class="token operator">=</span><span class="token string">"en_US.UTF-8"</span>
<span class="token assign-left variable">LC_COLLATE</span><span class="token operator">=</span><span class="token string">"en_US.UTF-8"</span>
<span class="token assign-left variable">LC_CTYPE</span><span class="token operator">=</span><span class="token string">"en_US.UTF-8"</span>
<span class="token assign-left variable">LC_MESSAGES</span><span class="token operator">=</span><span class="token string">"en_US.UTF-8"</span>
<span class="token assign-left variable"><span class="token environment constant">LC_MONETARY</span></span><span class="token operator">=</span><span class="token string">"en_US.UTF-8"</span>
<span class="token assign-left variable"><span class="token environment constant">LC_NUMERIC</span></span><span class="token operator">=</span><span class="token string">"en_US.UTF-8"</span>
<span class="token assign-left variable"><span class="token environment constant">LC_TIME</span></span><span class="token operator">=</span><span class="token string">"en_US.UTF-8"</span>
</code></pre></div>
<p>Playing with setting locale to <code>C.UTF-8</code> or <code>POSIX</code> changed nothing.</p>
<p>My next step was to quick run of docker container with alpine and <a href="https://devguide.python.org/setup/#build-dependencies">all required build dependencies</a> but it ended up with much more longer list of errors on test run, thus the container was terminated and I returned to local setup.</p>
<p>Next step was digging around all dot files in my home directory. If you have pretty old machine like mine (first setup on Nov 2016) and making changes to your configs often you end ups with long list of configurational files in you working directory. With bunch of changes over a time. Motivation of which you can't even remember.</p>
<p>Checking <code>.bashrc</code>, <code>.bash_profile</code> did not yield any results. But checking <code>.exports</code> which I installed from <a href="https://github.com/mathiasbynens/dotfiles/blob/main/.exports">dotfiles</a> a few years ago was the solution. <strong>I have found that apart from exporting LANG and LC_ALL this file also exports <code>PYTHONIOENCODING</code>.</strong> I have no idea how I hadn't noticed this environment variables was globally set. Removing this <code>export PYTHONIOENCODING='UTF-8';</code> from global export fixed the issue.</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">$  ./python.exe <span class="token parameter variable">-m</span> <span class="token builtin class-name">test</span> <span class="token parameter variable">-v</span> test_c_locale_coercion
<span class="token operator">==</span> CPython <span class="token number">3.10</span>.0a6+ <span class="token punctuation">(</span>heads/master:87ec26b812, Mar <span class="token number">7</span> <span class="token number">2021</span>, 09:09:41<span class="token punctuation">)</span> <span class="token punctuation">[</span>Clang <span class="token number">11.0</span>.0 <span class="token punctuation">(</span>clang-1100.0.33.8<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token operator">==</span> macOS-10.15.7-x86_64-i386-64bit little-endian
<span class="token operator">==</span> cwd: /Users/slepenkov/projects/cpython/build/test_python_56412æ
<span class="token operator">==</span> CPU count: <span class="token number">4</span>
<span class="token operator">==</span> encodings: <span class="token assign-left variable">locale</span><span class="token operator">=</span>UTF-8, <span class="token assign-left variable">FS</span><span class="token operator">=</span>utf-8
<span class="token number">0</span>:00:00 load avg: <span class="token number">2.17</span> Run tests sequentially
<span class="token number">0</span>:00:00 load avg: <span class="token number">2.17</span> <span class="token punctuation">[</span><span class="token number">1</span>/1<span class="token punctuation">]</span> test_c_locale_coercion
AVAILABLE_TARGETS <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'UTF-8'</span><span class="token punctuation">]</span>
EXPECTED_C_LOCALE_EQUIVALENTS <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'C'</span>, <span class="token string">'invalid.ascii'</span><span class="token punctuation">]</span>
EXPECTED_C_LOCALE_STREAM_ENCODING <span class="token operator">=</span> <span class="token string">'ascii'</span>
EXPECTED_C_LOCALE_FS_ENCODING <span class="token operator">=</span> <span class="token string">'utf-8'</span>
EXPECT_COERCION_IN_DEFAULT_LOCALE <span class="token operator">=</span> True
_C_UTF8_LOCALES <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'C.UTF-8'</span>, <span class="token string">'C.utf8'</span>, <span class="token string">'UTF-8'</span><span class="token punctuation">)</span>
_check_nl_langinfo_CODESET <span class="token operator">=</span> False
test_external_target_locale_configuration <span class="token punctuation">(</span>test.test_c_locale_coercion.LocaleConfigurationTests<span class="token punctuation">)</span> <span class="token punctuation">..</span>. ok
test_LC_ALL_set_to_C <span class="token punctuation">(</span>test.test_c_locale_coercion.LocaleCoercionTests<span class="token punctuation">)</span> <span class="token punctuation">..</span>. ok
test_PYTHONCOERCECLOCALE_not_set <span class="token punctuation">(</span>test.test_c_locale_coercion.LocaleCoercionTests<span class="token punctuation">)</span> <span class="token punctuation">..</span>. ok
test_PYTHONCOERCECLOCALE_not_zero <span class="token punctuation">(</span>test.test_c_locale_coercion.LocaleCoercionTests<span class="token punctuation">)</span> <span class="token punctuation">..</span>. ok
test_PYTHONCOERCECLOCALE_set_to_one <span class="token punctuation">(</span>test.test_c_locale_coercion.LocaleCoercionTests<span class="token punctuation">)</span> <span class="token punctuation">..</span>. skipped <span class="token string">'coerced LC_CTYPE locale: UTF-8'</span>
test_PYTHONCOERCECLOCALE_set_to_warn <span class="token punctuation">(</span>test.test_c_locale_coercion.LocaleCoercionTests<span class="token punctuation">)</span> <span class="token punctuation">..</span>. ok
test_PYTHONCOERCECLOCALE_set_to_zero <span class="token punctuation">(</span>test.test_c_locale_coercion.LocaleCoercionTests<span class="token punctuation">)</span> <span class="token punctuation">..</span>. ok

----------------------------------------------------------------------

Ran <span class="token number">7</span> tests <span class="token keyword">in</span> <span class="token number">3</span>.872s

OK <span class="token punctuation">(</span>skipped<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token operator">==</span> Tests result: SUCCESS <span class="token operator">==</span>

<span class="token number">1</span> <span class="token builtin class-name">test</span> OK.

Total duration: <span class="token number">4.2</span> sec
Tests result: SUCCESS
</code></pre></div>
<p>So, the most signinficant conclusion is <strong>Keep your working setup clean and make export only when you really need it</strong>. Usually I have PYTHONIOENCODING set on project level when it needed and it's done dynamically set via scripts and disappear just after virtual environment is deactivated.</p>
</div></article><div><span class="utils_tag__r8GDN"><a href="/tag/python">[<!-- -->python<!-- -->]</a></span><span class="utils_tag__r8GDN"><a href="/tag/cpython">[<!-- -->cpython<!-- -->]</a></span><span class="utils_tag__r8GDN"><a href="/tag/macOS">[<!-- -->macOS<!-- -->]</a></span></div></main><div class="layout_backToHome__9sjx_"><a href="/">⇐ back to home</a></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"dealing-with-test_c_locale_coercion","contentHtml":"\u003cp\u003eBuilding python from source and playing around its internals is a good way to get your python's skill to the next level.\nAnd \u003ca href=\"https://devguide.python.org\"\u003eOfficial Python Developer Guide\u003c/a\u003e gets a great reference for a start. All you need is to make a copy of cpython repo, clone it to a local machine, configure and make. Here you go, your own custom built copy of python is here and you can use it just now.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/p1071/1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003eAfter a successful build you need to run test suites against your setup\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e./python \u003cspan class=\"token parameter variable\"\u003e-m\u003c/span\u003e \u003cspan class=\"token builtin class-name\"\u003etest\u003c/span\u003e \u003cspan class=\"token parameter variable\"\u003e-j3\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eIt can take a solid amount of time but at the end you will got some result. My case was a multiple errors in test_c_locale_coercion\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e$ ./python.exe \u003cspan class=\"token parameter variable\"\u003e-m\u003c/span\u003e unittest \u003cspan class=\"token parameter variable\"\u003e-v\u003c/span\u003e test.test_c_locale_coercion.LocaleCoercionTests.test_PYTHONCOERCECLOCALE_set_to_warn\nAVAILABLE_TARGETS \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e'UTF-8'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\nEXPECTED_C_LOCALE_EQUIVALENTS \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e'C'\u003c/span\u003e, \u003cspan class=\"token string\"\u003e'invalid.ascii'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\nEXPECTED_C_LOCALE_STREAM_ENCODING \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e'ascii'\u003c/span\u003e\nEXPECTED_C_LOCALE_FS_ENCODING \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e'utf-8'\u003c/span\u003e\nEXPECT_COERCION_IN_DEFAULT_LOCALE \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e True\n_C_UTF8_LOCALES \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'C.UTF-8'\u003c/span\u003e, \u003cspan class=\"token string\"\u003e'C.utf8'\u003c/span\u003e, \u003cspan class=\"token string\"\u003e'UTF-8'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n_check_nl_langinfo_CODESET \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e False\ntest_PYTHONCOERCECLOCALE_set_to_warn \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etest.test_c_locale_coercion.LocaleCoercionTests\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e..\u003c/span\u003e.\n\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e\nFAIL: test_PYTHONCOERCECLOCALE_set_to_warn \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etest.test_c_locale_coercion.LocaleCoercionTests\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edefault_locale\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eTrue, \u003cspan class=\"token assign-left variable\"\u003ePYTHONCOERCECLOCALE\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e'warn'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n----------------------------------------------------------------------\nTraceback \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003emost recent call last\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e:\n  File \u003cspan class=\"token string\"\u003e\"/Users/slepenkov/projects/cpython/Lib/test/test_c_locale_coercion.py\"\u003c/span\u003e, line \u003cspan class=\"token number\"\u003e340\u003c/span\u003e, \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e _check_c_locale_coercion\n    self._check_child_encoding_details\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ebase_var_dict,\n  File \u003cspan class=\"token string\"\u003e\"/Users/slepenkov/projects/cpython/Lib/test/test_c_locale_coercion.py\"\u003c/span\u003e, line \u003cspan class=\"token number\"\u003e230\u003c/span\u003e, \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e _check_child_encoding_details\n    self.assertEqual\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eencoding_details, expected_details\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\nAssertionError: \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token string\"\u003e'fse[36 chars]f-8:strict'\u003c/span\u003e, \u003cspan class=\"token string\"\u003e'stdout_info'\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'utf-8:strict'\u003c/span\u003e, \u003cspan class=\"token string\"\u003e's[80 chars]: '\u003c/span\u003e'\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token string\"\u003e'fse[36 chars]f-8:surrogateescape'\u003c/span\u003e, \u003cspan class=\"token string\"\u003e'stdout_info'\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'utf-8:su[98 chars]: '\u003c/span\u003e'\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token string\"\u003e'fsencoding'\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'utf-8'\u003c/span\u003e,\n   \u003cspan class=\"token string\"\u003e'lang'\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e''\u003c/span\u003e,\n   \u003cspan class=\"token string\"\u003e'lc_all'\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e''\u003c/span\u003e,\n   \u003cspan class=\"token string\"\u003e'lc_ctype'\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'UTF-8'\u003c/span\u003e,\n   \u003cspan class=\"token string\"\u003e'stderr_info'\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'utf-8:backslashreplace'\u003c/span\u003e,\n-  \u003cspan class=\"token string\"\u003e'stdin_info'\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'utf-8:strict'\u003c/span\u003e,\n?                         ^^ ^\n\n+  \u003cspan class=\"token string\"\u003e'stdin_info'\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'utf-8:surrogateescape'\u003c/span\u003e,\n?                        ++++++ ^^^ ^^^\n\n-  \u003cspan class=\"token string\"\u003e'stdout_info'\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'utf-8:strict'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n?                          ^^ ^\n\n+  \u003cspan class=\"token string\"\u003e'stdout_info'\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'utf-8:surrogateescape'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n?                         ++++++ ^^^ ^^^\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eMy first attempt to resolve my issue was googling. Soo smart.. :)\u003c/p\u003e\n\u003cp\u003eBut because the topic is pretty specific and noone is discussing this on stackoverflow you will end up with a real pain because all you have to deal with now is a bunch of converstations between core developers in python bugtracker.\nSomething like \u003ca href=\"https://bugs.python.org/issue41700\"\u003ethis\u003c/a\u003e, \u003ca href=\"https://bugs.python.org/issue32002\"\u003ethis\u003c/a\u003e and \u003ca href=\"https://bugs.python.org/issue30672\"\u003ethis\u003c/a\u003e. Here's a bunch of text to read and debug messages to understand.\u003c/p\u003e\n\u003cp\u003eAfter a quick look to all these converstation it was clear that something is wrong with my setup. I've checked my locale's setting\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e$ locale\n\u003cspan class=\"token assign-left variable\"\u003e\u003cspan class=\"token environment constant\"\u003eLANG\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"en_US.UTF-8\"\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003eLC_COLLATE\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"en_US.UTF-8\"\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003eLC_CTYPE\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"en_US.UTF-8\"\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003eLC_MESSAGES\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"en_US.UTF-8\"\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003e\u003cspan class=\"token environment constant\"\u003eLC_MONETARY\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"en_US.UTF-8\"\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003e\u003cspan class=\"token environment constant\"\u003eLC_NUMERIC\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"en_US.UTF-8\"\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003e\u003cspan class=\"token environment constant\"\u003eLC_TIME\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"en_US.UTF-8\"\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003ePlaying with setting locale to \u003ccode\u003eC.UTF-8\u003c/code\u003e or \u003ccode\u003ePOSIX\u003c/code\u003e changed nothing.\u003c/p\u003e\n\u003cp\u003eMy next step was to quick run of docker container with alpine and \u003ca href=\"https://devguide.python.org/setup/#build-dependencies\"\u003eall required build dependencies\u003c/a\u003e but it ended up with much more longer list of errors on test run, thus the container was terminated and I returned to local setup.\u003c/p\u003e\n\u003cp\u003eNext step was digging around all dot files in my home directory. If you have pretty old machine like mine (first setup on Nov 2016) and making changes to your configs often you end ups with long list of configurational files in you working directory. With bunch of changes over a time. Motivation of which you can't even remember.\u003c/p\u003e\n\u003cp\u003eChecking \u003ccode\u003e.bashrc\u003c/code\u003e, \u003ccode\u003e.bash_profile\u003c/code\u003e did not yield any results. But checking \u003ccode\u003e.exports\u003c/code\u003e which I installed from \u003ca href=\"https://github.com/mathiasbynens/dotfiles/blob/main/.exports\"\u003edotfiles\u003c/a\u003e a few years ago was the solution. \u003cstrong\u003eI have found that apart from exporting LANG and LC_ALL this file also exports \u003ccode\u003ePYTHONIOENCODING\u003c/code\u003e.\u003c/strong\u003e I have no idea how I hadn't noticed this environment variables was globally set. Removing this \u003ccode\u003eexport PYTHONIOENCODING='UTF-8';\u003c/code\u003e from global export fixed the issue.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e$  ./python.exe \u003cspan class=\"token parameter variable\"\u003e-m\u003c/span\u003e \u003cspan class=\"token builtin class-name\"\u003etest\u003c/span\u003e \u003cspan class=\"token parameter variable\"\u003e-v\u003c/span\u003e test_c_locale_coercion\n\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e CPython \u003cspan class=\"token number\"\u003e3.10\u003c/span\u003e.0a6+ \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eheads/master:87ec26b812, Mar \u003cspan class=\"token number\"\u003e7\u003c/span\u003e \u003cspan class=\"token number\"\u003e2021\u003c/span\u003e, 09:09:41\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eClang \u003cspan class=\"token number\"\u003e11.0\u003c/span\u003e.0 \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eclang-1100.0.33.8\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e macOS-10.15.7-x86_64-i386-64bit little-endian\n\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e cwd: /Users/slepenkov/projects/cpython/build/test_python_56412æ\n\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e CPU count: \u003cspan class=\"token number\"\u003e4\u003c/span\u003e\n\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e encodings: \u003cspan class=\"token assign-left variable\"\u003elocale\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eUTF-8, \u003cspan class=\"token assign-left variable\"\u003eFS\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eutf-8\n\u003cspan class=\"token number\"\u003e0\u003c/span\u003e:00:00 load avg: \u003cspan class=\"token number\"\u003e2.17\u003c/span\u003e Run tests sequentially\n\u003cspan class=\"token number\"\u003e0\u003c/span\u003e:00:00 load avg: \u003cspan class=\"token number\"\u003e2.17\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e/1\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e test_c_locale_coercion\nAVAILABLE_TARGETS \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e'UTF-8'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\nEXPECTED_C_LOCALE_EQUIVALENTS \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e'C'\u003c/span\u003e, \u003cspan class=\"token string\"\u003e'invalid.ascii'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\nEXPECTED_C_LOCALE_STREAM_ENCODING \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e'ascii'\u003c/span\u003e\nEXPECTED_C_LOCALE_FS_ENCODING \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e'utf-8'\u003c/span\u003e\nEXPECT_COERCION_IN_DEFAULT_LOCALE \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e True\n_C_UTF8_LOCALES \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'C.UTF-8'\u003c/span\u003e, \u003cspan class=\"token string\"\u003e'C.utf8'\u003c/span\u003e, \u003cspan class=\"token string\"\u003e'UTF-8'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n_check_nl_langinfo_CODESET \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e False\ntest_external_target_locale_configuration \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etest.test_c_locale_coercion.LocaleConfigurationTests\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e..\u003c/span\u003e. ok\ntest_LC_ALL_set_to_C \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etest.test_c_locale_coercion.LocaleCoercionTests\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e..\u003c/span\u003e. ok\ntest_PYTHONCOERCECLOCALE_not_set \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etest.test_c_locale_coercion.LocaleCoercionTests\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e..\u003c/span\u003e. ok\ntest_PYTHONCOERCECLOCALE_not_zero \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etest.test_c_locale_coercion.LocaleCoercionTests\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e..\u003c/span\u003e. ok\ntest_PYTHONCOERCECLOCALE_set_to_one \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etest.test_c_locale_coercion.LocaleCoercionTests\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e..\u003c/span\u003e. skipped \u003cspan class=\"token string\"\u003e'coerced LC_CTYPE locale: UTF-8'\u003c/span\u003e\ntest_PYTHONCOERCECLOCALE_set_to_warn \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etest.test_c_locale_coercion.LocaleCoercionTests\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e..\u003c/span\u003e. ok\ntest_PYTHONCOERCECLOCALE_set_to_zero \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etest.test_c_locale_coercion.LocaleCoercionTests\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e..\u003c/span\u003e. ok\n\n----------------------------------------------------------------------\n\nRan \u003cspan class=\"token number\"\u003e7\u003c/span\u003e tests \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e \u003cspan class=\"token number\"\u003e3\u003c/span\u003e.872s\n\nOK \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eskipped\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e Tests result: SUCCESS \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e\n\n\u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token builtin class-name\"\u003etest\u003c/span\u003e OK.\n\nTotal duration: \u003cspan class=\"token number\"\u003e4.2\u003c/span\u003e sec\nTests result: SUCCESS\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eSo, the most signinficant conclusion is \u003cstrong\u003eKeep your working setup clean and make export only when you really need it\u003c/strong\u003e. Usually I have PYTHONIOENCODING set on project level when it needed and it's done dynamically set via scripts and disappear just after virtual environment is deactivated.\u003c/p\u003e\n","title":"Dealing with test_c_locale_coercion on macOS","date":"2021-03-09T07:55:20+00:00","status":"publish","permalink":"/?p=1071","author":"pavel","excerpt":"","type":"post","tag":["python","cpython","macOS"]}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"dealing-with-test_c_locale_coercion"},"buildId":"MY7uO-B78ANSeQoj3y3y4","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>