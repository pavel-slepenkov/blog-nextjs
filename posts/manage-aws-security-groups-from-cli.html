<!DOCTYPE html><html><head><meta charSet="utf-8"/><link rel="icon" href="/favicon.ico"/><link href="https://unpkg.com/prismjs@1.23.0/themes/prism-okaidia.css" rel="stylesheet"/><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="description" content="Pavel Slepenkov&#x27;s personal blog: stories about BI, python, salesforce and data analysis"/><meta http-equiv="cache-control" content="Private"/><meta http-equiv="Expires" content="366000"/><meta property="og:locale" content="en_US"/><meta name="og:title" content="Pavel Slepenkov&#x27;s personal blog"/><meta property="og:description" content="stories about BI, python, salesforce and data analysis"/><meta property="og:type" content="article"/><meta property="og:site_name" content="pavelslepenkov.info"/><meta property="og:image" content="/og.png"/><meta name="twitter:title" content="Pavel Slepenkov&#x27;s personal blog"/><meta name="twitter:description" content="stories about BI, python, salesforce and data analysis"/><meta name="twitter:card" content="summary_large_image"/><meta property="twitter:image" content="/og.png"/><meta name="keywords" content="python, BI, sql, salesforce, data engineering, apex, soql, data analisys"/><meta name="yandex-verification" content="35a3887ea995a4c4"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-63037633-1"></script><script>
                            window.dataLayer = window.dataLayer || [];
                            function gtag(){dataLayer.push(arguments);}
                            gtag('js', new Date());
                            gtag('config', 'UA-63037633-1');
                    </script><style>@import url(&#x27;https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300&amp;family=Spectral:wght@300;600&amp;display=swap&#x27;);</style><title>Manage AWS security groups with AWS CLI and bash</title><meta name="next-head-count" content="24"/><link rel="preload" href="/_next/static/css/8bd346a53c7aa18db3e6.css" as="style"/><link rel="stylesheet" href="/_next/static/css/8bd346a53c7aa18db3e6.css" data-n-g=""/><link rel="preload" href="/_next/static/css/6dce80f39b6e217927f5.css" as="style"/><link rel="stylesheet" href="/_next/static/css/6dce80f39b6e217927f5.css" data-n-p=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-d99e70035f31fbf26280.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.ef157c678a62cfb2c073.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.0cd3f0b406132b99fef1.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-03498b09f93ab4bd74a9.js" as="script"/><link rel="preload" href="/_next/static/chunks/b435696c38dfa3a566dd7089f731d08d7e0bf097.f940d483b5a1fae10b21.js" as="script"/><link rel="preload" href="/_next/static/chunks/1d62a1056678c2f23610de94ff6f49e06a569636.b588272bed0c9114d503.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5Bid%5D-dd3e2b826f95ad4c71da.js" as="script"/></head><body><script src="noflash.js"></script><script src="PathSolver.js"></script><div id="__next"><div class="layout_container__2t4v2"><div class="no-print"><header class="layout_header__2rhWq"><div class="navbar-link"><a class="layout_devNull__6Fs9d" href="/">$ /dev/null</a>—————<a class="layout_devNull__6Fs9d" href="/cv">CV</a></div><div class="DarkModeToggle_darkModeToggle__2u4u3"><button type="button">☀</button><toggle></toggle><button type="button">☾</button></div></header></div><main><article><h1 class="utils_headingXl__1XecN">Manage AWS security groups with AWS CLI and bash</h1><div class="utils_lightText__12Ckm"><time dateTime="2021-05-31T12:45:00+00:00">May 31, 2021</time></div><div><p>Securing your account is one of the first actions you need to take on any IT environment you manage.
When it comes to a remote work you might often need to switch places from where you're working, or your home network can be using a dynamic IP address.</p>
<p><ps1>VPN</ps1> is preferable solution to access a work network first and then connect to any resources you need in AWS. But sometime it's just convinient to whitelist your current IP address directly in AWS. Unstable VPN connection might be the example of such circumstances.</p>
<p>One way to do so is to edit inbound rules via AWS management console. It works if you need to modify just one security group with a few ports. But when you need to add a several ports into several groups there're too many clicks.  So, let's automate it.</p>
<p>If you're working with AWS you'd probably have <strong>aws cli</strong> installed on your machine. If not, you have to install it. It's increadibly useful tool for AWS management. For our task we need just 2 commands</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">aws ec2 authorize-security-group-ingress
aws ec2 revoke-security-group-ingress
</code></pre></div>
<p>Its names are self-descriptive so a problem might appear only with dynamic content. First we need our IP address which we would like to add to a security group. Another thing which we'd like to have is dynamic group description which allows to distinguish security rules in AWS console.
I have an alias for obtaining my current IP address in my <strong>.bashrc</strong></p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash"><span class="token builtin class-name">alias</span> <span class="token assign-left variable">ip</span><span class="token operator">=</span><span class="token string">'dig +short myip.opendns.com @resolver1.opendns.com'</span>
</code></pre></div>
<p>I will generate description with just adding a date, so adding my current IP address to the security group with access on 22 port looks like this</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">aws ec2 authorize-security-group-ingress <span class="token punctuation">\</span>
    --group-name <span class="token string">"securityGroupName"</span> <span class="token punctuation">\</span>
    --ip-permissions <span class="token assign-left variable">IpProtocol</span><span class="token operator">=</span>tcp,FromPort<span class="token operator">=</span><span class="token number">22</span>,ToPort<span class="token operator">=</span><span class="token number">22</span>,IpRanges<span class="token operator">=</span><span class="token string">"<span class="token variable">$eval</span> [{CidrIp="</span><span class="token variable"><span class="token variable">$(</span><span class="token function">ip</span><span class="token variable">)</span></span>/32<span class="token string">", Description="</span>Pavel__<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%F<span class="token variable">)</span></span>__tmp<span class="token string">"}]"</span> <span class="token punctuation">\</span>
    --output text
</code></pre></div>
<p>Removing address from a security group requires a name of security group, port and IP address which we're removing</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">aws ec2 revoke-security-group-ingress --group-name <span class="token string">"securityGroupName"</span> --protocol tcp --port <span class="token number">22</span> --cidr <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">ip</span><span class="token variable">)</span></span>/32"</span>
</code></pre></div>
<p>With this knowledge we can develop a short bash script which will do all the work for us.
Basically we just need to add current address to a security groups we want and remove old ones. In order to know the old IP we need to store it somewhere. File in the same directory looks good.</p>
<p><strong>Final script looks like that</strong></p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash"><span class="token shebang important">#! /bin/bash</span>
<span class="token comment"># create empty file if the file doesn't exist</span>
<span class="token assign-left variable">filename</span><span class="token operator">=</span><span class="token string">'ips_in_aws.txt'</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -e <span class="token string">"<span class="token variable">$filename</span>"</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token function">touch</span> <span class="token string">"<span class="token variable">$filename</span>"</span>
<span class="token keyword">fi</span>
<span class="token comment"># get previous run IP from a file</span>
<span class="token keyword">while</span> <span class="token builtin class-name">read</span> p<span class="token punctuation">;</span> <span class="token keyword">do</span>
    <span class="token assign-left variable">old_ip</span><span class="token operator">=</span><span class="token variable">$p</span>
<span class="token keyword">done</span> <span class="token operator">&#x3C;</span> <span class="token variable">$filename</span>
<span class="token builtin class-name">echo</span> <span class="token string">"old ip     = <span class="token variable">$old_ip</span>"</span>
<span class="token assign-left variable">current_ip</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">ip</span><span class="token variable">)</span></span>
<span class="token builtin class-name">echo</span> <span class="token string">"current ip = <span class="token variable">$current_ip</span>"</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$old_ip</span> <span class="token operator">==</span> <span class="token string">""</span> <span class="token operator">||</span> <span class="token variable">$old_ip</span> <span class="token operator">!=</span> <span class="token variable">$current_ip</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"save new IP to the file"</span>
    <span class="token builtin class-name">echo</span> <span class="token variable">$current_ip</span> <span class="token operator">>></span> ips_in_aws.txt
    <span class="token comment"># ssh access</span>
    <span class="token keyword">for</span> <span class="token for-or-select variable">groupName</span> <span class="token keyword">in</span> <span class="token string">"sec_group1_name"</span> <span class="token string">"sec_group2_name"</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
        <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$old_ip</span> <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
            <span class="token builtin class-name">echo</span> <span class="token string">"remove old IP from <span class="token variable">$groupName</span>"</span>
            aws ec2 revoke-security-group-ingress --group-name <span class="token string">"<span class="token variable">$groupName</span>"</span> --protocol tcp --port <span class="token number">22</span> --cidr <span class="token string">"<span class="token variable">$old_ip</span>/32"</span>
        <span class="token keyword">fi</span>
        <span class="token builtin class-name">echo</span> <span class="token string">"add rule for <span class="token variable">$current_ip</span> to <span class="token variable">$groupName</span>"</span>
        aws ec2 authorize-security-group-ingress --group-name <span class="token string">"<span class="token variable">$groupName</span>"</span> --ip-permissions <span class="token assign-left variable">IpProtocol</span><span class="token operator">=</span>tcp,FromPort<span class="token operator">=</span><span class="token number">22</span>,ToPort<span class="token operator">=</span><span class="token number">22</span>,IpRanges<span class="token operator">=</span><span class="token string">"<span class="token variable">$eval</span> [{CidrIp="</span><span class="token variable">$current_ip</span>/32<span class="token string">", Description="</span>Pavel__<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%F<span class="token variable">)</span></span>__tmp<span class="token string">"}]"</span> --output text
    <span class="token keyword">done</span>
    <span class="token comment"># remove old IP from security groups</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$old_ip</span> <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        aws ec2 revoke-security-group-ingress --group-name <span class="token string">"sec_group1_name"</span> --protocol tcp --port <span class="token number">5432</span> --cidr <span class="token string">"<span class="token variable">$old_ip</span>/32"</span>
        aws ec2 revoke-security-group-ingress --group-name <span class="token string">"sec_group2_name"</span> --protocol tcp --port <span class="token number">443</span> --cidr <span class="token string">"<span class="token variable">$old_ip</span>/32"</span>
        aws ec2 revoke-security-group-ingress --group-name <span class="token string">"sec_group3_name"</span> --protocol tcp --port <span class="token number">5439</span> --cidr <span class="token string">"<span class="token variable">$old_ip</span>/32"</span>
    <span class="token keyword">fi</span>
    <span class="token comment"># Postgres, Redshift and web access</span>
    aws ec2 authorize-security-group-ingress --group-name <span class="token string">"sec_group3_name"</span> --ip-permissions <span class="token assign-left variable">IpProtocol</span><span class="token operator">=</span>tcp,FromPort<span class="token operator">=</span><span class="token number">5439</span>,ToPort<span class="token operator">=</span><span class="token number">5439</span>,IpRanges<span class="token operator">=</span><span class="token string">"<span class="token variable">$eval</span> [{CidrIp="</span><span class="token variable">$current_ip</span>/32<span class="token string">", Description="</span>Pavel__<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%F<span class="token variable">)</span></span>__tmp<span class="token string">"}]"</span> --output text
    aws ec2 authorize-security-group-ingress --group-name <span class="token string">"sec_group1_name"</span> --ip-permissions <span class="token assign-left variable">IpProtocol</span><span class="token operator">=</span>tcp,FromPort<span class="token operator">=</span><span class="token number">5432</span>,ToPort<span class="token operator">=</span><span class="token number">5432</span>,IpRanges<span class="token operator">=</span><span class="token string">"<span class="token variable">$eval</span> [{CidrIp="</span><span class="token variable">$current_ip</span>/32<span class="token string">", Description="</span>Pavel__<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%F<span class="token variable">)</span></span>__tmp<span class="token string">"}]"</span> --output text
    aws ec2 authorize-security-group-ingress --group-name <span class="token string">"sec_group2_name"</span> --ip-permissions <span class="token assign-left variable">IpProtocol</span><span class="token operator">=</span>tcp,FromPort<span class="token operator">=</span><span class="token number">443</span>,ToPort<span class="token operator">=</span><span class="token number">443</span>,IpRanges<span class="token operator">=</span><span class="token string">"<span class="token variable">$eval</span> [{CidrIp="</span><span class="token variable">$current_ip</span>/32<span class="token string">", Description="</span>Pavel__<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%F<span class="token variable">)</span></span>__tmp<span class="token string">"}]"</span> --output text
<span class="token keyword">else</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"IPs are the same, exit"</span>
<span class="token keyword">fi</span>
</code></pre></div>
<p>After running the script you get IP added to specified security groups</p>
</div></article><div><span class="utils_tag__38-Vr"><a href="/tag/aws">[<!-- -->aws<!-- -->]</a></span><span class="utils_tag__38-Vr"><a href="/tag/bash">[<!-- -->bash<!-- -->]</a></span><span class="utils_tag__38-Vr"><a href="/tag/security">[<!-- -->security<!-- -->]</a></span></div></main><div class="layout_backToHome__1vZsp"><a href="/">⇐ back to home</a></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"manage-aws-security-groups-from-cli","contentHtml":"\u003cp\u003eSecuring your account is one of the first actions you need to take on any IT environment you manage.\nWhen it comes to a remote work you might often need to switch places from where you're working, or your home network can be using a dynamic IP address.\u003c/p\u003e\n\u003cp\u003e\u003cps1\u003eVPN\u003c/ps1\u003e is preferable solution to access a work network first and then connect to any resources you need in AWS. But sometime it's just convinient to whitelist your current IP address directly in AWS. Unstable VPN connection might be the example of such circumstances.\u003c/p\u003e\n\u003cp\u003eOne way to do so is to edit inbound rules via AWS management console. It works if you need to modify just one security group with a few ports. But when you need to add a several ports into several groups there're too many clicks.  So, let's automate it.\u003c/p\u003e\n\u003cp\u003eIf you're working with AWS you'd probably have \u003cstrong\u003eaws cli\u003c/strong\u003e installed on your machine. If not, you have to install it. It's increadibly useful tool for AWS management. For our task we need just 2 commands\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003eaws ec2 authorize-security-group-ingress\naws ec2 revoke-security-group-ingress\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eIts names are self-descriptive so a problem might appear only with dynamic content. First we need our IP address which we would like to add to a security group. Another thing which we'd like to have is dynamic group description which allows to distinguish security rules in AWS console.\nI have an alias for obtaining my current IP address in my \u003cstrong\u003e.bashrc\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"token builtin class-name\"\u003ealias\u003c/span\u003e \u003cspan class=\"token assign-left variable\"\u003eip\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e'dig +short myip.opendns.com @resolver1.opendns.com'\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eI will generate description with just adding a date, so adding my current IP address to the security group with access on 22 port looks like this\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003eaws ec2 authorize-security-group-ingress \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n    --group-name \u003cspan class=\"token string\"\u003e\"securityGroupName\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n    --ip-permissions \u003cspan class=\"token assign-left variable\"\u003eIpProtocol\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003etcp,FromPort\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e22\u003c/span\u003e,ToPort\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e22\u003c/span\u003e,IpRanges\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token variable\"\u003e$eval\u003c/span\u003e [{CidrIp=\"\u003c/span\u003e\u003cspan class=\"token variable\"\u003e\u003cspan class=\"token variable\"\u003e$(\u003c/span\u003e\u003cspan class=\"token function\"\u003eip\u003c/span\u003e\u003cspan class=\"token variable\"\u003e)\u003c/span\u003e\u003c/span\u003e/32\u003cspan class=\"token string\"\u003e\", Description=\"\u003c/span\u003ePavel__\u003cspan class=\"token variable\"\u003e\u003cspan class=\"token variable\"\u003e$(\u003c/span\u003e\u003cspan class=\"token function\"\u003edate\u003c/span\u003e +%F\u003cspan class=\"token variable\"\u003e)\u003c/span\u003e\u003c/span\u003e__tmp\u003cspan class=\"token string\"\u003e\"}]\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n    --output text\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eRemoving address from a security group requires a name of security group, port and IP address which we're removing\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003eaws ec2 revoke-security-group-ingress --group-name \u003cspan class=\"token string\"\u003e\"securityGroupName\"\u003c/span\u003e --protocol tcp --port \u003cspan class=\"token number\"\u003e22\u003c/span\u003e --cidr \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token variable\"\u003e\u003cspan class=\"token variable\"\u003e$(\u003c/span\u003e\u003cspan class=\"token function\"\u003eip\u003c/span\u003e\u003cspan class=\"token variable\"\u003e)\u003c/span\u003e\u003c/span\u003e/32\"\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eWith this knowledge we can develop a short bash script which will do all the work for us.\nBasically we just need to add current address to a security groups we want and remove old ones. In order to know the old IP we need to store it somewhere. File in the same directory looks good.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eFinal script looks like that\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"token shebang important\"\u003e#! /bin/bash\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# create empty file if the file doesn't exist\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003efilename\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e'ips_in_aws.txt'\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e \u003cspan class=\"token operator\"\u003e!\u003c/span\u003e -e \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token variable\"\u003e$filename\u003c/span\u003e\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethen\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003etouch\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token variable\"\u003e$filename\u003c/span\u003e\"\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efi\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# get previous run IP from a file\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003ewhile\u003c/span\u003e \u003cspan class=\"token builtin class-name\"\u003eread\u003c/span\u003e p\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token keyword\"\u003edo\u003c/span\u003e\n    \u003cspan class=\"token assign-left variable\"\u003eold_ip\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$p\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003edone\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$filename\u003c/span\u003e\n\u003cspan class=\"token builtin class-name\"\u003eecho\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"old ip     = \u003cspan class=\"token variable\"\u003e$old_ip\u003c/span\u003e\"\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003ecurrent_ip\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token variable\"\u003e\u003cspan class=\"token variable\"\u003e$(\u003c/span\u003e\u003cspan class=\"token function\"\u003eip\u003c/span\u003e\u003cspan class=\"token variable\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token builtin class-name\"\u003eecho\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"current ip = \u003cspan class=\"token variable\"\u003e$current_ip\u003c/span\u003e\"\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$old_ip\u003c/span\u003e \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e||\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$old_ip\u003c/span\u003e \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$current_ip\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethen\u003c/span\u003e\n    \u003cspan class=\"token builtin class-name\"\u003eecho\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"save new IP to the file\"\u003c/span\u003e\n    \u003cspan class=\"token builtin class-name\"\u003eecho\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$current_ip\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u003e\u003e\u003c/span\u003e ips_in_aws.txt\n    \u003cspan class=\"token comment\"\u003e# ssh access\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token for-or-select variable\"\u003egroupName\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"sec_group1_name\"\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"sec_group2_name\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token keyword\"\u003edo\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$old_ip\u003c/span\u003e \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethen\u003c/span\u003e\n            \u003cspan class=\"token builtin class-name\"\u003eecho\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"remove old IP from \u003cspan class=\"token variable\"\u003e$groupName\u003c/span\u003e\"\u003c/span\u003e\n            aws ec2 revoke-security-group-ingress --group-name \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token variable\"\u003e$groupName\u003c/span\u003e\"\u003c/span\u003e --protocol tcp --port \u003cspan class=\"token number\"\u003e22\u003c/span\u003e --cidr \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token variable\"\u003e$old_ip\u003c/span\u003e/32\"\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003efi\u003c/span\u003e\n        \u003cspan class=\"token builtin class-name\"\u003eecho\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"add rule for \u003cspan class=\"token variable\"\u003e$current_ip\u003c/span\u003e to \u003cspan class=\"token variable\"\u003e$groupName\u003c/span\u003e\"\u003c/span\u003e\n        aws ec2 authorize-security-group-ingress --group-name \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token variable\"\u003e$groupName\u003c/span\u003e\"\u003c/span\u003e --ip-permissions \u003cspan class=\"token assign-left variable\"\u003eIpProtocol\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003etcp,FromPort\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e22\u003c/span\u003e,ToPort\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e22\u003c/span\u003e,IpRanges\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token variable\"\u003e$eval\u003c/span\u003e [{CidrIp=\"\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$current_ip\u003c/span\u003e/32\u003cspan class=\"token string\"\u003e\", Description=\"\u003c/span\u003ePavel__\u003cspan class=\"token variable\"\u003e\u003cspan class=\"token variable\"\u003e$(\u003c/span\u003e\u003cspan class=\"token function\"\u003edate\u003c/span\u003e +%F\u003cspan class=\"token variable\"\u003e)\u003c/span\u003e\u003c/span\u003e__tmp\u003cspan class=\"token string\"\u003e\"}]\"\u003c/span\u003e --output text\n    \u003cspan class=\"token keyword\"\u003edone\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e# remove old IP from security groups\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$old_ip\u003c/span\u003e \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethen\u003c/span\u003e\n        aws ec2 revoke-security-group-ingress --group-name \u003cspan class=\"token string\"\u003e\"sec_group1_name\"\u003c/span\u003e --protocol tcp --port \u003cspan class=\"token number\"\u003e5432\u003c/span\u003e --cidr \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token variable\"\u003e$old_ip\u003c/span\u003e/32\"\u003c/span\u003e\n        aws ec2 revoke-security-group-ingress --group-name \u003cspan class=\"token string\"\u003e\"sec_group2_name\"\u003c/span\u003e --protocol tcp --port \u003cspan class=\"token number\"\u003e443\u003c/span\u003e --cidr \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token variable\"\u003e$old_ip\u003c/span\u003e/32\"\u003c/span\u003e\n        aws ec2 revoke-security-group-ingress --group-name \u003cspan class=\"token string\"\u003e\"sec_group3_name\"\u003c/span\u003e --protocol tcp --port \u003cspan class=\"token number\"\u003e5439\u003c/span\u003e --cidr \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token variable\"\u003e$old_ip\u003c/span\u003e/32\"\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003efi\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e# Postgres, Redshift and web access\u003c/span\u003e\n    aws ec2 authorize-security-group-ingress --group-name \u003cspan class=\"token string\"\u003e\"sec_group3_name\"\u003c/span\u003e --ip-permissions \u003cspan class=\"token assign-left variable\"\u003eIpProtocol\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003etcp,FromPort\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e5439\u003c/span\u003e,ToPort\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e5439\u003c/span\u003e,IpRanges\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token variable\"\u003e$eval\u003c/span\u003e [{CidrIp=\"\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$current_ip\u003c/span\u003e/32\u003cspan class=\"token string\"\u003e\", Description=\"\u003c/span\u003ePavel__\u003cspan class=\"token variable\"\u003e\u003cspan class=\"token variable\"\u003e$(\u003c/span\u003e\u003cspan class=\"token function\"\u003edate\u003c/span\u003e +%F\u003cspan class=\"token variable\"\u003e)\u003c/span\u003e\u003c/span\u003e__tmp\u003cspan class=\"token string\"\u003e\"}]\"\u003c/span\u003e --output text\n    aws ec2 authorize-security-group-ingress --group-name \u003cspan class=\"token string\"\u003e\"sec_group1_name\"\u003c/span\u003e --ip-permissions \u003cspan class=\"token assign-left variable\"\u003eIpProtocol\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003etcp,FromPort\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e5432\u003c/span\u003e,ToPort\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e5432\u003c/span\u003e,IpRanges\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token variable\"\u003e$eval\u003c/span\u003e [{CidrIp=\"\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$current_ip\u003c/span\u003e/32\u003cspan class=\"token string\"\u003e\", Description=\"\u003c/span\u003ePavel__\u003cspan class=\"token variable\"\u003e\u003cspan class=\"token variable\"\u003e$(\u003c/span\u003e\u003cspan class=\"token function\"\u003edate\u003c/span\u003e +%F\u003cspan class=\"token variable\"\u003e)\u003c/span\u003e\u003c/span\u003e__tmp\u003cspan class=\"token string\"\u003e\"}]\"\u003c/span\u003e --output text\n    aws ec2 authorize-security-group-ingress --group-name \u003cspan class=\"token string\"\u003e\"sec_group2_name\"\u003c/span\u003e --ip-permissions \u003cspan class=\"token assign-left variable\"\u003eIpProtocol\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003etcp,FromPort\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e443\u003c/span\u003e,ToPort\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e443\u003c/span\u003e,IpRanges\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token variable\"\u003e$eval\u003c/span\u003e [{CidrIp=\"\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$current_ip\u003c/span\u003e/32\u003cspan class=\"token string\"\u003e\", Description=\"\u003c/span\u003ePavel__\u003cspan class=\"token variable\"\u003e\u003cspan class=\"token variable\"\u003e$(\u003c/span\u003e\u003cspan class=\"token function\"\u003edate\u003c/span\u003e +%F\u003cspan class=\"token variable\"\u003e)\u003c/span\u003e\u003c/span\u003e__tmp\u003cspan class=\"token string\"\u003e\"}]\"\u003c/span\u003e --output text\n\u003cspan class=\"token keyword\"\u003eelse\u003c/span\u003e\n    \u003cspan class=\"token builtin class-name\"\u003eecho\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"IPs are the same, exit\"\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efi\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAfter running the script you get IP added to specified security groups\u003c/p\u003e\n","title":"Manage AWS security groups with AWS CLI and bash","date":"2021-05-31T12:45:00+00:00","status":"publish","permalink":"/?p=1074","author":"pavel","excerpt":"","type":"post","tag":["aws","bash","security"]}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"manage-aws-security-groups-from-cli"},"buildId":"UYsP1Gx-Z9tLBnJUIbjeF","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-83732ebf2ed7f8a1b2c7.js"></script><script src="/_next/static/chunks/main-d99e70035f31fbf26280.js" async=""></script><script src="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" async=""></script><script src="/_next/static/chunks/framework.ef157c678a62cfb2c073.js" async=""></script><script src="/_next/static/chunks/commons.0cd3f0b406132b99fef1.js" async=""></script><script src="/_next/static/chunks/pages/_app-03498b09f93ab4bd74a9.js" async=""></script><script src="/_next/static/chunks/b435696c38dfa3a566dd7089f731d08d7e0bf097.f940d483b5a1fae10b21.js" async=""></script><script src="/_next/static/chunks/1d62a1056678c2f23610de94ff6f49e06a569636.b588272bed0c9114d503.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-dd3e2b826f95ad4c71da.js" async=""></script><script src="/_next/static/UYsP1Gx-Z9tLBnJUIbjeF/_buildManifest.js" async=""></script><script src="/_next/static/UYsP1Gx-Z9tLBnJUIbjeF/_ssgManifest.js" async=""></script></body></html>