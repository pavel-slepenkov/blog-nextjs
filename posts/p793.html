<!DOCTYPE html><html><head><meta charSet="utf-8"/><link rel="icon" href="/favicon.ico"/><link href="https://unpkg.com/prismjs@1.23.0/themes/prism-okaidia.css" rel="stylesheet"/><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="description" content="Pavel Slepenkov&#x27;s personal blog: stories about BI, python, salesforce and data analysis"/><meta http-equiv="cache-control" content="Private"/><meta http-equiv="Expires" content="366000"/><meta property="og:locale" content="en_US"/><meta name="og:title" content="Pavel Slepenkov&#x27;s personal blog"/><meta property="og:description" content="stories about BI, python, salesforce and data analysis"/><meta property="og:type" content="article"/><meta property="og:site_name" content="pavelslepenkov.info"/><meta property="og:image" content="/og.png"/><meta name="twitter:title" content="Pavel Slepenkov&#x27;s personal blog"/><meta name="twitter:description" content="stories about BI, python, salesforce and data analysis"/><meta name="twitter:card" content="summary_large_image"/><meta property="twitter:image" content="/og.png"/><meta name="keywords" content="python, BI, sql, salesforce, data engineering, apex, soql, data analisys"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-63037633-1"></script><script>
                            window.dataLayer = window.dataLayer || [];
                            function gtag(){dataLayer.push(arguments);}
                            gtag('js', new Date());
                            gtag('config', 'UA-63037633-1');
                    </script><style>@import url(&#x27;https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300&amp;family=Spectral:wght@300;600&amp;display=swap&#x27;);</style><title>Convert Rich text field images to Data URI format in VisualForce</title><meta name="next-head-count" content="23"/><link rel="preload" href="/_next/static/css/8ed85b7126e02c37.css" as="style"/><link rel="stylesheet" href="/_next/static/css/8ed85b7126e02c37.css" data-n-g=""/><link rel="preload" href="/_next/static/css/c030ed0cc76c59b0.css" as="style"/><link rel="stylesheet" href="/_next/static/css/c030ed0cc76c59b0.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-ee7e63bc15b31913.js" defer=""></script><script src="/_next/static/chunks/framework-ad45764ecfcae9e5.js" defer=""></script><script src="/_next/static/chunks/main-ee0cf4b7f81d7c24.js" defer=""></script><script src="/_next/static/chunks/pages/_app-2398585b21d2d8c8.js" defer=""></script><script src="/_next/static/chunks/105-51803cf0fd5a7825.js" defer=""></script><script src="/_next/static/chunks/358-14c60bb94e9d94b9.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-c9b3c3f336e43dc2.js" defer=""></script><script src="/_next/static/ILy-gCchHD1unXV3pNsGn/_buildManifest.js" defer=""></script><script src="/_next/static/ILy-gCchHD1unXV3pNsGn/_ssgManifest.js" defer=""></script></head><body class="centered"><script src="noflash.js"></script><script src="PathSolver.js"></script><div id="__next"><div class="layout_container__fbLkO"><div class="no-print"><header class="layout_header__kY0Lt"><div class="navbar-link centered"><a class="layout_devNull__CjwH1" href="/">Technical notes</a>—————<a class="layout_devNull__CjwH1" href="/cv">CV</a>—————<a class="layout_devNull__CjwH1" href="/books">Books &amp; Readings</a></div><div class="DarkModeToggle_darkModeToggle__m5z3H"><button type="button">🌞</button><button type="button">🌚</button></div></header></div><main><article><h1 class="utils_headingXl__u25Y2">Convert Rich text field images to Data URI format in VisualForce</h1><div class="utils_lightText__eUzGY"><time dateTime="2017-05-17T18:17:10+01:00">May 17, 2017</time></div><div><p>A few weeks ago I had a task to convert Visualforce page into Google Document. I used Javascript to integrate Salesforce with Google Drive and the basic scenario was to render some Visualforce page. This page was a mix of some parent object with several rich text fields and many other fields with many child records linked to parent. These child records also has a few rich text fields and this page was totally ugly from UI perspective but extremely useful from business perspective.</p>
<p>When the page was completed and I tested that I can send a some part of HTML markup of VF page to Google Drive and Google transformed it to correct Google Document I was pretty excited. But. I faced an issue of sending salesforce’s rich text field content into Google drive document. When the plain text and formatting is sent with no issue, sending an images of rich text fields was not working at all.</p>
<p>You know that a rich text fields in Salesforce is just a HTML markup. HTML markup usually contains a references to resources outside of the page context and receives this content via network. When you add an image into rich text field from Salesforce UI you have 2 options:</p>
<ol>
<li>Upload file into Salesforce from your own computer</li>
<li>Give SF a link to some web resource</li>
</ol>
<p>Externally stored images are transferred fine into Google Drive. But images which stored inside Salesforce can’t be exported via link because it’s not publicly available. Actually rich text field images refer to https://*.content.force.com/servlet/rtaImage?. So, if you want to send these images via network you have to transform it to <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/Data_URIs">Data URI</a> format. My initial desire was to use JS on VisualForce as it described here: <a href="https://davidwalsh.name/convert-image-data-uri-javascript">convert image to data uri with javascript</a>. That’s a really simple and clean solution. But real pain point here is the fact that VF page and salesforce images are on different domains and you can’t use it without enabled CORS on image server side. It’s obvious that we have no access to manage headers which salesforce’s image server will return. So, JS solution was not applied here what was really upset.</p>
<p>The another option for such case is an apex server side processing. That approach is not so cool but at least pretty straightforward. The scenario is follow: get rich text field, parse it and find all references to images which stored in salesforce, convert it to Data URI and rebuild a rich text field with these images.</p>
<div class="remark-highlight"><pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">convertRichTextImageLinkToBinary</span><span class="token punctuation">(</span><span class="token class-name">String</span> richText<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> imgTagPattern <span class="token operator">=</span> '<span class="token operator">&#x3C;</span>img alt<span class="token operator">=</span><span class="token string">"User-added image"</span> src<span class="token operator">=</span>"https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token function">__sf_org_name__</span><span class="token punctuation">(</span><span class="token punctuation">.</span>+<span class="token operator">?</span><span class="token punctuation">)</span>content<span class="token punctuation">.</span>force<span class="token punctuation">.</span><span class="token function">com</span><span class="token punctuation">(</span><span class="token punctuation">.</span>+<span class="token operator">?</span><span class="token punctuation">)</span>'’<span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&#x3C;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> dataUriImgs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&#x3C;</span><span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Matcher</span> imgMatcher <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>imgTagPattern<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>richText<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>imgMatcher<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> imageTag <span class="token operator">=</span> imgMatcher<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> imageURL <span class="token operator">=</span> imageTag<span class="token punctuation">.</span><span class="token function">substringBetween</span><span class="token punctuation">(</span><span class="token char">' src="'</span><span class="token punctuation">,</span> <span class="token char">'"'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> decodedURL <span class="token operator">=</span> imageURL<span class="token punctuation">.</span><span class="token function">unescapeHtml4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PageReference</span> page <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PageReference</span><span class="token punctuation">(</span>decodedURL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataUriImgs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>'<span class="token operator">&#x3C;</span>img alt<span class="token operator">=</span><span class="token string">"User-added image"</span> src<span class="token operator">=</span><span class="token string">"data:image/png;base64, ' + EncodingUtil.base64Encode(page.getContent()) + '"</span><span class="token operator">></span>'<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// can cause Regex too complex Exception on large rich text fields</span>
    <span class="token comment">// for (Integer i = 0; i &#x3C; dataUriImgs.size(); i++) {</span>
    <span class="token comment">// richText = richText.replaceFirst(imgTagPattern, dataUriImgs[i]);</span>
    <span class="token comment">// }</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&#x3C;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> rTxs <span class="token operator">=</span> richText<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>'<span class="token operator">&#x3C;</span>img alt<span class="token operator">=</span><span class="token string">"User-added image"</span> src<span class="token operator">=</span><span class="token string">"https://targetprocess(.+?)content.force.com(.+?)>"</span>'<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> result <span class="token operator">=</span> ''<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&#x3C;</span> dataUriImgs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result <span class="token operator">+=</span> <span class="token punctuation">(</span>rTxs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> dataUriImgs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    result <span class="token operator">+=</span> rTxs<span class="token punctuation">[</span>rTxs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> – <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>This code transforms passed rich text field images to Data URI format. You can use it from Visualforce controller for converting your rich text and exposing it on a page.</p>
<p>Note the following:</p>
<blockquote>
<p>If you use getContent in a test method, the test method fails. getContent is treated as a callout in API version 34.0 and later.</p>
</blockquote>
<p>That’s quote from official documentation.</p>
</div></article><div><span class="utils_tag__r8GDN"><a href="/tag/Data-URI">[<!-- -->Data URI<!-- -->]</a></span><span class="utils_tag__r8GDN"><a href="/tag/javascript">[<!-- -->javascript<!-- -->]</a></span><span class="utils_tag__r8GDN"><a href="/tag/salesforce">[<!-- -->salesforce<!-- -->]</a></span><span class="utils_tag__r8GDN"><a href="/tag/visualforce">[<!-- -->visualforce<!-- -->]</a></span></div></main><div class="layout_backToHome__9sjx_"><a href="/">⇐ back to home</a></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"p793","contentHtml":"\u003cp\u003eA few weeks ago I had a task to convert Visualforce page into Google Document. I used Javascript to integrate Salesforce with Google Drive and the basic scenario was to render some Visualforce page. This page was a mix of some parent object with several rich text fields and many other fields with many child records linked to parent. These child records also has a few rich text fields and this page was totally ugly from UI perspective but extremely useful from business perspective.\u003c/p\u003e\n\u003cp\u003eWhen the page was completed and I tested that I can send a some part of HTML markup of VF page to Google Drive and Google transformed it to correct Google Document I was pretty excited. But. I faced an issue of sending salesforce’s rich text field content into Google drive document. When the plain text and formatting is sent with no issue, sending an images of rich text fields was not working at all.\u003c/p\u003e\n\u003cp\u003eYou know that a rich text fields in Salesforce is just a HTML markup. HTML markup usually contains a references to resources outside of the page context and receives this content via network. When you add an image into rich text field from Salesforce UI you have 2 options:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eUpload file into Salesforce from your own computer\u003c/li\u003e\n\u003cli\u003eGive SF a link to some web resource\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eExternally stored images are transferred fine into Google Drive. But images which stored inside Salesforce can’t be exported via link because it’s not publicly available. Actually rich text field images refer to https://*.content.force.com/servlet/rtaImage?. So, if you want to send these images via network you have to transform it to \u003ca href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/Data_URIs\"\u003eData URI\u003c/a\u003e format. My initial desire was to use JS on VisualForce as it described here: \u003ca href=\"https://davidwalsh.name/convert-image-data-uri-javascript\"\u003econvert image to data uri with javascript\u003c/a\u003e. That’s a really simple and clean solution. But real pain point here is the fact that VF page and salesforce images are on different domains and you can’t use it without enabled CORS on image server side. It’s obvious that we have no access to manage headers which salesforce’s image server will return. So, JS solution was not applied here what was really upset.\u003c/p\u003e\n\u003cp\u003eThe another option for such case is an apex server side processing. That approach is not so cool but at least pretty straightforward. The scenario is follow: get rich text field, parse it and find all references to images which stored in salesforce, convert it to Data URI and rebuild a rich text field with these images.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-java\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003estatic\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e \u003cspan class=\"token function\"\u003econvertRichTextImageLinkToBinary\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e richText\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e imgTagPattern \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e '\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003eimg alt\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"User-added image\"\u003c/span\u003e src\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\"https\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\u003cspan class=\"token operator\"\u003e/\u003c/span\u003e\u003cspan class=\"token operator\"\u003e/\u003c/span\u003e\u003cspan class=\"token function\"\u003e__sf_org_name__\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e+\u003cspan class=\"token operator\"\u003e?\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003econtent\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eforce\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ecom\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e+\u003cspan class=\"token operator\"\u003e?\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e'’\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token class-name\"\u003eList\u003c/span\u003e\u003cspan class=\"token generics\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e dataUriImgs \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eList\u003c/span\u003e\u003cspan class=\"token generics\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token class-name\"\u003eMatcher\u003c/span\u003e imgMatcher \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token class-name\"\u003ePattern\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ecompile\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eimgTagPattern\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ematcher\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003erichText\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ewhile\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eimgMatcher\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efind\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e imageTag \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e imgMatcher\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egroup\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e imageURL \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e imageTag\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esubstringBetween\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token char\"\u003e' src=\"'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token char\"\u003e'\"'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e decodedURL \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e imageURL\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eunescapeHtml4\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token class-name\"\u003ePageReference\u003c/span\u003e page \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003ePageReference\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edecodedURL\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        dataUriImgs\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eadd\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e'\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003eimg alt\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"User-added image\"\u003c/span\u003e src\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"data:image/png;base64, ' + EncodingUtil.base64Encode(page.getContent()) + '\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e'\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// can cause Regex too complex Exception on large rich text fields\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// for (Integer i = 0; i \u0026#x3C; dataUriImgs.size(); i++) {\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// richText = richText.replaceFirst(imgTagPattern, dataUriImgs[i]);\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// }\u003c/span\u003e\n    \u003cspan class=\"token class-name\"\u003eList\u003c/span\u003e\u003cspan class=\"token generics\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e rTxs \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e richText\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esplit\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e'\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003eimg alt\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"User-added image\"\u003c/span\u003e src\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"https://targetprocess(.+?)content.force.com(.+?)\u003e\"\u003c/span\u003e'\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e result \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e ''\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eInteger\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e dataUriImgs\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esize\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e i\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        result \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003erTxs\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e dataUriImgs\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    result \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e rTxs\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003erTxs\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esize\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e – \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e result\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThis code transforms passed rich text field images to Data URI format. You can use it from Visualforce controller for converting your rich text and exposing it on a page.\u003c/p\u003e\n\u003cp\u003eNote the following:\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eIf you use getContent in a test method, the test method fails. getContent is treated as a callout in API version 34.0 and later.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eThat’s quote from official documentation.\u003c/p\u003e\n","title":"Convert Rich text field images to Data URI format in VisualForce","date":"2017-05-17T18:17:10+01:00","status":"publish","permalink":"/?p=793","author":"pavel","excerpt":"","type":"post","category":["apex","force.com","javascript","salesforce.com"],"tag":["Data URI","javascript","salesforce","visualforce"],"post_format":[],"dsq_thread_id":["5825762346"]}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"p793"},"buildId":"ILy-gCchHD1unXV3pNsGn","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>