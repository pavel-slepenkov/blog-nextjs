<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="icon" href="/favicon.ico"/><link href="https://unpkg.com/prismjs@1.23.0/themes/prism-okaidia.css" rel="stylesheet"/><meta name="description" content="Pavel Slepenkov - developer"/><meta property="og:image" content="/og.png"/><meta http-equiv="cache-control" content="Private"/><meta http-equiv="Expires" content="366000"/><meta name="og:title" content="Pavel Slepenkov&#x27;s personal blog"/><meta property="og:type" content="article"/><meta property="og:site_name" content="pavelslepenkov.info"/><meta name="twitter:card" content="summary_large_image"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-63037633-1"></script><script>
                            window.dataLayer = window.dataLayer || [];
                            function gtag(){dataLayer.push(arguments);}
                            gtag('js', new Date());
                            gtag('config', 'UA-63037633-1');
                    </script><style>@import url(&#x27;https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300&amp;family=Spectral:wght@300&amp;display=swap&#x27;);</style><title>Convert Rich text field images to Data URI format in VisualForce</title><meta name="next-head-count" content="16"/><link rel="preload" href="/_next/static/css/da6af24c77df388d15a7.css" as="style"/><link rel="stylesheet" href="/_next/static/css/da6af24c77df388d15a7.css" data-n-g=""/><link rel="preload" href="/_next/static/css/ce7efec8e5ba0fa921d1.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ce7efec8e5ba0fa921d1.css" data-n-p=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-a7c970f167496c3f3d8f.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.ef157c678a62cfb2c073.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.0cd3f0b406132b99fef1.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-7f3683197eb5514e0af9.js" as="script"/><link rel="preload" href="/_next/static/chunks/7989c093b81d86ddb0abfb342d5bc2e84730435d.6f647741ed0b0b52208d.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5Bid%5D-f3ceed90a764f1a74272.js" as="script"/></head><body><script src="noflash.js"></script><div id="__next"><div class="layout_container__2t4v2"><header class="layout_header__2rhWq"><div class="navbar-link"><a class="layout_devNull__6Fs9d" href="/">$ /dev/null</a>———<a styleClass="layout_devNull__6Fs9d" href="https://pavel-slepenkov.github.io">About </a>———<a styleClass="layout_devNull__6Fs9d" href="https://pavel-slepenkov.github.io">Projects</a></div><div class="DarkModeToogle_darkModeToggle__30wsf"><button type="button">☀</button><toggle></toggle><button type="button">☾</button></div></header><main><article><h1 class="utils_headingXl__1XecN">Convert Rich text field images to Data URI format in VisualForce</h1><div class="utils_lightText__12Ckm"><time dateTime="2017-05-17T18:17:10+01:00">May 17, 2017</time></div><div><p>A few weeks ago I had a task to convert Visualforce page into Google Document. I used Javascript to integrate Salesforce with Google Drive and the basic scenario was to render some Visualforce page. This page was a mix of some parent object with several rich text fields and many other fields with many child records linked to parent. These child records also has a few rich text fields and this page was totally ugly from UI perspective but extremely useful from business perspective.</p>
<p>When the page was completed and I tested that I can send a some part of HTML markup of VF page to Google Drive and Google transformed it to correct Google Document I was pretty excited. But. I faced an issue of sending salesforce’s rich text field content into Google drive document. When the plain text and formatting is sent with no issue, sending an images of rich text fields was not working at all.</p>
<p>You know that a rich text fields in Salesforce is just a HTML markup. HTML markup usually contains a references to resources outside of the page context and receives this content via network. When you add an image into rich text field from Salesforce UI you have 2 options:</p>
<ol>
<li>Upload file into Salesforce from your own computer</li>
<li>Give SF a link to some web resource</li>
</ol>
<p>Externally stored images are transferred fine into Google Drive. But images which stored inside Salesforce can’t be exported via link because it’s not publicly available. Actually rich text field images refer to https://*.content.force.com/servlet/rtaImage?. So, if you want to send these images via network you have to transform it to <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/Data_URIs">Data URI</a> format. My initial desire was to use JS on VisualForce as it described here: <a href="https://davidwalsh.name/convert-image-data-uri-javascript">convert image to data uri with javascript</a>. That’s a really simple and clean solution. But real pain point here is the fact that VF page and salesforce images are on different domains and you can’t use it without enabled CORS on image server side. It’s obvious that we have no access to manage headers which salesforce’s image server will return. So, JS solution was not applied here what was really upset.</p>
<p>The another option for such case is an apex server side processing. That approach is not so cool but at least pretty straightforward. The scenario is follow: get rich text field, parse it and find all references to images which stored in salesforce, convert it to Data URI and rebuild a rich text field with these images. Easy.</p>
<p>[java]</p>
<p>public static String convertRichTextImageLinkToBinary(String richText) {
String imgTagPattern = ‘&#x3C;img alt="User-added image" src="https://__sf_org_name__(.+?)content\\.force\\.com(.+?)>’;
List&#x3C;String> dataUriImgs = new List&#x3C;String>();
Matcher imgMatcher = Pattern.compile(imgTagPattern).matcher(richText);</p>
<p>while (imgMatcher.find()) {
String imageTag = imgMatcher.group();
String imageURL = imageTag.substringBetween(‘ src="’, ‘"’);
String decodedURL = imageURL.unescapeHtml4();
PageReference page = new PageReference(decodedURL);
dataUriImgs.add(‘&#x3C;img alt="User-added image" src="data:image/png;base64, ‘ + EncodingUtil.base64Encode(page.getContent()) + ‘">’);
}</p>
<p>// can cause Regex too complex Exception on large rich text fields
// for (Integer i = 0; i &#x3C; dataUriImgs.size(); i++) {
// richText = richText.replaceFirst(imgTagPattern, dataUriImgs[i]);
// }
List&#x3C;String> rTxs = richText.split(‘&#x3C;img alt="User-added image" src="https://targetprocess(.+?)content\\.force\\.com(.+?)>’);
String result = ”;
for (Integer i = 0; i &#x3C; dataUriImgs.size(); i++) {
result += (rTxs[i] + dataUriImgs[i]);
}
result += rTxs[rTxs.size() – 1];
return result;
}
[/java]</p>
<p>This code transforms passed rich text field images to Data URI format. You can use it from Visualforce controller for converting your rich text and exposing it on a page.</p>
<p>Note the following:</p>
<blockquote>
<p>If you use getContent in a test method, the test method fails. getContent is treated as a callout in API version 34.0 and later.</p>
</blockquote>
<p>That’s quote from official documentation.</p>
</div></article></main><div class="layout_backToHome__1vZsp"><a href="/">⇐ back to home</a></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"p793","contentHtml":"\u003cp\u003eA few weeks ago I had a task to convert Visualforce page into Google Document. I used Javascript to integrate Salesforce with Google Drive and the basic scenario was to render some Visualforce page. This page was a mix of some parent object with several rich text fields and many other fields with many child records linked to parent. These child records also has a few rich text fields and this page was totally ugly from UI perspective but extremely useful from business perspective.\u003c/p\u003e\n\u003cp\u003eWhen the page was completed and I tested that I can send a some part of HTML markup of VF page to Google Drive and Google transformed it to correct Google Document I was pretty excited. But. I faced an issue of sending salesforce’s rich text field content into Google drive document. When the plain text and formatting is sent with no issue, sending an images of rich text fields was not working at all.\u003c/p\u003e\n\u003cp\u003eYou know that a rich text fields in Salesforce is just a HTML markup. HTML markup usually contains a references to resources outside of the page context and receives this content via network. When you add an image into rich text field from Salesforce UI you have 2 options:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eUpload file into Salesforce from your own computer\u003c/li\u003e\n\u003cli\u003eGive SF a link to some web resource\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eExternally stored images are transferred fine into Google Drive. But images which stored inside Salesforce can’t be exported via link because it’s not publicly available. Actually rich text field images refer to https://*.content.force.com/servlet/rtaImage?. So, if you want to send these images via network you have to transform it to \u003ca href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/Data_URIs\"\u003eData URI\u003c/a\u003e format. My initial desire was to use JS on VisualForce as it described here: \u003ca href=\"https://davidwalsh.name/convert-image-data-uri-javascript\"\u003econvert image to data uri with javascript\u003c/a\u003e. That’s a really simple and clean solution. But real pain point here is the fact that VF page and salesforce images are on different domains and you can’t use it without enabled CORS on image server side. It’s obvious that we have no access to manage headers which salesforce’s image server will return. So, JS solution was not applied here what was really upset.\u003c/p\u003e\n\u003cp\u003eThe another option for such case is an apex server side processing. That approach is not so cool but at least pretty straightforward. The scenario is follow: get rich text field, parse it and find all references to images which stored in salesforce, convert it to Data URI and rebuild a rich text field with these images. Easy.\u003c/p\u003e\n\u003cp\u003e[java]\u003c/p\u003e\n\u003cp\u003epublic static String convertRichTextImageLinkToBinary(String richText) {\nString imgTagPattern = ‘\u0026#x3C;img alt=\"User-added image\" src=\"https://__sf_org_name__(.+?)content\\\\.force\\\\.com(.+?)\u003e’;\nList\u0026#x3C;String\u003e dataUriImgs = new List\u0026#x3C;String\u003e();\nMatcher imgMatcher = Pattern.compile(imgTagPattern).matcher(richText);\u003c/p\u003e\n\u003cp\u003ewhile (imgMatcher.find()) {\nString imageTag = imgMatcher.group();\nString imageURL = imageTag.substringBetween(‘ src=\"’, ‘\"’);\nString decodedURL = imageURL.unescapeHtml4();\nPageReference page = new PageReference(decodedURL);\ndataUriImgs.add(‘\u0026#x3C;img alt=\"User-added image\" src=\"data:image/png;base64, ‘ + EncodingUtil.base64Encode(page.getContent()) + ‘\"\u003e’);\n}\u003c/p\u003e\n\u003cp\u003e// can cause Regex too complex Exception on large rich text fields\n// for (Integer i = 0; i \u0026#x3C; dataUriImgs.size(); i++) {\n// richText = richText.replaceFirst(imgTagPattern, dataUriImgs[i]);\n// }\nList\u0026#x3C;String\u003e rTxs = richText.split(‘\u0026#x3C;img alt=\"User-added image\" src=\"https://targetprocess(.+?)content\\\\.force\\\\.com(.+?)\u003e’);\nString result = ”;\nfor (Integer i = 0; i \u0026#x3C; dataUriImgs.size(); i++) {\nresult += (rTxs[i] + dataUriImgs[i]);\n}\nresult += rTxs[rTxs.size() – 1];\nreturn result;\n}\n[/java]\u003c/p\u003e\n\u003cp\u003eThis code transforms passed rich text field images to Data URI format. You can use it from Visualforce controller for converting your rich text and exposing it on a page.\u003c/p\u003e\n\u003cp\u003eNote the following:\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eIf you use getContent in a test method, the test method fails. getContent is treated as a callout in API version 34.0 and later.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eThat’s quote from official documentation.\u003c/p\u003e\n","title":"Convert Rich text field images to Data URI format in VisualForce","date":"2017-05-17T18:17:10+01:00","status":"publish","permalink":"/?p=793","author":"pavel","excerpt":"","type":"post","category":["apex","force.com","javascript","salesforce.com"],"tag":["Data URI","javascript","salesforce","visualforce"],"post_format":[],"dsq_thread_id":["5825762346"]}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"p793"},"buildId":"w-AtIV3t8Jw0Lg8bm9TeM","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-11c8eba6a84e3fddec04.js"></script><script src="/_next/static/chunks/main-a7c970f167496c3f3d8f.js" async=""></script><script src="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" async=""></script><script src="/_next/static/chunks/framework.ef157c678a62cfb2c073.js" async=""></script><script src="/_next/static/chunks/commons.0cd3f0b406132b99fef1.js" async=""></script><script src="/_next/static/chunks/pages/_app-7f3683197eb5514e0af9.js" async=""></script><script src="/_next/static/chunks/7989c093b81d86ddb0abfb342d5bc2e84730435d.6f647741ed0b0b52208d.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-f3ceed90a764f1a74272.js" async=""></script><script src="/_next/static/w-AtIV3t8Jw0Lg8bm9TeM/_buildManifest.js" async=""></script><script src="/_next/static/w-AtIV3t8Jw0Lg8bm9TeM/_ssgManifest.js" async=""></script></body></html>