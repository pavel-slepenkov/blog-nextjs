<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="icon" href="/favicon.ico"/><link rel="preload" href="https://unpkg.com/prismjs@0.0.1/themes/prism-tomorrow.css" as="script"/><link rel="preload" href="https://unpkg.com/prismjs@0.0.1/themes/prism-coy.css" as="script"/><link rel="preload" href="https://unpkg.com/prismjs@0.0.1/themes/prism-okaidia.css" as="script"/><link rel="preload" href="https://unpkg.com/prismjs@0.0.1/themes/prism-funky.css" as="script"/><link href="https://unpkg.com/prismjs@0.0.1/themes/prism-okaidia.css" rel="stylesheet"/><meta name="description" content="Pavel Slepenkov - developer"/><meta property="og:image" content="https://og-image.now.sh/Pavel%20Slepenkov%20personal%20blog.png?theme=light&amp;md=1&amp;fontSize=100px&amp;images=https%3A%2F%2Fassets.vercel.com%2Fimage%2Fupload%2Ffront%2Fassets%2Fdesign%2Fhyper-color-logo.svg&amp;widths=auto"/><meta name="og:title" content="Pavel Slepenkov personal blog"/><meta name="twitter:card" content="summary_large_image"/><title>Basic method to avoid SOQL in the for loop (Bulkify apex code)</title><meta name="next-head-count" content="13"/><link rel="preload" href="/blog-nextjs/_next/static/css/d9f62f5770aa60bc54db.css" as="style"/><link rel="stylesheet" href="/blog-nextjs/_next/static/css/d9f62f5770aa60bc54db.css" data-n-g=""/><link rel="preload" href="/blog-nextjs/_next/static/css/7b989d401051c7c1fc1a.css" as="style"/><link rel="stylesheet" href="/blog-nextjs/_next/static/css/7b989d401051c7c1fc1a.css" data-n-p=""/><noscript data-n-css=""></noscript><link rel="preload" href="/blog-nextjs/_next/static/chunks/main-a7c970f167496c3f3d8f.js" as="script"/><link rel="preload" href="/blog-nextjs/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" as="script"/><link rel="preload" href="/blog-nextjs/_next/static/chunks/framework.2113c6061a2f456066a1.js" as="script"/><link rel="preload" href="/blog-nextjs/_next/static/chunks/commons.390514621f46153c0d8a.js" as="script"/><link rel="preload" href="/blog-nextjs/_next/static/chunks/pages/_app-63f54fbe8fbe4d14dff9.js" as="script"/><link rel="preload" href="/blog-nextjs/_next/static/chunks/7989c093b81d86ddb0abfb342d5bc2e84730435d.22009c787aae00c65fc7.js" as="script"/><link rel="preload" href="/blog-nextjs/_next/static/chunks/pages/posts/%5Bid%5D-4c37b983192d656c52ce.js" as="script"/></head><body><div id="__next"><div class="layout_container__2t4v2"><header class="layout_header__2rhWq"><a href="/blog-nextjs"><img src="images/sh.jpg" class="layout_headerImage__2h5On utils_borderCircle__13qdJ" alt="Pavel Slepenkov"/></a><h2 class="utils_headingLg__de7p0"><a class="utils_colorInherit__3Gudf" href="/blog-nextjs">Pavel Slepenkov</a></h2></header><main><article><h1 class="utils_headingXl__1XecN">Basic method to avoid SOQL in the for loop (Bulkify apex code)</h1><div class="utils_lightText__12Ckm"><time dateTime="2013-12-04T12:24:52+00:00">December 4, 2013</time></div><div><p>If you greenhorn in area of Force.com development you might fall into the trap. This is very common and often trouble for all developers who start using Force.com platform. This trouble called</p>
<p>[code gutter=”false”] System.Exception: Too many SOQL queries: 101 [/code]</p>
<p>The most confused issue with this error is that error might to appear from time to time and you might do not know about an error a pretty much time. So, what is the root of this error? The answer is simple, and this answer is one of most significant rule of Force.com platform – <strong>Do not use SOQL into a loop. Never.</strong></p>
<p>In the start line when you add a trigger it seems like a very simple solution, you just add something like that:</p>
<p>[code lang=”java”]
trigger AccountTrigger on Account (before update) {
for (Account account: Trigger.new) {
if (Trigger.oldMap.get(account.Id).someField__c != account.someField__c) {
List&#x3C;Case> relatedCases = [SELECT Id
,Name
,Comment
,Priority
,Category
FROM Case
WHERE Account =: account.Id];
recalculateCases(relatedCases);
}
}
}
[/code]</p>
<p>From a scratch this code is ok, your users will work fine with just one record which will be edited from UI. But the code will become more difficult, you will start to use Data Loader or any other tools which will be a cause of BULK operation, as soon as you begin work with it you start to get a number of issues regarding a BULK operations. From this moment you should Bulkify you code.</p>
<p>In many cases the best approach is preparation all needed data outside a loop.</p>
<p><strong>Utils.cls</strong></p>
<p>[code lang=”java”]
class CommonException extends Exception {}</p>
<p>public static Map&#x3C;Id, List&#x3C;sObject>> splitListByKey(List&#x3C;sObject> sourceList, String key) {
if (sourceList == null) {
throw new CommonException(‘ERROR: splitListByKey(sourceList, key) got incorrect first parameter.’);
}
if (String.isBlank(key)) {
throw new CommonException(‘ERROR: splitListByKey(sourceList, key) got incorrect second parameter.’);
}
Map&#x3C;Id,List&#x3C;sObject>> result = new Map&#x3C;Id,List&#x3C;sObject>>();
List&#x3C;sObject> tmpObjs;
for (sObject obj: sourceList) {
tmpObjs = new List&#x3C;sObject>();
if (obj.get(key) != null &#x26;&#x26; result.containsKey((Id)obj.get(key))) {
tmpObjs = result.get((Id)obj.get(key));
tmpObjs.add(obj);
result.put((Id)obj.get(key), tmpObjs);
} else if (obj.get(key) != null) {
tmpObjs.add(obj);
result.put((Id)obj.get(key), tmpObjs);
}
}
return result;
}
[/code]</p>
<p><strong>AccountTrigger</strong></p>
<p>[code lang=”java”]
trigger AccountTrigger on Account (before update) {</p>
<p>Map&#x3C;Id, List&#x3C;Case>> casesByAccountId = Utils.splitListByKey( [SELECT Id
,Name
,Comment
,Priority
,Category
FROM Case
WHERE Account IN : Trigger.newMap.keySet()],
‘Account’);
for (Account account: Trigger.new) {
if (Trigger.oldMap.get(account.Id).someField__c != account.someField__c) {
List&#x3C;Case> relatedCases = casesByAccountId.get(account.Id);
recalculateCases(relatedCases);
}
}
}
[/code]</p>
<p>As you can see in the code above we use query just once. It’s more flexible solution, but you need to remember that this approach should not to be a ‘golden hammer’.</p>
</div></article></main><div class="layout_backToHome__1vZsp"><a href="/blog-nextjs">← Back to home</a></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"p305","contentHtml":"\u003cp\u003eIf you greenhorn in area of Force.com development you might fall into the trap. This is very common and often trouble for all developers who start using Force.com platform. This trouble called\u003c/p\u003e\n\u003cp\u003e[code gutter=”false”] System.Exception: Too many SOQL queries: 101 [/code]\u003c/p\u003e\n\u003cp\u003eThe most confused issue with this error is that error might to appear from time to time and you might do not know about an error a pretty much time. So, what is the root of this error? The answer is simple, and this answer is one of most significant rule of Force.com platform – \u003cstrong\u003eDo not use SOQL into a loop. Never.\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eIn the start line when you add a trigger it seems like a very simple solution, you just add something like that:\u003c/p\u003e\n\u003cp\u003e[code lang=”java”]\ntrigger AccountTrigger on Account (before update) {\nfor (Account account: Trigger.new) {\nif (Trigger.oldMap.get(account.Id).someField__c != account.someField__c) {\nList\u0026#x3C;Case\u003e relatedCases = [SELECT Id\n,Name\n,Comment\n,Priority\n,Category\nFROM Case\nWHERE Account =: account.Id];\nrecalculateCases(relatedCases);\n}\n}\n}\n[/code]\u003c/p\u003e\n\u003cp\u003eFrom a scratch this code is ok, your users will work fine with just one record which will be edited from UI. But the code will become more difficult, you will start to use Data Loader or any other tools which will be a cause of BULK operation, as soon as you begin work with it you start to get a number of issues regarding a BULK operations. From this moment you should Bulkify you code.\u003c/p\u003e\n\u003cp\u003eIn many cases the best approach is preparation all needed data outside a loop.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eUtils.cls\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e[code lang=”java”]\nclass CommonException extends Exception {}\u003c/p\u003e\n\u003cp\u003epublic static Map\u0026#x3C;Id, List\u0026#x3C;sObject\u003e\u003e splitListByKey(List\u0026#x3C;sObject\u003e sourceList, String key) {\nif (sourceList == null) {\nthrow new CommonException(‘ERROR: splitListByKey(sourceList, key) got incorrect first parameter.’);\n}\nif (String.isBlank(key)) {\nthrow new CommonException(‘ERROR: splitListByKey(sourceList, key) got incorrect second parameter.’);\n}\nMap\u0026#x3C;Id,List\u0026#x3C;sObject\u003e\u003e result = new Map\u0026#x3C;Id,List\u0026#x3C;sObject\u003e\u003e();\nList\u0026#x3C;sObject\u003e tmpObjs;\nfor (sObject obj: sourceList) {\ntmpObjs = new List\u0026#x3C;sObject\u003e();\nif (obj.get(key) != null \u0026#x26;\u0026#x26; result.containsKey((Id)obj.get(key))) {\ntmpObjs = result.get((Id)obj.get(key));\ntmpObjs.add(obj);\nresult.put((Id)obj.get(key), tmpObjs);\n} else if (obj.get(key) != null) {\ntmpObjs.add(obj);\nresult.put((Id)obj.get(key), tmpObjs);\n}\n}\nreturn result;\n}\n[/code]\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eAccountTrigger\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e[code lang=”java”]\ntrigger AccountTrigger on Account (before update) {\u003c/p\u003e\n\u003cp\u003eMap\u0026#x3C;Id, List\u0026#x3C;Case\u003e\u003e casesByAccountId = Utils.splitListByKey( [SELECT Id\n,Name\n,Comment\n,Priority\n,Category\nFROM Case\nWHERE Account IN : Trigger.newMap.keySet()],\n‘Account’);\nfor (Account account: Trigger.new) {\nif (Trigger.oldMap.get(account.Id).someField__c != account.someField__c) {\nList\u0026#x3C;Case\u003e relatedCases = casesByAccountId.get(account.Id);\nrecalculateCases(relatedCases);\n}\n}\n}\n[/code]\u003c/p\u003e\n\u003cp\u003eAs you can see in the code above we use query just once. It’s more flexible solution, but you need to remember that this approach should not to be a ‘golden hammer’.\u003c/p\u003e\n","title":"Basic method to avoid SOQL in the for loop (Bulkify apex code)","date":"2013-12-04T12:24:52+00:00","status":"publish","permalink":"/?p=305","author":"pavel","excerpt":"","type":"post","category":["apex"],"tag":[],"post_format":[],"cleanretina_sidebarlayout":["no-sidebar-full-width"],"original_post_id":["305"],"dsq_thread_id":["5594842278"]}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"p305"},"buildId":"1PhOX4RJW_xb2bnIlM9td","assetPrefix":"/blog-nextjs","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/blog-nextjs/_next/static/chunks/polyfills-11c8eba6a84e3fddec04.js"></script><script src="/blog-nextjs/_next/static/chunks/main-a7c970f167496c3f3d8f.js" async=""></script><script src="/blog-nextjs/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" async=""></script><script src="/blog-nextjs/_next/static/chunks/framework.2113c6061a2f456066a1.js" async=""></script><script src="/blog-nextjs/_next/static/chunks/commons.390514621f46153c0d8a.js" async=""></script><script src="/blog-nextjs/_next/static/chunks/pages/_app-63f54fbe8fbe4d14dff9.js" async=""></script><script src="/blog-nextjs/_next/static/chunks/7989c093b81d86ddb0abfb342d5bc2e84730435d.22009c787aae00c65fc7.js" async=""></script><script src="/blog-nextjs/_next/static/chunks/pages/posts/%5Bid%5D-4c37b983192d656c52ce.js" async=""></script><script src="/blog-nextjs/_next/static/1PhOX4RJW_xb2bnIlM9td/_buildManifest.js" async=""></script><script src="/blog-nextjs/_next/static/1PhOX4RJW_xb2bnIlM9td/_ssgManifest.js" async=""></script></body></html>