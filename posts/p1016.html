<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="icon" href="/favicon.ico"/><link rel="preload" href="https://unpkg.com/prismjs@0.0.1/themes/prism-tomorrow.css" as="script"/><link rel="preload" href="https://unpkg.com/prismjs@0.0.1/themes/prism-coy.css" as="script"/><link rel="preload" href="https://unpkg.com/prismjs@0.0.1/themes/prism-okaidia.css" as="script"/><link rel="preload" href="https://unpkg.com/prismjs@0.0.1/themes/prism-funky.css" as="script"/><link href="https://unpkg.com/prismjs@0.0.1/themes/prism-okaidia.css" rel="stylesheet"/><meta name="description" content="Pavel Slepenkov - developer"/><meta property="og:image" content="https://og-image.now.sh/Pavel%20Slepenkov%20personal%20blog.png?theme=light&amp;md=1&amp;fontSize=100px&amp;images=https%3A%2F%2Fassets.vercel.com%2Fimage%2Fupload%2Ffront%2Fassets%2Fdesign%2Fhyper-color-logo.svg&amp;widths=auto"/><meta name="og:title" content="Pavel Slepenkov personal blog"/><meta name="twitter:card" content="summary_large_image"/><title>sun.security.validator.ValidatorException: PKIX path building failed in Salesforce</title><meta name="next-head-count" content="13"/><link rel="preload" href="/blog-nextjs/_next/static/css/d9f62f5770aa60bc54db.css" as="style"/><link rel="stylesheet" href="/blog-nextjs/_next/static/css/d9f62f5770aa60bc54db.css" data-n-g=""/><link rel="preload" href="/blog-nextjs/_next/static/css/7b989d401051c7c1fc1a.css" as="style"/><link rel="stylesheet" href="/blog-nextjs/_next/static/css/7b989d401051c7c1fc1a.css" data-n-p=""/><noscript data-n-css=""></noscript><link rel="preload" href="/blog-nextjs/_next/static/chunks/main-a7c970f167496c3f3d8f.js" as="script"/><link rel="preload" href="/blog-nextjs/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" as="script"/><link rel="preload" href="/blog-nextjs/_next/static/chunks/framework.2113c6061a2f456066a1.js" as="script"/><link rel="preload" href="/blog-nextjs/_next/static/chunks/commons.390514621f46153c0d8a.js" as="script"/><link rel="preload" href="/blog-nextjs/_next/static/chunks/pages/_app-63f54fbe8fbe4d14dff9.js" as="script"/><link rel="preload" href="/blog-nextjs/_next/static/chunks/7989c093b81d86ddb0abfb342d5bc2e84730435d.22009c787aae00c65fc7.js" as="script"/><link rel="preload" href="/blog-nextjs/_next/static/chunks/pages/posts/%5Bid%5D-4c37b983192d656c52ce.js" as="script"/></head><body><div id="__next"><div class="layout_container__2t4v2"><header class="layout_header__2rhWq"><a href="/blog-nextjs"><img src="images/sh.jpg" class="layout_headerImage__2h5On utils_borderCircle__13qdJ" alt="Pavel Slepenkov"/></a><h2 class="utils_headingLg__de7p0"><a class="utils_colorInherit__3Gudf" href="/blog-nextjs">Pavel Slepenkov</a></h2></header><main><article><h1 class="utils_headingXl__1XecN">sun.security.validator.ValidatorException: PKIX path building failed in Salesforce</h1><div class="utils_lightText__12Ckm"><time dateTime="2019-04-09T10:54:13+01:00">April 9, 2019</time></div><div><p>Working on integration Salesforce with external system and vice versa through both REST and SOAP APIs you might get the following exception</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">&#x26;lt;pre class=&#x26;quot;wp-block-syntaxhighlighter-code&#x26;quot;&#x26;gt;sun.security.validator.ValidatorException:
PKIX path building failed:
sun.security.provider.certpath.SunCertPathBuilderException:
unable to find valid certification path to requested target</code></pre></div>
<p>1. Salesforce to external system integration errors</p>
<p>The first thing to check is certificate on external system side. Most likely the problem is on this side.</p>
<p>1.1 The problem with certificate itself. Any issue with certificate on 3rd party side will cause the error. You can check this <a href="https://badssl.com/">site</a> for more details and examples on certificates issues.</p>
<div class="wp-block-image"><figure class="aligncenter is-resized">![](https://pavelslepenkov.info/wp-content/uploads/2019/04/image-1.png)</figure></div>Here’re a few possible reason why certificate is not trusted:
<ol>
<li>certificate is expired</li>
<li>certificate is for a wrong host</li>
<li>certificate is self-signed</li>
<li>certificate with untrusted root</li>
<li>certificate is revoked</li>
<li>certificate is invalid by <a href="https://en.wikipedia.org/wiki/HTTP_Public_Key_Pinning">key pinning</a></li>
</ol>
<p>The only possible solution for these cases is to install correct certificate on a server.</p>
<p>1.2 When certificate on a server is <strong>valid</strong> and you can access the host by <strong>browser</strong> with no error it might be a sign of a broken certificate <a href="https://en.wikipedia.org/wiki/Chain_of_trust">chain of trust</a>.</p>
<blockquote>
<p>Salesforce’s certificate trust policy is to require server and client certificate chains to include all intermediate certificates that exist between the server or client certificate and the chain’s root certificate</p>
</blockquote>
<p>You can review salesforce trusted certificates via https://INSTANCE.salesforce.com/cacerts.jsp like ( <a href="https://slepenkov-dev-ed.my.salesforce.com/cacerts.jsp">https://slepenkov-dev-ed.my.salesforce.com/cacerts.jsp)</a></p>
<p>Most possibly your server has no intermediate, root CA or several certificates installed/added and thus these certificates are not added to server response during handshake.</p>
<p>On server you need to have all certificates in the chain. Different servers has different configuration and different locations for a certificates but in any case server must provide a whole chain to a client in order to be trusted. Structured in the following way</p>
<figure class="wp-block-image">![](https://pavelslepenkov.info/wp-content/uploads/2019/04/image-2.png)</figure>You can verify this case with the following command:
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">&#x26;lt;pre class=&#x26;quot;wp-block-syntaxhighlighter-code&#x26;quot;&#x26;gt;openssl s_client -connect techcrunch.com:443</code></pre></div>
<p>Valid result will be as follow:</p>
<figure class="wp-block-image is-resized">![](https://pavelslepenkov.info/wp-content/uploads/2019/04/image-3-1024x336.png)</figure>When chain is broken the same command will produce the following result:
<figure class="wp-block-image is-resized">![](https://pavelslepenkov.info/wp-content/uploads/2019/04/image-4-1024x153.png)</figure>with final error messages
<p><code>Verify return code: 21 (unable to verify the first certificate)</code></p>
<p>or</p>
<p><code>verify return code: 20 (unable to get local issuer certificate)</code></p>
<p>All you need to fix that is to add root CA certificate and/or intermediate certificates if needed in order to send server response with entire certificates chain during the handshake.</p>
<p>2. External System to Salesforce</p>
<p>When connecting to Salesforce from external application you might get the same error. This time error means that you server have no some salesforce chain of trust certificates. You can add it one by one or as a certificate bundle to your server.</p>
<p>Just download certificates chain with this command</p>
<p><code>openssl s_client -showcerts -connect slepenkov-dev-ed.my.salesforce.com:443</code></p>
<p>The output will contain all certificates in chain and you can copy and add it to your server certificate store.</p>
<figure class="wp-block-image">![](https://pavelslepenkov.info/wp-content/uploads/2019/04/image-5-687x1024.png)</figure>
</div></article></main><div class="layout_backToHome__1vZsp"><a href="/blog-nextjs">← Back to home</a></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"p1016","contentHtml":"\u003cp\u003eWorking on integration Salesforce with external system and vice versa through both REST and SOAP APIs you might get the following exception\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003e\u0026#x26;lt;pre class=\u0026#x26;quot;wp-block-syntaxhighlighter-code\u0026#x26;quot;\u0026#x26;gt;sun.security.validator.ValidatorException:\nPKIX path building failed:\nsun.security.provider.certpath.SunCertPathBuilderException:\nunable to find valid certification path to requested target\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e1. Salesforce to external system integration errors\u003c/p\u003e\n\u003cp\u003eThe first thing to check is certificate on external system side. Most likely the problem is on this side.\u003c/p\u003e\n\u003cp\u003e1.1 The problem with certificate itself. Any issue with certificate on 3rd party side will cause the error. You can check this \u003ca href=\"https://badssl.com/\"\u003esite\u003c/a\u003e for more details and examples on certificates issues.\u003c/p\u003e\n\u003cdiv class=\"wp-block-image\"\u003e\u003cfigure class=\"aligncenter is-resized\"\u003e![](https://pavelslepenkov.info/wp-content/uploads/2019/04/image-1.png)\u003c/figure\u003e\u003c/div\u003eHere’re a few possible reason why certificate is not trusted:\n\u003col\u003e\n\u003cli\u003ecertificate is expired\u003c/li\u003e\n\u003cli\u003ecertificate is for a wrong host\u003c/li\u003e\n\u003cli\u003ecertificate is self-signed\u003c/li\u003e\n\u003cli\u003ecertificate with untrusted root\u003c/li\u003e\n\u003cli\u003ecertificate is revoked\u003c/li\u003e\n\u003cli\u003ecertificate is invalid by \u003ca href=\"https://en.wikipedia.org/wiki/HTTP_Public_Key_Pinning\"\u003ekey pinning\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eThe only possible solution for these cases is to install correct certificate on a server.\u003c/p\u003e\n\u003cp\u003e1.2 When certificate on a server is \u003cstrong\u003evalid\u003c/strong\u003e and you can access the host by \u003cstrong\u003ebrowser\u003c/strong\u003e with no error it might be a sign of a broken certificate \u003ca href=\"https://en.wikipedia.org/wiki/Chain_of_trust\"\u003echain of trust\u003c/a\u003e.\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eSalesforce’s certificate trust policy is to require server and client certificate chains to include all intermediate certificates that exist between the server or client certificate and the chain’s root certificate\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eYou can review salesforce trusted certificates via https://INSTANCE.salesforce.com/cacerts.jsp like ( \u003ca href=\"https://slepenkov-dev-ed.my.salesforce.com/cacerts.jsp\"\u003ehttps://slepenkov-dev-ed.my.salesforce.com/cacerts.jsp)\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eMost possibly your server has no intermediate, root CA or several certificates installed/added and thus these certificates are not added to server response during handshake.\u003c/p\u003e\n\u003cp\u003eOn server you need to have all certificates in the chain. Different servers has different configuration and different locations for a certificates but in any case server must provide a whole chain to a client in order to be trusted. Structured in the following way\u003c/p\u003e\n\u003cfigure class=\"wp-block-image\"\u003e![](https://pavelslepenkov.info/wp-content/uploads/2019/04/image-2.png)\u003c/figure\u003eYou can verify this case with the following command:\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003e\u0026#x26;lt;pre class=\u0026#x26;quot;wp-block-syntaxhighlighter-code\u0026#x26;quot;\u0026#x26;gt;openssl s_client -connect techcrunch.com:443\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eValid result will be as follow:\u003c/p\u003e\n\u003cfigure class=\"wp-block-image is-resized\"\u003e![](https://pavelslepenkov.info/wp-content/uploads/2019/04/image-3-1024x336.png)\u003c/figure\u003eWhen chain is broken the same command will produce the following result:\n\u003cfigure class=\"wp-block-image is-resized\"\u003e![](https://pavelslepenkov.info/wp-content/uploads/2019/04/image-4-1024x153.png)\u003c/figure\u003ewith final error messages\n\u003cp\u003e\u003ccode\u003eVerify return code: 21 (unable to verify the first certificate)\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eor\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003everify return code: 20 (unable to get local issuer certificate)\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eAll you need to fix that is to add root CA certificate and/or intermediate certificates if needed in order to send server response with entire certificates chain during the handshake.\u003c/p\u003e\n\u003cp\u003e2. External System to Salesforce\u003c/p\u003e\n\u003cp\u003eWhen connecting to Salesforce from external application you might get the same error. This time error means that you server have no some salesforce chain of trust certificates. You can add it one by one or as a certificate bundle to your server.\u003c/p\u003e\n\u003cp\u003eJust download certificates chain with this command\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eopenssl s_client -showcerts -connect slepenkov-dev-ed.my.salesforce.com:443\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eThe output will contain all certificates in chain and you can copy and add it to your server certificate store.\u003c/p\u003e\n\u003cfigure class=\"wp-block-image\"\u003e![](https://pavelslepenkov.info/wp-content/uploads/2019/04/image-5-687x1024.png)\u003c/figure\u003e\n","title":"sun.security.validator.ValidatorException: PKIX path building failed in Salesforce","date":"2019-04-09T10:54:13+01:00","status":"publish","permalink":"/?p=1016","author":"pavel","excerpt":"","type":"post","category":["salesforce.com","security","web-services"],"tag":["salesforce","salesforce errors","security","ssl","web-services"],"post_format":[]}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"p1016"},"buildId":"vyBdFlajjeQB2LRav_ReN","assetPrefix":"/blog-nextjs","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/blog-nextjs/_next/static/chunks/polyfills-11c8eba6a84e3fddec04.js"></script><script src="/blog-nextjs/_next/static/chunks/main-a7c970f167496c3f3d8f.js" async=""></script><script src="/blog-nextjs/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" async=""></script><script src="/blog-nextjs/_next/static/chunks/framework.2113c6061a2f456066a1.js" async=""></script><script src="/blog-nextjs/_next/static/chunks/commons.390514621f46153c0d8a.js" async=""></script><script src="/blog-nextjs/_next/static/chunks/pages/_app-63f54fbe8fbe4d14dff9.js" async=""></script><script src="/blog-nextjs/_next/static/chunks/7989c093b81d86ddb0abfb342d5bc2e84730435d.22009c787aae00c65fc7.js" async=""></script><script src="/blog-nextjs/_next/static/chunks/pages/posts/%5Bid%5D-4c37b983192d656c52ce.js" async=""></script><script src="/blog-nextjs/_next/static/vyBdFlajjeQB2LRav_ReN/_buildManifest.js" async=""></script><script src="/blog-nextjs/_next/static/vyBdFlajjeQB2LRav_ReN/_ssgManifest.js" async=""></script></body></html>