<!DOCTYPE html><html><head><meta charSet="utf-8"/><link rel="icon" href="/favicon.ico"/><link href="https://unpkg.com/prismjs@1.23.0/themes/prism-okaidia.css" rel="stylesheet"/><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="description" content="Pavel Slepenkov&#x27;s personal blog: stories about BI, python, salesforce and data analysis"/><meta http-equiv="cache-control" content="Private"/><meta http-equiv="Expires" content="366000"/><meta property="og:locale" content="en_US"/><meta name="og:title" content="Pavel Slepenkov&#x27;s personal blog"/><meta property="og:description" content="stories about BI, python, salesforce and data analysis"/><meta property="og:type" content="article"/><meta property="og:site_name" content="pavelslepenkov.info"/><meta property="og:image" content="/og.png"/><meta name="twitter:title" content="Pavel Slepenkov&#x27;s personal blog"/><meta name="twitter:description" content="stories about BI, python, salesforce and data analysis"/><meta name="twitter:card" content="summary_large_image"/><meta property="twitter:image" content="/og.png"/><meta name="keywords" content="python, BI, salesforce, data engineering, apex, sql, soql, data analisys"/><meta name="yandex-verification" content="35a3887ea995a4c4"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-63037633-1"></script><script>
                            window.dataLayer = window.dataLayer || [];
                            function gtag(){dataLayer.push(arguments);}
                            gtag('js', new Date());
                            gtag('config', 'UA-63037633-1');
                    </script><style>@import url(&#x27;https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300&amp;family=Spectral:wght@300&amp;display=swap&#x27;);</style><title>sun.security.validator.ValidatorException: PKIX path building failed in Salesforce</title><meta name="next-head-count" content="24"/><link rel="preload" href="/_next/static/css/b1d2ccc43e219fe79039.css" as="style"/><link rel="stylesheet" href="/_next/static/css/b1d2ccc43e219fe79039.css" data-n-g=""/><link rel="preload" href="/_next/static/css/6dce80f39b6e217927f5.css" as="style"/><link rel="stylesheet" href="/_next/static/css/6dce80f39b6e217927f5.css" data-n-p=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-a7c970f167496c3f3d8f.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.ef157c678a62cfb2c073.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.0cd3f0b406132b99fef1.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-5fb99929e827bf9b07ad.js" as="script"/><link rel="preload" href="/_next/static/chunks/1d62a1056678c2f23610de94ff6f49e06a569636.2116ac35632db79554b8.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5Bid%5D-f26bd131465ef7dfa7da.js" as="script"/></head><body><script src="noflash.js"></script><script src="PathSolver.js"></script><div id="__next"><div class="layout_container__2t4v2"><header class="layout_header__2rhWq"><div class="navbar-link"><a class="layout_devNull__6Fs9d" href="/">$ /dev/null</a>———<a class="layout_devNull__6Fs9d" href="/about">About </a>———<a class="layout_devNull__6Fs9d" href="https://pavel-slepenkov.github.io">Projects</a></div><div class="DarkModeToggle_darkModeToggle__2u4u3"><button type="button">☀</button><toggle></toggle><button type="button">☾</button></div></header><main><article><h1 class="utils_headingXl__1XecN">sun.security.validator.ValidatorException: PKIX path building failed in Salesforce</h1><div class="utils_lightText__12Ckm"><time dateTime="2019-04-09T10:54:13+01:00">April 9, 2019</time></div><div><p>Working on integration Salesforce with external system and vice versa through both REST and SOAP APIs you might get the following exception</p>
<div class="remark-highlight"><pre class="language-java"><code class="language-java">sun<span class="token punctuation">.</span>security<span class="token punctuation">.</span>validator<span class="token punctuation">.</span><span class="token class-name">ValidatorException</span><span class="token operator">:</span>
PKIX path building failed<span class="token operator">:</span>
sun<span class="token punctuation">.</span>security<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>certpath<span class="token punctuation">.</span><span class="token class-name">SunCertPathBuilderException</span><span class="token operator">:</span>
unable <span class="token keyword">to</span> <span class="token namespace">find</span> valid certification path <span class="token keyword">to</span> <span class="token namespace">requested</span> target
</code></pre></div>
<p><strong>1. Salesforce to external system integration errors</strong></p>
<p>The first thing to check is certificate on external system side. Most likely the problem is on this side.</p>
<p>1.1 The problem with certificate itself. Any issue with certificate on 3rd party side will cause the error. You can check this <a href="https://badssl.com/">site</a> for more details and examples on certificates issues.</p>
<p><img src="/images/p1016/insecure-connection.png" alt="insecure connection"></p>
<p><strong>Here’re a few possible reason why certificate is not trusted:</strong></p>
<ol>
<li>certificate is expired</li>
<li>certificate is for a wrong host</li>
<li>certificate is self-signed</li>
<li>certificate with untrusted root</li>
<li>certificate is revoked</li>
<li>certificate is invalid by <a href="https://en.wikipedia.org/wiki/HTTP_Public_Key_Pinning">key pinning</a></li>
</ol>
<p>The only possible solution for these cases is to install correct certificate on a server.</p>
<p>1.2 When certificate on a server is <strong>valid</strong> and you can access the host by <strong>browser</strong> with no error it might be a sign of a broken certificate <a href="https://en.wikipedia.org/wiki/Chain_of_trust">chain of trust</a>.</p>
<blockquote>
<p>Salesforce’s certificate trust policy is to require server and client certificate chains to include all intermediate certificates that exist between the server or client certificate and the chain’s root certificate</p>
</blockquote>
<p>You can review salesforce trusted certificates via https://YOUR-INSTANCE.salesforce.com/cacerts.jsp (<a href="https://slepenkov-dev-ed.my.salesforce.com/cacerts.jsp">https://slepenkov-dev-ed.my.salesforce.com/cacerts.jsp)</a></p>
<p>Most probably the server has no intermediate, root CA or several certificates installed/added and thus these certificates are not added to the server response during handshake.</p>
<p>On server you need to have all certificates in the chain. Different servers has different configuration and different locations for a certificates but in any case server must provide a whole chain to a client in order to be trusted. Structured in the following way</p>
<p><img src="/images/p1016/cert-chain-structure.png" alt="cert-chain-structure"></p>
<p>You can verify this case with the following command:</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">openssl s_client -connect techcrunch.com:443
</code></pre></div>
<p>Valid result will be as follow:</p>
<p><img src="/images/p1016/image-3.png" alt=""></p>
<p>When chain is broken the same command will produce the following result:</p>
<p><img src="/images/p1016/image-4.png" alt=""></p>
<p>with final error messages</p>
<p><code>Verify return code: 21 (unable to verify the first certificate)</code></p>
<p>or</p>
<p><code>verify return code: 20 (unable to get local issuer certificate)</code></p>
<p>All you need to fix that is to add root CA certificate and/or intermediate certificates if needed in order to send server response with entire certificates chain during the handshake.</p>
<p><strong>2. External System to Salesforce</strong></p>
<p>When connecting to Salesforce from external application you might get the same error. This time error means that you server have no some salesforce chain of trust certificates. You can add it one by one or as a certificate bundle to your server.</p>
<p>Just download certificates chain with this command</p>
<p><code>openssl s_client -showcerts -connect slepenkov-dev-ed.my.salesforce.com:443</code></p>
<p>The output will contain all certificates in chain and you can copy and add it to your server certificate store.</p>
<p><img src="/images/p1016/image-5.png" alt=""></p>
</div></article><div><span class="utils_tag__38-Vr"><a href="/tag/salesforce">[<!-- -->salesforce<!-- -->]</a></span><span class="utils_tag__38-Vr"><a href="/tag/salesforce-errors">[<!-- -->salesforce errors<!-- -->]</a></span><span class="utils_tag__38-Vr"><a href="/tag/security">[<!-- -->security<!-- -->]</a></span><span class="utils_tag__38-Vr"><a href="/tag/ssl">[<!-- -->ssl<!-- -->]</a></span><span class="utils_tag__38-Vr"><a href="/tag/web-services">[<!-- -->web-services<!-- -->]</a></span></div></main><div class="layout_backToHome__1vZsp"><a href="/">⇐ back to home</a></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"p1016","contentHtml":"\u003cp\u003eWorking on integration Salesforce with external system and vice versa through both REST and SOAP APIs you might get the following exception\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-java\"\u003e\u003ccode class=\"language-java\"\u003esun\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003esecurity\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003evalidator\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eValidatorException\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\nPKIX path building failed\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\nsun\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003esecurity\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eprovider\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecertpath\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eSunCertPathBuilderException\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\nunable \u003cspan class=\"token keyword\"\u003eto\u003c/span\u003e \u003cspan class=\"token namespace\"\u003efind\u003c/span\u003e valid certification path \u003cspan class=\"token keyword\"\u003eto\u003c/span\u003e \u003cspan class=\"token namespace\"\u003erequested\u003c/span\u003e target\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003cstrong\u003e1. Salesforce to external system integration errors\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eThe first thing to check is certificate on external system side. Most likely the problem is on this side.\u003c/p\u003e\n\u003cp\u003e1.1 The problem with certificate itself. Any issue with certificate on 3rd party side will cause the error. You can check this \u003ca href=\"https://badssl.com/\"\u003esite\u003c/a\u003e for more details and examples on certificates issues.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/p1016/insecure-connection.png\" alt=\"insecure connection\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eHere’re a few possible reason why certificate is not trusted:\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003ecertificate is expired\u003c/li\u003e\n\u003cli\u003ecertificate is for a wrong host\u003c/li\u003e\n\u003cli\u003ecertificate is self-signed\u003c/li\u003e\n\u003cli\u003ecertificate with untrusted root\u003c/li\u003e\n\u003cli\u003ecertificate is revoked\u003c/li\u003e\n\u003cli\u003ecertificate is invalid by \u003ca href=\"https://en.wikipedia.org/wiki/HTTP_Public_Key_Pinning\"\u003ekey pinning\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eThe only possible solution for these cases is to install correct certificate on a server.\u003c/p\u003e\n\u003cp\u003e1.2 When certificate on a server is \u003cstrong\u003evalid\u003c/strong\u003e and you can access the host by \u003cstrong\u003ebrowser\u003c/strong\u003e with no error it might be a sign of a broken certificate \u003ca href=\"https://en.wikipedia.org/wiki/Chain_of_trust\"\u003echain of trust\u003c/a\u003e.\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eSalesforce’s certificate trust policy is to require server and client certificate chains to include all intermediate certificates that exist between the server or client certificate and the chain’s root certificate\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eYou can review salesforce trusted certificates via https://YOUR-INSTANCE.salesforce.com/cacerts.jsp (\u003ca href=\"https://slepenkov-dev-ed.my.salesforce.com/cacerts.jsp\"\u003ehttps://slepenkov-dev-ed.my.salesforce.com/cacerts.jsp)\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eMost probably the server has no intermediate, root CA or several certificates installed/added and thus these certificates are not added to the server response during handshake.\u003c/p\u003e\n\u003cp\u003eOn server you need to have all certificates in the chain. Different servers has different configuration and different locations for a certificates but in any case server must provide a whole chain to a client in order to be trusted. Structured in the following way\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/p1016/cert-chain-structure.png\" alt=\"cert-chain-structure\"\u003e\u003c/p\u003e\n\u003cp\u003eYou can verify this case with the following command:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003eopenssl s_client -connect techcrunch.com:443\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eValid result will be as follow:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/p1016/image-3.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen chain is broken the same command will produce the following result:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/p1016/image-4.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003ewith final error messages\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eVerify return code: 21 (unable to verify the first certificate)\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eor\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003everify return code: 20 (unable to get local issuer certificate)\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eAll you need to fix that is to add root CA certificate and/or intermediate certificates if needed in order to send server response with entire certificates chain during the handshake.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e2. External System to Salesforce\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eWhen connecting to Salesforce from external application you might get the same error. This time error means that you server have no some salesforce chain of trust certificates. You can add it one by one or as a certificate bundle to your server.\u003c/p\u003e\n\u003cp\u003eJust download certificates chain with this command\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eopenssl s_client -showcerts -connect slepenkov-dev-ed.my.salesforce.com:443\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eThe output will contain all certificates in chain and you can copy and add it to your server certificate store.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/p1016/image-5.png\" alt=\"\"\u003e\u003c/p\u003e\n","title":"sun.security.validator.ValidatorException: PKIX path building failed in Salesforce","date":"2019-04-09T10:54:13+01:00","status":"publish","permalink":"/?p=1016","author":"pavel","excerpt":"","type":"post","category":["salesforce.com","security","web-services"],"tag":["salesforce","salesforce errors","security","ssl","web-services"],"post_format":[]}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"p1016"},"buildId":"u-K26vKNrPbVPDLCTxanK","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-fa276ba060a4a8ac7eef.js"></script><script src="/_next/static/chunks/main-a7c970f167496c3f3d8f.js" async=""></script><script src="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" async=""></script><script src="/_next/static/chunks/framework.ef157c678a62cfb2c073.js" async=""></script><script src="/_next/static/chunks/commons.0cd3f0b406132b99fef1.js" async=""></script><script src="/_next/static/chunks/pages/_app-5fb99929e827bf9b07ad.js" async=""></script><script src="/_next/static/chunks/1d62a1056678c2f23610de94ff6f49e06a569636.2116ac35632db79554b8.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-f26bd131465ef7dfa7da.js" async=""></script><script src="/_next/static/u-K26vKNrPbVPDLCTxanK/_buildManifest.js" async=""></script><script src="/_next/static/u-K26vKNrPbVPDLCTxanK/_ssgManifest.js" async=""></script></body></html>