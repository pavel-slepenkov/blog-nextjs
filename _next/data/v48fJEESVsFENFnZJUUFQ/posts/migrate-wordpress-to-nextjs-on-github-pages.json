{"pageProps":{"postData":{"id":"migrate-wordpress-to-nextjs-on-github-pages","contentHtml":"<p>Wordpress is a way to go solution for many projects. I was using it for a many years in a different projects.\nBut when you're developer there's too much pain expecially for personal blog</p>\n<ul>\n<li>heaviness\n<ul>\n<li>pluging can make site very heavy to load</li>\n<li>3rd party plugins with unknown components inside</li>\n</ul>\n</li>\n<li>hosting &#x26; security\n<ul>\n<li>possible security issues and eternal port scaning. If you check server access logs you'll find port scanning almost every minute, ssh scanning</li>\n<li>hosting payments. Not so big deal but anyway as I'll use GitHub pages for hosting this point is a small benifit.</li>\n</ul>\n</li>\n<li>plugins vs coplicated customizations\n<ul>\n<li>when you need to add some simple functionality you have to use 3rd party plugin or make all the changes from scratch in PHP with all possible pitfalls on the way</li>\n</ul>\n</li>\n</ul>\n<p>This was my motivation to move to static site generators and GitHub pages. A quick look to the <a href=\"https://jamstack.org/generators/\">landscape of SSG</a> brought me a few candidate - Next.js and Gatsby because the use Javascript and React. The choice was made by coin and Next.js won.</p>\n<p>What are your benefits of using SSG?</p>\n<ul>\n<li>HTML - old good html, it's blazing fast. It will be highly reated by Google.</li>\n<li>Markdown's driven post writing experience. That's fantastic when you can use your favorite text editor with all tricks you've learned over the years.</li>\n<li>Absolute control over content and styling (which can be an issue on Wordpress after major releases of some plugins)</li>\n</ul>\n<p>Part 1 contains the following parts:</p>\n<ul>\n<li>Initial project's setup</li>\n<li>Deploy to GitHub via <a href=\"https://github.com/features/actions\">GirHub Actions</a></li>\n<li>Some pain with data migration</li>\n<li>Custom domain</li>\n</ul>\n<hr/>\n<p><ps1><strong>1. Initial setup</strong></ps1> is pretty easy</p>\n<p>1.1 setup GitHub repo to host your project.\n2 options here - setup your personal/org repo on your-username.github.io or to enable GitHub pages inside other repo. I already had personal repo so I decided to create new one in separate repo.</p>\n<p><img src=\"/images/p1066/gh-repo-setup.png\" alt=\"\"></p>\n<p>Then you need to go to the repository's settings and select branch which contains publishing sources in <strong>GitHub Pages</strong> section.\nIn my case a <strong>master</strong> branch containts a nextjs code, markdown, resources, etc and <strong>gh-pages</strong> branch contains static html generated from sources in <strong>master</strong> branch. So select <strong>gh-pages</strong> and root folder. Here's <a href=\"https://docs.github.com/en/github/working-with-github-pages/configuring-a-publishing-source-for-your-github-pages-site\">official instruction</a>. As a result I got a site running under <strong>https://pavel-slepenkov.github.io/blog-nextjs</strong>.</p>\n<p>1.2 Clone github repo to local machine</p>\n<div class=\"remark-highlight\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> clone git@github.com:your-username/your-username.github.io.git\nor\n<span class=\"token function\">git</span> clone git@github.com:your-username/repo-name.git\n</code></pre></div>\n<p>in case if you configure GitHub pages in other repo</p>\n<p>1.3 To start working with Next.js I recommend to spend some time with <a href=\"https://nextjs.org/learn/basics/create-nextjs-app\">official guide</a> (<em>Yes, you're right I just copied base tempate of the tutorial and use it for this blog ü§∑‚Äç‚ôÇÔ∏è</em>). Here's almost nothing to write about.</p>\n<p>in short</p>\n<div class=\"remark-highlight\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">cd</span> your-project-repo-local-folder\nnpx create-next-app src\n<span class=\"token function\">npm</span> run dev\n</code></pre></div>\n<p>now you can check <strong>http://localhost:3000</strong> and see\n<img src=\"/images/p1066/next-js-start-page.png\" alt=\"\"></p>\n<p>In this point I recommend to go though official guide and make some initial version of your site. Do not forget to add your changes to a version control from time to time.</p>\n<hr/>\n<p><ps1><strong>2. Deploy</strong></ps1> can be a kinda tricky if you was never working with <a href=\"https://github.com/features/actions\">GitHub actions</a>.</p>\n<p>2.1 create the following folder structure in your project's root directory in the same level with src folder</p>\n<div class=\"remark-highlight\"><pre class=\"language-bash\"><code class=\"language-bash\">.github/\n‚îî‚îÄ‚îÄ workflows\n    ‚îî‚îÄ‚îÄ main.yml\n</code></pre></div>\n<p><strong>main.yml</strong></p>\n<div class=\"remark-highlight\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build and Deploy\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> master\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">build-and-deploy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">defaults</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">working-directory</span><span class=\"token punctuation\">:</span> ./src\n\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Checkout üõéÔ∏è\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v2.3.1\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">persist-credentials</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Cache  üíæ\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/cache@v2\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> github.workspace <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>/.next/cache\n          <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> runner.os <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">-</span>nextjs<span class=\"token punctuation\">-</span>$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> hashFiles('<span class=\"token important\">**/package-lock.json')</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Install and Build üîß\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\"></span>\n<span class=\"token scalar string\">          npm install</span>\n<span class=\"token scalar string\">          npm run build</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Deploy üöÄ\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> JamesIves/github<span class=\"token punctuation\">-</span>pages<span class=\"token punctuation\">-</span>deploy<span class=\"token punctuation\">-</span>action@3.7.1\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">GITHUB_TOKEN</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.GITHUB_TOKEN <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">BRANCH</span><span class=\"token punctuation\">:</span> gh<span class=\"token punctuation\">-</span>pages <span class=\"token comment\"># The branch the action should deploy to.</span>\n          <span class=\"token key atrule\">FOLDER</span><span class=\"token punctuation\">:</span> src/out <span class=\"token comment\"># The folder the action should deploy.</span>\n          <span class=\"token key atrule\">CLEAN</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span> <span class=\"token comment\"># Automatically remove deleted files from the deploy branch</span>\n</code></pre></div>\n<p>The build contains 4 steps:</p>\n<ul>\n<li><ps3>Checkout</ps3> sources from master branch (do not forget to change it to name of branch which you use as default)</li>\n<li><ps3>Cache</ps3> action allows caching dependencies and build outputs to improve workflow execution time.</li>\n<li><ps3>Install and Build</ps3> just run npm commands.</li>\n<li><ps3>Deploy</ps3> automatically deploys your project to GitHub Pages. I highly recommend to check out this project's <a href=\"https://github.com/JamesIves/github-pages-deploy-action\">home page</a> and read the docs. It has many options which can be useful.</li>\n</ul>\n<p>2.2 tune <strong>package.json</strong></p>\n<p>when you created a project with npx <strong>package.json</strong> looks like that</p>\n<div class=\"remark-highlight\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"src\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"0.1.0\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"private\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"dev\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"next dev\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"build\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"next build\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"start\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"next start\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"dependencies\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"next\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"10.0.5\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"react\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"17.0.1\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"react-dom\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"17.0.1\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>but GitHub deployment requires some tuning in build step</p>\n<div class=\"remark-highlight\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token string\">\"build\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"next build &#x26;&#x26; next export &#x26;&#x26; touch out/.nojekyll\"</span><span class=\"token punctuation\">,</span>\n</code></pre></div>\n<p>lets check each step here</p>\n<ul>\n<li><code>next build</code> builds the production application</li>\n<li><code>next export</code> allows you to export your app to static HTML, which can be run standalone without the need of a Node.js server. That's just what we want.</li>\n<li><code>touch out/.nojekyll</code> creates file which required for bypassing Jekyll processing on GitHub Pages. This's necessary if your site uses files or directories that start with underscores since Jekyll considers these to be special resources and does not copy them to the final site.</li>\n</ul>\n<p><em>You can also create .nojekyll file directly in gh-pages branch and github-pages-deploy-action should not to remove/rewrite it.</em></p>\n<p>After all you can commit these changes and push it to GitHub. If you did all the steps in correct way you will find GitHub Action running in your repo</p>\n<p><img src=\"/images/p1066/im1.png\" alt=\"\"></p>\n<p>And withing 2 minutes you'll get your site up and running.</p>\n<hr/>\n<p><ps1>3. But what about migration?</ps1></p>\n<p><em>Yeah, you need to migrate a content and might be styles and functionality of your initial site.</em></p>\n<p>For data migration I used <a href=\"https://github.com/tinacms/wp-gatsby-markdown-exporter\">WP-Gatsby Markdown Exporter plugin</a>. It allows me to download all data from my Wordpress site as archive with markdown files for posts and pages, images. To be honest that's no a very convenient way because this markdown might be corrupted in many places. Mostly for code formatted with some funcy wordpress plugin. But anyway that's a good start. I moved all markdown files into posts catalog and just pushed it to GitHub. In just a five minutes I had all posts hosted on new blog. Yes, it required a fixes and I spent some time on it as well as moving images to correct location and linking it with posts. As I have not so many posts on my blog this was not a big deal. If you have hundreds or thouthands of posts it might be real headache and I'd recommend to research for more advanced option for moving content. It might be a more advanced wp - markdown migration plugin, or it might be that you will create some script which automate this routine job. Anyway your content is differ and you need to find your own approach to this.</p>\n<p>Style and functionality migrations are out of scope of this post. But if you start with SSG I believe you can code and it's not a big deal to move styling. I'll cover some such things in part 2.</p>\n<hr/>\n<p><ps1>4. Custom domain</ps1></p>\n<p>It's pretty easy part because there's a <a href=\"https://docs.github.com/en/github/working-with-github-pages/managing-a-custom-domain-for-your-github-pages-site\">good official documentation</a></p>\n<ul>\n<li>\n<p>Configure repo to use custom domain\n<img src=\"/images/p1066/gh-repo-setup-custom-domain.png\" alt=\"custom domain setup\">\nNote <strong>Enforce HTTPS</strong> checkbox</p>\n</li>\n<li>\n<p>Configure DNS\n<img src=\"/images/p1066/godaddy.png\" alt=\"DNS config\"></p>\n</li>\n<li>\n<p>Add CNAME file which contains domain name to your repository. In my case this file must be in <strong>gh-pages</strong> branch. You can directly commit this file or add one more command to build step <code>&#x26;&#x26; echo 'pavelslepenkov.info' >> out/CNAME</code></p>\n</li>\n</ul>\n<p>Wait some time for DNS update. Check your site on http:// and https:// version. Than check https://www.yourdomain.com and cry because most probably it will show some sort privacy error.\nTo overcome this I did a trick (<em>I hope it will help you too, but github can change anything in it's enginee in future</em>)</p>\n<ol>\n<li>add www. in custom domain setup and save. Enforce HTTPS can be unckeckable in this point.</li>\n<li>wait until your site start to respond to www. subdomain</li>\n<li>roll back changes in github setup and set domain to version withou www, check Enforce HTTPS.</li>\n</ol>\n<hr/>\n<p>Finally my project structure looks like that\n<strong>master branch</strong> which contains all the code\n<img src=\"/images/p1066/master-branch.png\" alt=\"\"></p>\n<p><strong>gh-pages branch</strong> which contains statically generated version which hosted on Github pages\n<img src=\"/images/p1066/gh-pages-branch.png\" alt=\"\"></p>\n<p>That's all for today</p>\n","title":"Migrate Wordpress blog to Next.js on Github pages - part 1","date":"2020-12-29T10:30:35+00:00","permalink":"/?p=1066","author":"pavel","type":"post","tag":["nextjs","wordpress","javascript","github","GitHub Actions"],"post_format":[]}},"__N_SSG":true}