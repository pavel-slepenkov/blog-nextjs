{"pageProps":{"postData":{"id":"ansible-permission-denied-publickey","contentHtml":"<p>In many deploy scenarios you need to clone/checkout sources from private repository to remote machine. While with Ansible it should be simple task you can face some nuances.</p>\n<p>Cloning private repo requires checking your access rights to this repository and most common way to do this is to use ssh key which has access to the repo. In fact Ansible performs all operations on remote machine via ssh. It should be a piece of cake in this circumstances.</p>\n<div class=\"remark-highlight\"><pre class=\"language-bash\"><code class=\"language-bash\">ansible-playbook <span class=\"token parameter variable\">-vvv</span> <span class=\"token parameter variable\">-i</span> inventory deploy.yml --vault-id ~/.my_vault\n</code></pre></div>\n<p>it works just fine before <a href=\"https://docs.ansible.com/ansible/latest/collections/ansible/builtin/git_module.html\">git clone task</a></p>\n<div class=\"remark-highlight\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Pull sources from the repository\n  <span class=\"token key atrule\">become</span><span class=\"token punctuation\">:</span> yes\n  <span class=\"token key atrule\">become_user</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"{{ project.user }}\"</span>\n  <span class=\"token key atrule\">git</span><span class=\"token punctuation\">:</span> repo=<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> repo.url <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span> dest=<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> project.path <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>/app/ version=<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> repo.branch <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span> force=yes update=yes\n</code></pre></div>\n<p>and now I got</p>\n<div class=\"remark-highlight\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token operator\">&#x3C;</span>ec2-127-0-0-1.eu-0.compute.amazonaws.com<span class=\"token operator\">></span> ESTABLISH SSH CONNECTION FOR <span class=\"token environment constant\">USER</span><span class=\"token builtin class-name\">:</span> pavel\n\n<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>\n\nfatal: <span class=\"token punctuation\">[</span>ec2-127-0-0-1.eu-0.compute.amazonaws.com<span class=\"token punctuation\">]</span>: FAILED<span class=\"token operator\">!</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"changed\"</span><span class=\"token builtin class-name\">:</span> false,\n    <span class=\"token string\">\"cmd\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token string\">\"/usr/bin/git\"</span>,\n        <span class=\"token string\">\"fetch\"</span>,\n        <span class=\"token string\">\"--tags\"</span>,\n        <span class=\"token string\">\"--force\"</span>,\n        <span class=\"token string\">\"origin\"</span>\n    <span class=\"token punctuation\">]</span>,\n    <span class=\"token string\">\"invocation\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"module_args\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"accept_hostkey\"</span><span class=\"token builtin class-name\">:</span> true,\n            <span class=\"token string\">\"archive\"</span><span class=\"token builtin class-name\">:</span> null,\n            <span class=\"token string\">\"archive_prefix\"</span><span class=\"token builtin class-name\">:</span> null,\n            <span class=\"token string\">\"bare\"</span><span class=\"token builtin class-name\">:</span> false,\n            <span class=\"token string\">\"clone\"</span><span class=\"token builtin class-name\">:</span> true,\n            <span class=\"token string\">\"depth\"</span><span class=\"token builtin class-name\">:</span> null,\n            <span class=\"token string\">\"dest\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"/home/pavel/app/\"</span>,\n            <span class=\"token string\">\"executable\"</span><span class=\"token builtin class-name\">:</span> null,\n            <span class=\"token string\">\"force\"</span><span class=\"token builtin class-name\">:</span> true,\n            <span class=\"token string\">\"gpg_whitelist\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>,\n            <span class=\"token string\">\"key_file\"</span><span class=\"token builtin class-name\">:</span> null,\n            <span class=\"token string\">\"recursive\"</span><span class=\"token builtin class-name\">:</span> true,\n            <span class=\"token string\">\"reference\"</span><span class=\"token builtin class-name\">:</span> null,\n            <span class=\"token string\">\"refspec\"</span><span class=\"token builtin class-name\">:</span> null,\n            <span class=\"token string\">\"remote\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"origin\"</span>,\n            <span class=\"token string\">\"repo\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"git@github.com:TargetProcess/pavel.git\"</span>,\n            <span class=\"token string\">\"separate_git_dir\"</span><span class=\"token builtin class-name\">:</span> null,\n            <span class=\"token string\">\"ssh_opts\"</span><span class=\"token builtin class-name\">:</span> null,\n            <span class=\"token string\">\"track_submodules\"</span><span class=\"token builtin class-name\">:</span> false,\n            <span class=\"token string\">\"umask\"</span><span class=\"token builtin class-name\">:</span> null,\n            <span class=\"token string\">\"update\"</span><span class=\"token builtin class-name\">:</span> true,\n            <span class=\"token string\">\"verify_commit\"</span><span class=\"token builtin class-name\">:</span> false,\n            <span class=\"token string\">\"version\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"my-cool-branch\"</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>,\n    <span class=\"token string\">\"msg\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Failed to download remote objects and refs:  git@github.com: Permission denied (publickey).</span>\n<span class=\"token string\">        fatal: Could not read from remote repository.</span>\n<span class=\"token string\">        Please make sure you have the correct access rights and the repository exists.\"</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>To fix this I suggest to use <strong>ssh forwarding</strong> and forward key from local machine to remote (Key should be added to private repo access list (for GitHub it's a deployment keys))</p>\n<p>The first step is to <ps1>allow agent forwarding</ps1></p>\n<div class=\"remark-highlight\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># vi ~/.ssh/config</span>\nHost *\n    StrictHostKeyChecking no\n\nHost ec2-127-0-0-1.eu-0.compute.amazonaws.com\nIdentityFile /home/remote_machine_user/.ssh/id_rsa\nUser pavel\nForwardAgent <span class=\"token function\">yes</span>\n</code></pre></div>\n<p>Next step is to <ps1>add your key to ssh agent</ps1></p>\n<p>On ssh session you can do it with commands</p>\n<div class=\"remark-highlight\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">eval</span> <span class=\"token variable\"><span class=\"token variable\">`</span>ssh-agent <span class=\"token parameter variable\">-s</span><span class=\"token variable\">`</span></span>\nssh-add ~/.ssh/id_rsa\n</code></pre></div>\n<p>But it won't work in TeamCity without some configuration via UI.</p>\n<ol>\n<li>Open project's administartion page and upload SSH Key which you want to add to ssh-agent on build time\n<img src=\"/images/p1070/1.png\" alt=\"\"></li>\n</ol>\n<hr/>\n<p><img src=\"/images/p1070/2.png\" alt=\"\"></p>\n<ol start=\"2\">\n<li>Open Build Configuration settings and add <strong>Build Feature</strong> <ps1>SSH agent</ps1>\n<img src=\"/images/p1070/3.png\" alt=\"\"></li>\n</ol>\n<p>After this build step git clone should work fine and you can start fixing next failed step ðŸ¤¯ðŸ¤¬</p>\n","title":"Ansible: Permission denied (publickey) and TeamCity","date":"2021-02-02T00:30:33+00:00","permalink":"/?p=1070","author":"pavel","type":"post","tag":["ansible","deployment","deployment errors","ansible-playbook","git","GitHub"],"post_format":[]}},"__N_SSG":true}