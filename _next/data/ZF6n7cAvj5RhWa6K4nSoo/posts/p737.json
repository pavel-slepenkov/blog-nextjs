{"pageProps":{"postData":{"id":"p737","contentHtml":"<p>That's quite common case when you face the following errors during deployment:</p>\n<div class=\"remark-highlight\"><pre class=\"language-java\"><code class=\"language-java\">profiles<span class=\"token operator\">/</span><span class=\"token class-name\">Admin</span><span class=\"token punctuation\">.</span>profile — <span class=\"token class-name\">Error</span><span class=\"token operator\">:</span> <span class=\"token class-name\">Unknown</span> user permission<span class=\"token operator\">:</span> <span class=\"token class-name\">EditBillingInfo</span><span class=\"token operator\">&#x3C;</span><span class=\"token operator\">/</span>span<span class=\"token operator\">></span>\nprofiles<span class=\"token operator\">/</span><span class=\"token class-name\">Admin</span><span class=\"token punctuation\">.</span>profile — <span class=\"token class-name\">Error</span><span class=\"token operator\">:</span> <span class=\"token class-name\">Unknown</span> user permission<span class=\"token operator\">:</span> <span class=\"token class-name\">ManageSandboxes</span><span class=\"token operator\">&#x3C;</span><span class=\"token operator\">/</span>span<span class=\"token operator\">></span>\nprofiles<span class=\"token operator\">/</span><span class=\"token class-name\">Admin</span><span class=\"token punctuation\">.</span>profile — <span class=\"token class-name\">Error</span><span class=\"token operator\">:</span> <span class=\"token class-name\">Unknown</span> user permission<span class=\"token operator\">:</span> <span class=\"token class-name\">SocialInsightsLogoAdmin</span><span class=\"token operator\">&#x3C;</span><span class=\"token operator\">/</span>span<span class=\"token operator\">></span>\nprofiles<span class=\"token operator\">/</span><span class=\"token class-name\">Admin</span><span class=\"token punctuation\">.</span>profile — <span class=\"token class-name\">Error</span><span class=\"token operator\">:</span> <span class=\"token class-name\">Unknown</span> user permission<span class=\"token operator\">:</span> <span class=\"token class-name\">EditPublicReports</span>\nprofiles<span class=\"token operator\">/</span><span class=\"token class-name\">Admin</span><span class=\"token punctuation\">.</span>profile — <span class=\"token class-name\">Error</span><span class=\"token operator\">:</span> <span class=\"token class-name\">Unknown</span> user permission<span class=\"token operator\">:</span> <span class=\"token class-name\">DataExport</span>\n</code></pre></div>\n<p>Usually it means you trying to deploy the org which has no features which source org has. It might be a case when you deploy from Production to Sandbox or from some production org to developer edition. All what you can do with this error is to clean up profiles. Usually you do that by hand in any text editor. But I decided to build a small script in python which will do all the stuff automatically during deployment.</p>\n<div class=\"remark-highlight\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> os\n<span class=\"token keyword\">from</span> xml<span class=\"token punctuation\">.</span>etree <span class=\"token keyword\">import</span> cElementTree <span class=\"token keyword\">as</span> et\n\n<span class=\"token builtin\">dir</span> <span class=\"token operator\">=</span> <span class=\"token string\">'../src/profiles/'</span>\nnodes_to_remove <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'EditBillingInfo'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'ManageSandboxes'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'SocialInsightsLogoAdmin'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">clean_profile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    et<span class=\"token punctuation\">.</span>register_namespace<span class=\"token punctuation\">(</span>”<span class=\"token punctuation\">,</span> <span class=\"token string\">\"http://soap.sforce.com/2006/04/metadata\"</span><span class=\"token punctuation\">)</span>\n    tr <span class=\"token operator\">=</span> et<span class=\"token punctuation\">.</span>parse<span class=\"token punctuation\">(</span>xml_file<span class=\"token punctuation\">)</span>\n    root <span class=\"token operator\">=</span> tr<span class=\"token punctuation\">.</span>getroot<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">for</span> child <span class=\"token keyword\">in</span> root<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">if</span> <span class=\"token string\">'userPermissions'</span> <span class=\"token keyword\">in</span> child<span class=\"token punctuation\">.</span>tag<span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">for</span> element <span class=\"token keyword\">in</span> child<span class=\"token punctuation\">:</span>\n                <span class=\"token keyword\">for</span> node <span class=\"token keyword\">in</span> nodes_to_remove<span class=\"token punctuation\">:</span>\n                    <span class=\"token keyword\">if</span> <span class=\"token string\">'name'</span> <span class=\"token keyword\">in</span> element<span class=\"token punctuation\">.</span>tag <span class=\"token keyword\">and</span> node <span class=\"token keyword\">in</span> element<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">:</span>\n                        root<span class=\"token punctuation\">.</span>remove<span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">)</span>\n                        <span class=\"token keyword\">break</span>\n    <span class=\"token keyword\">return</span> root\n\n<span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">'__main__'</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">for</span> filename <span class=\"token keyword\">in</span> os<span class=\"token punctuation\">.</span>listdir<span class=\"token punctuation\">(</span><span class=\"token builtin\">dir</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">dir</span> <span class=\"token operator\">+</span> filename<span class=\"token punctuation\">,</span> <span class=\"token string\">'r+b'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> xml_file<span class=\"token punctuation\">:</span>\n            result <span class=\"token operator\">=</span> clean_profile<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            xml_str <span class=\"token operator\">=</span> et<span class=\"token punctuation\">.</span>tostring<span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">,</span> encoding<span class=\"token operator\">=</span><span class=\"token string\">'utf-8′, method='</span>xml'<span class=\"token punctuation\">)</span>\n            xml_file<span class=\"token punctuation\">.</span>seek<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n            xml_file<span class=\"token punctuation\">.</span>truncate<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            xml_file<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token string\">b'&#x3C;?xml version=\"1.0\" encoding=\"UTF-8\"?>\\n'</span> <span class=\"token operator\">+</span> xml_str<span class=\"token punctuation\">)</span>\n\n</code></pre></div>\n<p>as you can see you just need to add properties which you want to remove into <code>nodes_to_remove</code></p>\n<p>Usually I put all scripts in <strong>scripts</strong> directory which is on the same level as <strong>src</strong> directory is, but if you want to locate the script in any other location you might need to fix dir variable for correct path to <strong>src/profiles</strong></p>\n<p>and here's a <code>build.xml</code> part which consumes this script</p>\n<div class=\"remark-highlight\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;</span>target</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>deploySandbox<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">description</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Run cleaning scripts (for profiles) and upload source code to Sandbox<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;</span>echo</span> <span class=\"token attr-name\">message</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>••••••••••••••••••••••• SANDBOX DEPLOY •••••••••••••••••••••••<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;</span>echo</span> <span class=\"token attr-name\">message</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Step 1: PROFILES CLEANING:<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;</span>exec</span> <span class=\"token attr-name\">dir</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>scripts<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">executable</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>python3<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">failonerror</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;</span>arg</span> <span class=\"token attr-name\">line</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>profile_cleaner.py results.log<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;/</span>exec</span><span class=\"token punctuation\">></span></span>\n\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;</span>echo</span> <span class=\"token attr-name\">message</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>———————————————————————————————<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;</span>echo</span> <span class=\"token attr-name\">message</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Step 2:<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;</span>echo</span> <span class=\"token attr-name\">message</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Deploy with User Name: ${sf.username} To ${sf.serverurl}<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;</span>!–</span> <span class=\"token attr-name\">Upload</span> <span class=\"token attr-name\">the</span> <span class=\"token attr-name\">contents</span> <span class=\"token attr-name\">of</span> <span class=\"token attr-name\">the</span> <span class=\"token attr-name\">\"src\"</span> <span class=\"token attr-name\">directory</span> <span class=\"token attr-name\">and</span> <span class=\"token attr-name\">run</span> <span class=\"token attr-name\">all</span> <span class=\"token attr-name\">test</span> <span class=\"token attr-name\">–</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;</span><span class=\"token namespace\">sf:</span>deploy</span> <span class=\"token attr-name\">username</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>${sf.username}<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\">password</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>${sf.password}<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\">serverurl</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>${sf.serverurl}<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\">deployRoot</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>src<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\">runAllTests</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\">maxPoll</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>3000<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\">pollWaitMillis</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>150<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\">testLevel</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>RunLocalTests<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;/</span><span class=\"token namespace\">sf:</span>deploy</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;/</span>target</span><span class=\"token punctuation\">></span></span>\n</code></pre></div>\n","title":"Cleaning salesforce profiles before deployment","date":"2016-12-29T14:01:17+00:00","status":"publish","permalink":"/?p=737","author":"pavel","excerpt":"","type":"post","category":["force.com","migration tool","scripts","Uncategorized"],"tag":["ant","ant migration tool","automation","python","script","scripts"],"post_format":[],"dsq_thread_id":["5591329147"]}},"__N_SSG":true}