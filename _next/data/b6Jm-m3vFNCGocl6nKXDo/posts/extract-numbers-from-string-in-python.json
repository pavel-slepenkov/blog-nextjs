{"pageProps":{"postData":{"id":"extract-numbers-from-string-in-python","contentHtml":"<p>Extract numbers from string - <ps2>Realy?!!? What a topic for a blog post?!?</ps2> - you'd say when see that. But wait a minute I'll try to make it a bit interesting.</p>\n<blockquote>\n<p><strong>Disclimer:</strong> This post shows some reflection on a way how to solve software problems as well as practical solution of named problem. There's nothing interesting for seasoned software engineers but less experienced devs can find something useful here</p>\n</blockquote>\n<p>In this post:</p>\n<ul>\n<li>Real life problem</li>\n<li>5 basic solutions</li>\n<li>2 real life solutions</li>\n<li>Benchmark</li>\n</ul>\n<p>Recently one of our ETL pipeline was broken by unexpected input which came from pentesters. They tried to investigate some logging endpoints of the main app and posted JSONs with garbage. Later this JSONs came to etl and destroyed it in part of several workers. These workers grab JSON, parse it, make some additional processing and finally save to database. The part with saving to DB was broken because of type inconsistency.</p>\n<p>Input for a functions which must be a numeric eventually started looking like that</p>\n<div class=\"remark-highlight\"><pre class=\"language-md\"><code class=\"language-md\">{$ 90011000001\n&#x3C;# 172.9000900111\n{% 1792.2542200656937\n&#x3C;#if0\n&#x3C;#if100.023\n</code></pre></div>\n<p>Our ETL processing is running by a bunch of tiny python functions glued by some functional magic. Parsing numbers from string is not a task which you normally need to solve because of API agrements. Thus we have nothing in our utilities. Actually, parsing numbers from string looks awkward from technical perspective if you do not scrape something on web or from files. But the reality is that this is the most correct way to solve the problem.</p>\n<p>Other oprtions to consider:</p>\n<ul>\n<li>filter / ignore all such input because it's only ~0.02% of all</li>\n<li>replace all bad input with None</li>\n<li>catch exception and ignore</li>\n</ul>\n<p>But all these solutions mean to lose some data.</p>\n<p>As our workers process a large amout of data and utilize pretty much resources I preffer not to introduce any new imports for this processor or at least use only standard lib when possible. Also by this reason we need to evaluate performace and choose faster one.</p>\n<p>The first thing I preffer to do when I need to write any new piece of code which I didn't code in the last 6-8 months is to google for the solution. It allows to check if something new came to the scene and update knowledges. I checked a few article and docs, including <a href=\"https://stackoverflow.com/questions/4289331/how-to-extract-numbers-from-a-string-in-python\">stackoverflow</a>.</p>\n<p>Most of the examples are very basic, some limited only to positive integers (<em>This is one of the reasons why I ever started writing this article</em>)</p>\n<p>Lets check these solutions with <code>sentence = 'String with 42, 3.1415 and 1000'</code></p>\n<ol>\n<li>Using Regex Module</li>\n</ol>\n<div class=\"remark-highlight\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> re\ns <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">float</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> s <span class=\"token keyword\">in</span> re<span class=\"token punctuation\">.</span>findall<span class=\"token punctuation\">(</span><span class=\"token string\">r'-?\\d+\\.?\\d*'</span><span class=\"token punctuation\">,</span> sentence<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n<span class=\"token operator\">>></span> <span class=\"token punctuation\">[</span><span class=\"token number\">42</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3.1415</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">]</span>\n</code></pre></div>\n<ol start=\"2\">\n<li>Split and Append The Numbers To A List using <code>split()</code> and <code>append()</code> Functions</li>\n</ol>\n<div class=\"remark-highlight\"><pre class=\"language-python\"><code class=\"language-python\">s <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">for</span> t <span class=\"token keyword\">in</span> sentence<span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n        s<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token builtin\">float</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">except</span> ValueError<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">pass</span>\n<span class=\"token operator\">>></span> <span class=\"token punctuation\">[</span><span class=\"token number\">42</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3.1415</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">]</span>\n</code></pre></div>\n<ol start=\"3\">\n<li>Using <code>nums_from_string</code> library. <code>pip install nums_from_string</code> then</li>\n</ol>\n<div class=\"remark-highlight\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> nums_from_string\nsentence <span class=\"token operator\">=</span> <span class=\"token string\">'Extract 100 , 100.45 and 10000 from this string'</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>nums_from_string<span class=\"token punctuation\">.</span>get_nums<span class=\"token punctuation\">(</span>sentence<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token operator\">>></span> <span class=\"token punctuation\">[</span><span class=\"token number\">42</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3.1415</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">]</span>\n</code></pre></div>\n<p><strong>Solutions limited to only positive integers</strong></p>\n<ol start=\"4\">\n<li>Using isdigit() function in a list comprehension</li>\n</ol>\n<div class=\"remark-highlight\"><pre class=\"language-python\"><code class=\"language-python\">s <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> s <span class=\"token keyword\">in</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span>sentence<span class=\"token punctuation\">)</span> <span class=\"token keyword\">if</span> s<span class=\"token punctuation\">.</span>isdigit<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n<span class=\"token operator\">>></span> <span class=\"token punctuation\">[</span><span class=\"token number\">100</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10000</span><span class=\"token punctuation\">]</span>\n</code></pre></div>\n<p>and varaiation of the above solution\n5. <code>filter</code> + <code>str.isdigit</code> (You can create more complex filter function)</p>\n<div class=\"remark-highlight\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span><span class=\"token builtin\">filter</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">.</span>isdigit<span class=\"token punctuation\">,</span> sentence<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token operator\">>></span> <span class=\"token punctuation\">[</span><span class=\"token number\">100</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10000</span><span class=\"token punctuation\">]</span>\n</code></pre></div>\n<p><em>Actually here're many variation of these basis solutions with some changes.</em></p>\n<p>Finally here're 2 possible solutions which fit for my case and requirements:</p>\n<ul>\n<li>replace <em>bad</em> chars, split string and check every part for numbers</li>\n<li>use regex</li>\n</ul>\n<p>Notes:</p>\n<ul>\n<li>for my case I need to extract only first found number</li>\n<li>I consider 3.14 == 3,14 in string and converts it to a number. That's not a standard approach.</li>\n</ul>\n<p>With StackOverflow in hands most of us start coding just in time when possible solution is found. I try to create tests first.\nSo, lets create a test which allows us to evaluate solutions.</p>\n<div class=\"remark-highlight\"><pre class=\"language-python\"><code class=\"language-python\">test_set <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">\"{% 152.2795837829749\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"{% 1608577297370\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"&#x3C;#if 1608577297618 %%}\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"1608577297618 %%} 88912\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"788\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"89.981\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"n55b30\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\">=123233333332324323\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"&#x26;>>> 1231\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"9000001\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"42\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"bba\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"!@#$%^&#x26;*()231122223\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"-99,01\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"100,001.2000\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"what about very long string ? with a number - 2000.002??? \"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"and ever much much much much much much much much much much much much much much much much much much much much much much much much much much much much much much much much much much much much much much much much much much much much much much much much much much much much much much much much much much much much longer string 10990.2\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"!@#$%^&#x26;*()_+\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"!@#$%^&#x26;*()_+900.42!@#$%^&#x26;*()_+!@#$%^&#x26;*()_+!@#$%^&#x26;*()_+iiiiiiEEEEE^^^^^\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span>\n\nexpected_result <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token number\">152.2795837829749</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1608577297370</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1608577297618</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1608577297618</span><span class=\"token punctuation\">,</span>\n    <span class=\"token number\">788</span><span class=\"token punctuation\">,</span> <span class=\"token number\">89.981</span><span class=\"token punctuation\">,</span> <span class=\"token number\">55</span><span class=\"token punctuation\">,</span> <span class=\"token number\">123233333332324323</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1231</span><span class=\"token punctuation\">,</span> <span class=\"token number\">9000001</span><span class=\"token punctuation\">,</span> <span class=\"token number\">42</span><span class=\"token punctuation\">,</span>\n    <span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> <span class=\"token number\">231122223</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">99.01</span><span class=\"token punctuation\">,</span> <span class=\"token number\">100.001</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2000.002</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10990.2</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> <span class=\"token number\">900.42</span>\n<span class=\"token punctuation\">]</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">run_test</span><span class=\"token punctuation\">(</span>fn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    l <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">for</span> s <span class=\"token keyword\">in</span> test_set<span class=\"token punctuation\">:</span>\n        l<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>fn<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">assert</span> l <span class=\"token operator\">==</span> expected_result\n</code></pre></div>\n<p>I finished with 2 approaches</p>\n<p><ps1>Solution 1</ps1> - replace, split and append</p>\n<p><em>Start with replacing chars which can be clumped with our number, then split string to list, go through each element of the list and try to convert these parts to a numbers - int or float.</em></p>\n<div class=\"remark-highlight\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">sanitize_1</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    l <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">for</span> t <span class=\"token keyword\">in</span> s<span class=\"token punctuation\">.</span>translate<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token builtin\">ord</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\" \"</span> <span class=\"token keyword\">for</span> c <span class=\"token keyword\">in</span> <span class=\"token string\">\"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!@#$%^&#x26;*()[]{};:/&#x3C;>?\\|`~=_+\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n            t <span class=\"token operator\">=</span> t<span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">','</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'.'</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">if</span> <span class=\"token string\">'.'</span> <span class=\"token keyword\">in</span> t<span class=\"token punctuation\">:</span>\n                a1 <span class=\"token operator\">=</span> t<span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">'.'</span><span class=\"token punctuation\">)</span>\n                l<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token builtin\">float</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.'</span><span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>a1<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">:</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n                l<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">break</span>\n        <span class=\"token keyword\">except</span> ValueError<span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">pass</span>\n    <span class=\"token keyword\">return</span> l<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">if</span> l <span class=\"token keyword\">else</span> <span class=\"token boolean\">None</span>\n</code></pre></div>\n<p><em>There's potential problem with this code - <code>split()</code> might create huge list on complex strings and thus increases number of loops with all the stuff inside.</em></p>\n<p><ps1>Solution 2</ps1> use <strong>RegEx</strong>\nUsing of regex is considered to be a slightly bad practice.</p>\n<div class=\"remark-highlight\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">sanitize_2</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    l <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    l<span class=\"token punctuation\">.</span>extend<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token builtin\">float</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">)</span> <span class=\"token keyword\">if</span> <span class=\"token string\">'.'</span> <span class=\"token keyword\">in</span> t <span class=\"token keyword\">else</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> t <span class=\"token keyword\">in</span> re<span class=\"token punctuation\">.</span>findall<span class=\"token punctuation\">(</span><span class=\"token string\">r'[-]?\\d+(?:\\.\\d+)?'</span><span class=\"token punctuation\">,</span> s<span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">','</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'.'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> l<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">if</span> l <span class=\"token keyword\">else</span> <span class=\"token boolean\">None</span>\n</code></pre></div>\n<p>Okay, lets test them on performance. I'm using ipython cell magic <code>%timeit</code> as most simple way to evaluate performance</p>\n<div class=\"remark-highlight\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token operator\">%</span>timeit run_test<span class=\"token punctuation\">(</span>sanitize_1<span class=\"token punctuation\">)</span>\n<span class=\"token operator\">%</span>timeit run_test<span class=\"token punctuation\">(</span>sanitize_2<span class=\"token punctuation\">)</span>\n\n<span class=\"token number\">236</span> µs ± <span class=\"token number\">11.7</span> µs per loop <span class=\"token punctuation\">(</span>mean ± std<span class=\"token punctuation\">.</span> dev<span class=\"token punctuation\">.</span> of <span class=\"token number\">7</span> runs<span class=\"token punctuation\">,</span> <span class=\"token number\">10000</span> loops each<span class=\"token punctuation\">)</span>\n<span class=\"token number\">72.2</span> µs ± <span class=\"token number\">1.12</span> µs per loop <span class=\"token punctuation\">(</span>mean ± std<span class=\"token punctuation\">.</span> dev<span class=\"token punctuation\">.</span> of <span class=\"token number\">7</span> runs<span class=\"token punctuation\">,</span> <span class=\"token number\">10000</span> loops each<span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>Regex approach is much faster, moover it's much shorter and simplier (sure if you know regex)</p>\n<p><img src=\"/images/p1067/perl_problems_2x.png\" alt=\"\"></p>\n<p>That's all, solution #2 won and was deployed</p>\n","title":"Extract numbers from string in python with real life example","date":"2021-01-05T10:30:35+00:00","status":"unpublished","permalink":"/?p=1067","author":"pavel","type":"post","tag":["python","python3","benchmark"]}},"__N_SSG":true}