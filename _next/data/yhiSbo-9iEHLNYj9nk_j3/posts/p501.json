{"pageProps":{"postData":{"id":"p501","contentHtml":"<p>Pretty often you need to know how many times some Contact has been used in Log a Call functionality. Aggregation of such count in an account level might be pretty useful too. So, let's implement this functionality. I faced with such requirement a few times with different customers, so I'd like to share my experience.</p>\n<p>All you know, in the perfect world we should use built-in functionality and avoid a custom implementations. So, firstly I checked for a way to build it with some Salesforce native functionality. First thing which was considered is a Roll-up summary field. But we can't use Roll-up summary fields here, because these object has no master-detail relationship by default. Sure, you can create such relation, but it's no a case for me. The result of quick investigation lets me think that trigger will be an ideal solution for such functionality.</p>\n<p>So, firstly I create 2 fields Reference_Count__c on Contact and Account. Both fields has Number type. After that I create a trigger on Task object which runs <strong>after insert, after update</strong> and <strong>after delete</strong>.</p>\n<p>There are the following cases:</p>\n<ul>\n<li>When user creates task with Type = 'Call' we have to <strong>increment</strong> counter on Contact which is related to this task and also we have to increate a count on Account which is related to Contact.</li>\n<li>When user changes type of task from any to 'Call' we have to <strong>increment</strong> counters.</li>\n<li>When user changes type of task from 'Call' to any other we have to <strong>decrement</strong> counter for Contact and Account related to this task.</li>\n<li>Also we have to <strong>decrement</strong> counters when user removes Task</li>\n</ul>\n<p>You can find a whole solution on <a href=\"https://github.com/pavel-slepenkov/salesforce_solutions/tree/master/reference_count\">GitHub.</a></p>\n<p>Let's break each point to separate method:</p>\n<ol>\n<li>When user creates task with Type = 'Call' we have to increase counter on Contact which is related to this task and also we have to increate a count on Account which is related to Contact.</li>\n</ol>\n<div class=\"remark-highlight\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">increaseReferenceCountOnInsert</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&#x3C;</span>sObject<span class=\"token punctuation\">></span></span> newRecords<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&#x3C;</span>sObject<span class=\"token punctuation\">></span></span> taskRelatedToContact <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&#x3C;</span>sObject<span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">SObject</span> obj <span class=\"token operator\">:</span> newRecords<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span>obj<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'WhoId'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span>CONTACT_RECORDS_PREFIX<span class=\"token punctuation\">)</span> <span class=\"token operator\">&#x26;&#x26;</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span>obj<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Type'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> LOG_A_CALL_TYPE<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            taskRelatedToContact<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">updateReferenceCountField</span><span class=\"token punctuation\">(</span>taskRelatedToContact<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<ol start=\"2\">\n<li>When user changes type of task from any to 'Call' we have to increase counters.</li>\n</ol>\n<div class=\"remark-highlight\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">increaseReferenceCountOnUpdate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&#x3C;</span>sObject<span class=\"token punctuation\">></span></span> newRecords<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&#x3C;</span>ID<span class=\"token punctuation\">,</span> sObject<span class=\"token punctuation\">></span></span> oldRecordsMap<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&#x3C;</span>sObject<span class=\"token punctuation\">></span></span> taskRelatedToContact <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&#x3C;</span>sObject<span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">SObject</span> obj <span class=\"token operator\">:</span> newRecords<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span>obj<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'WhoId'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span>CONTACT_RECORDS_PREFIX<span class=\"token punctuation\">)</span>\n            <span class=\"token operator\">&#x26;&#x26;</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span>obj<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Type'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> LOG_A_CALL_TYPE\n            <span class=\"token operator\">&#x26;&#x26;</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>oldRecordsMap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Id</span><span class=\"token punctuation\">)</span>obj<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Id'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Type'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> LOG_A_CALL_TYPE<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            taskRelatedToContact<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">updateReferenceCountField</span><span class=\"token punctuation\">(</span>taskRelatedToContact<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>The next method is used for 2 cases:\n3) When user changes type of task from 'Call' to any other we have to decrease counter for Contact and Account related to this task.\n4) Also we have to decrease counters when user removes Task</p>\n<div class=\"remark-highlight\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">decreaseReferenceCountOnTaskTypeChange</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&#x3C;</span>sObject<span class=\"token punctuation\">></span></span> newRecords<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&#x3C;</span>ID<span class=\"token punctuation\">,</span> sObject<span class=\"token punctuation\">></span></span> oldRecordsMap<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&#x3C;</span>sObject<span class=\"token punctuation\">></span></span> taskToDecreaseCount <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&#x3C;</span>sObject<span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">SObject</span> obj <span class=\"token operator\">:</span> newRecords<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Trigger</span><span class=\"token punctuation\">.</span>isUpdate<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span>obj<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'WhoId'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span>CONTACT_RECORDS_PREFIX<span class=\"token punctuation\">)</span>\n                <span class=\"token operator\">&#x26;&#x26;</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span>obj<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Type'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> LOG_A_CALL_TYPE\n                <span class=\"token operator\">&#x26;&#x26;</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>oldRecordsMap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Id</span><span class=\"token punctuation\">)</span>obj<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Id'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Type'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> LOG_A_CALL_TYPE<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                taskToDecreaseCount<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Trigger</span><span class=\"token punctuation\">.</span>isDelete <span class=\"token operator\">&#x26;&#x26;</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span>obj<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Type'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> LOG_A_CALL_TYPE <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            taskToDecreaseCount<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">updateReferenceCountField</span><span class=\"token punctuation\">(</span>taskToDecreaseCount<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>You can find that all these methods invoke updateReferenceCountField method</p>\n<div class=\"remark-highlight\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">updateReferenceCountField</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&#x3C;</span>sObject<span class=\"token punctuation\">></span></span> tasks<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Boolean</span> isIncrement<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Map</span><span class=\"token operator\">&#x3C;</span><span class=\"token class-name\">Id</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&#x3C;</span>sObject<span class=\"token punctuation\">></span></span> tasksByContact <span class=\"token operator\">=</span> <span class=\"token function\">splitListBySpecialKey</span><span class=\"token punctuation\">(</span>tasks<span class=\"token punctuation\">,</span> <span class=\"token string\">'WhoId'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&#x3C;</span><span class=\"token class-name\">Contact</span><span class=\"token punctuation\">></span></span> relatedContactsForUpdateCountField <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n        SELECT <span class=\"token class-name\">Id</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Reference_Count__c</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">AccountId</span>\n        FROM <span class=\"token class-name\">Contact</span>\n        WHERE <span class=\"token class-name\">Id</span> IN<span class=\"token operator\">:</span> tasksByContact<span class=\"token punctuation\">.</span><span class=\"token function\">keySet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">updateAccounts</span><span class=\"token punctuation\">(</span>relatedContactsForUpdateCountField<span class=\"token punctuation\">,</span> tasksByContact<span class=\"token punctuation\">,</span> isIncrement<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">updateContacts</span><span class=\"token punctuation\">(</span>relatedContactsForUpdateCountField<span class=\"token punctuation\">,</span> tasksByContact<span class=\"token punctuation\">,</span> isIncrement<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n <span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>Which invokes 2 method which actually perform DML</p>\n<div class=\"remark-highlight\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">updateAccounts</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&#x3C;</span><span class=\"token class-name\">Contact</span><span class=\"token punctuation\">></span></span> relatedContactsForUpdateCountField<span class=\"token punctuation\">,</span>\n                                   <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&#x3C;</span><span class=\"token class-name\">Id</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">List</span><span class=\"token punctuation\">&#x3C;</span>sObject<span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> tasksByContact<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Boolean</span> isIncrement<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ContactId, Account</span>\n    <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&#x3C;</span><span class=\"token class-name\">Id</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">Id</span><span class=\"token punctuation\">></span></span> contactIdByAccountId <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&#x3C;</span><span class=\"token class-name\">Id</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">Id</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Contact</span> cont<span class=\"token operator\">:</span> relatedContactsForUpdateCountField<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        contactIdByAccountId<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>cont<span class=\"token punctuation\">.</span><span class=\"token class-name\">AccountId</span><span class=\"token punctuation\">,</span> cont<span class=\"token punctuation\">.</span><span class=\"token class-name\">Id</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&#x3C;</span><span class=\"token class-name\">Account</span><span class=\"token punctuation\">></span></span> accountsRelatedToContactsForUpdate <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n        SELECT <span class=\"token class-name\">Id</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Reference_Count__c</span>\n        FROM <span class=\"token class-name\">Account</span>\n        WHERE <span class=\"token class-name\">Id</span> IN<span class=\"token operator\">:</span> contactIdByAccountId<span class=\"token punctuation\">.</span><span class=\"token function\">keySet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Account</span> acc<span class=\"token operator\">:</span> accountsRelatedToContactsForUpdate<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>acc<span class=\"token punctuation\">.</span><span class=\"token class-name\">Reference_Count__c</span> <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isIncrement<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                acc<span class=\"token punctuation\">.</span><span class=\"token class-name\">Reference_Count__c</span> <span class=\"token operator\">+=</span> tasksByContact<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>contactIdByAccountId<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>acc<span class=\"token punctuation\">.</span><span class=\"token class-name\">Id</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                acc<span class=\"token punctuation\">.</span><span class=\"token class-name\">Reference_Count__c</span> <span class=\"token operator\">-=</span> tasksByContact<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>contactIdByAccountId<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>acc<span class=\"token punctuation\">.</span><span class=\"token class-name\">Id</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            acc<span class=\"token punctuation\">.</span><span class=\"token class-name\">Reference_Count__c</span> <span class=\"token operator\">=</span> tasksByContact<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>contactIdByAccountId<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>acc<span class=\"token punctuation\">.</span><span class=\"token class-name\">Id</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    update accountsRelatedToContactsForUpdate<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">updateContacts</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&#x3C;</span><span class=\"token class-name\">Contact</span><span class=\"token punctuation\">></span></span> relatedContactsForUpdateCountField<span class=\"token punctuation\">,</span>\n                                    <span class=\"token class-name\">Map</span><span class=\"token operator\">&#x3C;</span><span class=\"token class-name\">Id</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&#x3C;</span>sObject<span class=\"token punctuation\">></span></span> tasksByContact<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Boolean</span> isIncrement<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Contact</span> cont<span class=\"token operator\">:</span> relatedContactsForUpdateCountField<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Integer</span> amountOfNewTasks <span class=\"token operator\">=</span> tasksByContact<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>cont<span class=\"token punctuation\">.</span><span class=\"token class-name\">Id</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>amountOfNewTasks <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cont<span class=\"token punctuation\">.</span><span class=\"token class-name\">Reference_Count__c</span> <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isIncrement<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    cont<span class=\"token punctuation\">.</span><span class=\"token class-name\">Reference_Count__c</span> <span class=\"token operator\">+=</span> amountOfNewTasks<span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                    cont<span class=\"token punctuation\">.</span><span class=\"token class-name\">Reference_Count__c</span> <span class=\"token operator\">-=</span> amountOfNewTasks<span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                cont<span class=\"token punctuation\">.</span><span class=\"token class-name\">Reference_Count__c</span> <span class=\"token operator\">=</span> amountOfNewTasks<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    update relatedContactsForUpdateCountField<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>Also we need this utility method for transformation list into map</p>\n<div class=\"remark-highlight\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">Map</span><span class=\"token operator\">&#x3C;</span><span class=\"token class-name\">Id</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&#x3C;</span>sObject<span class=\"token punctuation\">></span></span> <span class=\"token function\">splitListBySpecialKey</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&#x3C;</span>sObject<span class=\"token punctuation\">></span></span> sourceList<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> key<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sourceList <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IncorrectParameterException</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ERROR: splitListBySpecialKey(sourceList, key) got incorrect first parameter.'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">isBlank</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IncorrectParameterException</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ERROR: splitListBySpecialKey(sourceList, key) got incorrect second parameter.'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token class-name\">Map</span><span class=\"token operator\">&#x3C;</span><span class=\"token class-name\">Id</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&#x3C;</span>sObject<span class=\"token punctuation\">></span></span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map</span><span class=\"token operator\">&#x3C;</span><span class=\"token class-name\">Id</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&#x3C;</span>sObject<span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&#x3C;</span>sObject<span class=\"token punctuation\">></span></span> tmpObjs<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>sObject obj <span class=\"token operator\">:</span> sourceList<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        tmpObjs <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&#x3C;</span>sObject<span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&#x26;&#x26;</span> result<span class=\"token punctuation\">.</span><span class=\"token function\">containsKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Id</span><span class=\"token punctuation\">)</span>obj<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            tmpObjs <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Id</span><span class=\"token punctuation\">)</span>obj<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            tmpObjs<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            result<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Id</span><span class=\"token punctuation\">)</span>obj<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> tmpObjs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            tmpObjs<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            result<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Id</span><span class=\"token punctuation\">)</span>obj<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> tmpObjs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span>\n <span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">IncorrectParameterException</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n</code></pre></div>\n","title":"Calculate amount of specified task records which are related to Contact and Account in Salesforce","date":"2015-07-15T15:07:51+01:00","status":"publish","permalink":"/?p=501","author":"pavel","excerpt":"","type":"post","category":["apex","force.com","salesforce.com"],"tag":[],"post_format":[],"cleanretina_sidebarlayout":["default"],"dsq_thread_id":["5605961530"]}},"__N_SSG":true}