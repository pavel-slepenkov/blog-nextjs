{"pageProps":{"postData":{"id":"dealing-with-test_c_locale_coercion","contentHtml":"<p>Building python from source and playing around its internals is a good way to get your python's skill to the next level.\nAnd <a href=\"https://devguide.python.org\">Official Python Developer Guide</a> gets a great reference for a start. All you need is to make a copy of cpython repo, clone it to a local machine, configure and make. Here you go, your own custom built copy of python is here and you can use it just now.</p>\n<p><img src=\"/images/p1071/1.png\" alt=\"\"></p>\n<p>After a successful build you need to run test suites against your setup</p>\n<div class=\"remark-highlight\"><pre class=\"language-bash\"><code class=\"language-bash\">./python <span class=\"token parameter variable\">-m</span> <span class=\"token builtin class-name\">test</span> <span class=\"token parameter variable\">-j3</span>\n</code></pre></div>\n<p>It can take a solid amount of time but at the end you will got some result. My case was a multiple errors in test_c_locale_coercion</p>\n<div class=\"remark-highlight\"><pre class=\"language-bash\"><code class=\"language-bash\">$ ./python.exe <span class=\"token parameter variable\">-m</span> unittest <span class=\"token parameter variable\">-v</span> test.test_c_locale_coercion.LocaleCoercionTests.test_PYTHONCOERCECLOCALE_set_to_warn\nAVAILABLE_TARGETS <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'UTF-8'</span><span class=\"token punctuation\">]</span>\nEXPECTED_C_LOCALE_EQUIVALENTS <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'C'</span>, <span class=\"token string\">'invalid.ascii'</span><span class=\"token punctuation\">]</span>\nEXPECTED_C_LOCALE_STREAM_ENCODING <span class=\"token operator\">=</span> <span class=\"token string\">'ascii'</span>\nEXPECTED_C_LOCALE_FS_ENCODING <span class=\"token operator\">=</span> <span class=\"token string\">'utf-8'</span>\nEXPECT_COERCION_IN_DEFAULT_LOCALE <span class=\"token operator\">=</span> True\n_C_UTF8_LOCALES <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'C.UTF-8'</span>, <span class=\"token string\">'C.utf8'</span>, <span class=\"token string\">'UTF-8'</span><span class=\"token punctuation\">)</span>\n_check_nl_langinfo_CODESET <span class=\"token operator\">=</span> False\ntest_PYTHONCOERCECLOCALE_set_to_warn <span class=\"token punctuation\">(</span>test.test_c_locale_coercion.LocaleCoercionTests<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">..</span>.\n<span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span>\nFAIL: test_PYTHONCOERCECLOCALE_set_to_warn <span class=\"token punctuation\">(</span>test.test_c_locale_coercion.LocaleCoercionTests<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>default_locale<span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">PYTHONCOERCECLOCALE</span><span class=\"token operator\">=</span><span class=\"token string\">'warn'</span><span class=\"token punctuation\">)</span>\n----------------------------------------------------------------------\nTraceback <span class=\"token punctuation\">(</span>most recent call last<span class=\"token punctuation\">)</span>:\n  File <span class=\"token string\">\"/Users/slepenkov/projects/cpython/Lib/test/test_c_locale_coercion.py\"</span>, line <span class=\"token number\">340</span>, <span class=\"token keyword\">in</span> _check_c_locale_coercion\n    self._check_child_encoding_details<span class=\"token punctuation\">(</span>base_var_dict,\n  File <span class=\"token string\">\"/Users/slepenkov/projects/cpython/Lib/test/test_c_locale_coercion.py\"</span>, line <span class=\"token number\">230</span>, <span class=\"token keyword\">in</span> _check_child_encoding_details\n    self.assertEqual<span class=\"token punctuation\">(</span>encoding_details, expected_details<span class=\"token punctuation\">)</span>\nAssertionError: <span class=\"token punctuation\">{</span><span class=\"token string\">'fse[36 chars]f-8:strict'</span>, <span class=\"token string\">'stdout_info'</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">'utf-8:strict'</span>, <span class=\"token string\">'s[80 chars]: '</span>'<span class=\"token punctuation\">}</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">{</span><span class=\"token string\">'fse[36 chars]f-8:surrogateescape'</span>, <span class=\"token string\">'stdout_info'</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">'utf-8:su[98 chars]: '</span>'<span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">{</span><span class=\"token string\">'fsencoding'</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">'utf-8'</span>,\n   <span class=\"token string\">'lang'</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">''</span>,\n   <span class=\"token string\">'lc_all'</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">''</span>,\n   <span class=\"token string\">'lc_ctype'</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">'UTF-8'</span>,\n   <span class=\"token string\">'stderr_info'</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">'utf-8:backslashreplace'</span>,\n-  <span class=\"token string\">'stdin_info'</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">'utf-8:strict'</span>,\n?                         ^^ ^\n\n+  <span class=\"token string\">'stdin_info'</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">'utf-8:surrogateescape'</span>,\n?                        ++++++ ^^^ ^^^\n\n-  <span class=\"token string\">'stdout_info'</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">'utf-8:strict'</span><span class=\"token punctuation\">}</span>\n?                          ^^ ^\n\n+  <span class=\"token string\">'stdout_info'</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">'utf-8:surrogateescape'</span><span class=\"token punctuation\">}</span>\n?                         ++++++ ^^^ ^^^\n</code></pre></div>\n<p>My first attempt to resolve my issue was googling. Soo smart.. :)</p>\n<p>But because the topic is pretty specific and noone is discussing this on stackoverflow you will end up with a real pain because all you have to deal with now is a bunch of converstations between core developers in python bugtracker.\nSomething like <a href=\"https://bugs.python.org/issue41700\">this</a>, <a href=\"https://bugs.python.org/issue32002\">this</a> and <a href=\"https://bugs.python.org/issue30672\">this</a>. Here's a bunch of text to read and debug messages to understand.</p>\n<p>After a quick look to all these converstation it was clear that something is wrong with my setup. I've checked my locale's setting</p>\n<div class=\"remark-highlight\"><pre class=\"language-bash\"><code class=\"language-bash\">$ locale\n<span class=\"token assign-left variable\"><span class=\"token environment constant\">LANG</span></span><span class=\"token operator\">=</span><span class=\"token string\">\"en_US.UTF-8\"</span>\n<span class=\"token assign-left variable\">LC_COLLATE</span><span class=\"token operator\">=</span><span class=\"token string\">\"en_US.UTF-8\"</span>\n<span class=\"token assign-left variable\">LC_CTYPE</span><span class=\"token operator\">=</span><span class=\"token string\">\"en_US.UTF-8\"</span>\n<span class=\"token assign-left variable\">LC_MESSAGES</span><span class=\"token operator\">=</span><span class=\"token string\">\"en_US.UTF-8\"</span>\n<span class=\"token assign-left variable\"><span class=\"token environment constant\">LC_MONETARY</span></span><span class=\"token operator\">=</span><span class=\"token string\">\"en_US.UTF-8\"</span>\n<span class=\"token assign-left variable\"><span class=\"token environment constant\">LC_NUMERIC</span></span><span class=\"token operator\">=</span><span class=\"token string\">\"en_US.UTF-8\"</span>\n<span class=\"token assign-left variable\"><span class=\"token environment constant\">LC_TIME</span></span><span class=\"token operator\">=</span><span class=\"token string\">\"en_US.UTF-8\"</span>\n</code></pre></div>\n<p>Playing with setting locale to <code>C.UTF-8</code> or <code>POSIX</code> changed nothing.</p>\n<p>My next step was to quick run of docker container with alpine and <a href=\"https://devguide.python.org/setup/#build-dependencies\">all required build dependencies</a> but it ended up with much more longer list of errors on test run, thus the container was terminated and I returned to local setup.</p>\n<p>Next step was digging around all dot files in my home directory. If you have pretty old machine like mine (first setup on Nov 2016) and making changes to your configs often you end ups with long list of configurational files in you working directory. With bunch of changes over a time. Motivation of which you can't even remember.</p>\n<p>Checking <code>.bashrc</code>, <code>.bash_profile</code> did not yield any results. But checking <code>.exports</code> which I installed from <a href=\"https://github.com/mathiasbynens/dotfiles/blob/main/.exports\">dotfiles</a> a few years ago was the solution. <strong>I have found that apart from exporting LANG and LC_ALL this file also exports <code>PYTHONIOENCODING</code>.</strong> I have no idea how I hadn't noticed this environment variables was globally set. Removing this <code>export PYTHONIOENCODING='UTF-8';</code> from global export fixed the issue.</p>\n<div class=\"remark-highlight\"><pre class=\"language-bash\"><code class=\"language-bash\">$  ./python.exe <span class=\"token parameter variable\">-m</span> <span class=\"token builtin class-name\">test</span> <span class=\"token parameter variable\">-v</span> test_c_locale_coercion\n<span class=\"token operator\">==</span> CPython <span class=\"token number\">3.10</span>.0a6+ <span class=\"token punctuation\">(</span>heads/master:87ec26b812, Mar <span class=\"token number\">7</span> <span class=\"token number\">2021</span>, 09:09:41<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>Clang <span class=\"token number\">11.0</span>.0 <span class=\"token punctuation\">(</span>clang-1100.0.33.8<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n<span class=\"token operator\">==</span> macOS-10.15.7-x86_64-i386-64bit little-endian\n<span class=\"token operator\">==</span> cwd: /Users/slepenkov/projects/cpython/build/test_python_56412æ\n<span class=\"token operator\">==</span> CPU count: <span class=\"token number\">4</span>\n<span class=\"token operator\">==</span> encodings: <span class=\"token assign-left variable\">locale</span><span class=\"token operator\">=</span>UTF-8, <span class=\"token assign-left variable\">FS</span><span class=\"token operator\">=</span>utf-8\n<span class=\"token number\">0</span>:00:00 load avg: <span class=\"token number\">2.17</span> Run tests sequentially\n<span class=\"token number\">0</span>:00:00 load avg: <span class=\"token number\">2.17</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span>/1<span class=\"token punctuation\">]</span> test_c_locale_coercion\nAVAILABLE_TARGETS <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'UTF-8'</span><span class=\"token punctuation\">]</span>\nEXPECTED_C_LOCALE_EQUIVALENTS <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'C'</span>, <span class=\"token string\">'invalid.ascii'</span><span class=\"token punctuation\">]</span>\nEXPECTED_C_LOCALE_STREAM_ENCODING <span class=\"token operator\">=</span> <span class=\"token string\">'ascii'</span>\nEXPECTED_C_LOCALE_FS_ENCODING <span class=\"token operator\">=</span> <span class=\"token string\">'utf-8'</span>\nEXPECT_COERCION_IN_DEFAULT_LOCALE <span class=\"token operator\">=</span> True\n_C_UTF8_LOCALES <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'C.UTF-8'</span>, <span class=\"token string\">'C.utf8'</span>, <span class=\"token string\">'UTF-8'</span><span class=\"token punctuation\">)</span>\n_check_nl_langinfo_CODESET <span class=\"token operator\">=</span> False\ntest_external_target_locale_configuration <span class=\"token punctuation\">(</span>test.test_c_locale_coercion.LocaleConfigurationTests<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">..</span>. ok\ntest_LC_ALL_set_to_C <span class=\"token punctuation\">(</span>test.test_c_locale_coercion.LocaleCoercionTests<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">..</span>. ok\ntest_PYTHONCOERCECLOCALE_not_set <span class=\"token punctuation\">(</span>test.test_c_locale_coercion.LocaleCoercionTests<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">..</span>. ok\ntest_PYTHONCOERCECLOCALE_not_zero <span class=\"token punctuation\">(</span>test.test_c_locale_coercion.LocaleCoercionTests<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">..</span>. ok\ntest_PYTHONCOERCECLOCALE_set_to_one <span class=\"token punctuation\">(</span>test.test_c_locale_coercion.LocaleCoercionTests<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">..</span>. skipped <span class=\"token string\">'coerced LC_CTYPE locale: UTF-8'</span>\ntest_PYTHONCOERCECLOCALE_set_to_warn <span class=\"token punctuation\">(</span>test.test_c_locale_coercion.LocaleCoercionTests<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">..</span>. ok\ntest_PYTHONCOERCECLOCALE_set_to_zero <span class=\"token punctuation\">(</span>test.test_c_locale_coercion.LocaleCoercionTests<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">..</span>. ok\n\n----------------------------------------------------------------------\n\nRan <span class=\"token number\">7</span> tests <span class=\"token keyword\">in</span> <span class=\"token number\">3</span>.872s\n\nOK <span class=\"token punctuation\">(</span>skipped<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token operator\">==</span> Tests result: SUCCESS <span class=\"token operator\">==</span>\n\n<span class=\"token number\">1</span> <span class=\"token builtin class-name\">test</span> OK.\n\nTotal duration: <span class=\"token number\">4.2</span> sec\nTests result: SUCCESS\n</code></pre></div>\n<p>So, the most signinficant conclusion is <strong>Keep your working setup clean and make export only when you really need it</strong>. Usually I have PYTHONIOENCODING set on project level when it needed and it's done dynamically set via scripts and disappear just after virtual environment is deactivated.</p>\n","title":"Dealing with test_c_locale_coercion on macOS","date":"2021-03-09T07:55:20+00:00","status":"publish","permalink":"/?p=1071","author":"pavel","excerpt":"","type":"post","tag":["python","cpython","macOS"]}},"__N_SSG":true}