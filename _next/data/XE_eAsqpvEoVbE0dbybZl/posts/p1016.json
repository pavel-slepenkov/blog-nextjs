{"pageProps":{"postData":{"id":"p1016","contentHtml":"<p>Working on integration Salesforce with external system and vice versa through both REST and SOAP APIs you might get the following exception</p>\n<div class=\"remark-highlight\"><pre class=\"language-java\"><code class=\"language-java\">sun<span class=\"token punctuation\">.</span>security<span class=\"token punctuation\">.</span>validator<span class=\"token punctuation\">.</span><span class=\"token class-name\">ValidatorException</span><span class=\"token operator\">:</span>\nPKIX path building failed<span class=\"token operator\">:</span>\nsun<span class=\"token punctuation\">.</span>security<span class=\"token punctuation\">.</span>provider<span class=\"token punctuation\">.</span>certpath<span class=\"token punctuation\">.</span><span class=\"token class-name\">SunCertPathBuilderException</span><span class=\"token operator\">:</span>\nunable <span class=\"token keyword\">to</span> <span class=\"token namespace\">find</span> valid certification path <span class=\"token keyword\">to</span> <span class=\"token namespace\">requested</span> target\n</code></pre></div>\n<p><strong>1. Salesforce to external system integration errors</strong></p>\n<p>The first thing to check is certificate on external system side. Most likely the problem is on this side.</p>\n<p>1.1 The problem with certificate itself. Any issue with certificate on 3rd party side will cause the error. You can check this <a href=\"https://badssl.com/\">site</a> for more details and examples on certificates issues.</p>\n<p><img src=\"/images/p1016/insecure-connection.png\" alt=\"insecure connection\"></p>\n<p><strong>Here’re a few possible reason why certificate is not trusted:</strong></p>\n<ol>\n<li>certificate is expired</li>\n<li>certificate is for a wrong host</li>\n<li>certificate is self-signed</li>\n<li>certificate with untrusted root</li>\n<li>certificate is revoked</li>\n<li>certificate is invalid by <a href=\"https://en.wikipedia.org/wiki/HTTP_Public_Key_Pinning\">key pinning</a></li>\n</ol>\n<p>The only possible solution for these cases is to install correct certificate on a server.</p>\n<p>1.2 When certificate on a server is <strong>valid</strong> and you can access the host by <strong>browser</strong> with no error it might be a sign of a broken certificate <a href=\"https://en.wikipedia.org/wiki/Chain_of_trust\">chain of trust</a>.</p>\n<blockquote>\n<p>Salesforce’s certificate trust policy is to require server and client certificate chains to include all intermediate certificates that exist between the server or client certificate and the chain’s root certificate</p>\n</blockquote>\n<p>You can review salesforce trusted certificates via https://YOUR-INSTANCE.salesforce.com/cacerts.jsp (<a href=\"https://slepenkov-dev-ed.my.salesforce.com/cacerts.jsp\">https://slepenkov-dev-ed.my.salesforce.com/cacerts.jsp)</a></p>\n<p>Most probably the server has no intermediate, root CA or several certificates installed/added and thus these certificates are not added to the server response during handshake.</p>\n<p>On server you need to have all certificates in the chain. Different servers has different configuration and different locations for a certificates but in any case server must provide a whole chain to a client in order to be trusted. Structured in the following way</p>\n<p><img src=\"/images/p1016/cert-chain-structure.png\" alt=\"cert-chain-structure\"></p>\n<p>You can verify this case with the following command:</p>\n<div class=\"remark-highlight\"><pre class=\"language-bash\"><code class=\"language-bash\">openssl s_client -connect techcrunch.com:443\n</code></pre></div>\n<p>Valid result will be as follow:</p>\n<p><img src=\"/images/p1016/image-3.png\" alt=\"\"></p>\n<p>When chain is broken the same command will produce the following result:</p>\n<p><img src=\"/images/p1016/image-4.png\" alt=\"\"></p>\n<p>with final error messages</p>\n<p><code>Verify return code: 21 (unable to verify the first certificate)</code></p>\n<p>or</p>\n<p><code>verify return code: 20 (unable to get local issuer certificate)</code></p>\n<p>All you need to fix that is to add root CA certificate and/or intermediate certificates if needed in order to send server response with entire certificates chain during the handshake.</p>\n<p><strong>2. External System to Salesforce</strong></p>\n<p>When connecting to Salesforce from external application you might get the same error. This time error means that you server have no some salesforce chain of trust certificates. You can add it one by one or as a certificate bundle to your server.</p>\n<p>Just download certificates chain with this command</p>\n<p><code>openssl s_client -showcerts -connect slepenkov-dev-ed.my.salesforce.com:443</code></p>\n<p>The output will contain all certificates in chain and you can copy and add it to your server certificate store.</p>\n<p><img src=\"/images/p1016/image-5.png\" alt=\"\"></p>\n","title":"sun.security.validator.ValidatorException: PKIX path building failed in Salesforce","date":"2019-04-09T10:54:13+01:00","status":"publish","permalink":"/?p=1016","author":"pavel","excerpt":"","type":"post","category":["salesforce.com","security","web-services"],"tag":["salesforce","salesforce errors","security","ssl","web-services"],"post_format":[]}},"__N_SSG":true}